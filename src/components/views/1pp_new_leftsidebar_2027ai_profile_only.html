<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>CafeCorner - Dr. Reed's Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Added Merriweather and Inter for profile timeline -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7"></script>
  <style>
    /* ============ 1. ORIGINAL DESIGN TOKENS & GLOBAL STYLES UNCHANGED ============ */
    :root{
      /* palette */
      --cc-bg-cappuccino: #fdf7f3; /* main background */
      --cc-bg-card:       #ffffff; /* cards / shelves */
      --cc-brown-700:     #6b4f4f; /* headers, icons, card stripe */
      --cc-brown-500:     #b36b00; /* buttons / accents */
      --cc-brown-300:     #e6ccb2; /* borders / dividers */
      --cc-cream-100:     #ffe8d6; /* tag / badge bg */
      --cc-latte-foam:    #ded7d0; /* ‚Äúdisabled‚Äù state */
      --cc-espresso:      #37352f; /* text dark */

      /* derived tokens */
      --cc-bg:            var(--cc-bg-cappuccino);
      --cc-card:          var(--cc-bg-card);
      --cc-primary:       var(--cc-brown-500);
      --cc-primary-dark:  #8a5a00; /* for button hover */
      --cc-text-header:   var(--cc-brown-700);
      --cc-text:          var(--cc-espresso);
      --cc-pill-bg:       var(--cc-cream-100);
      --cc-pill-border:   var(--cc-brown-300);
      --cc-pill-text:     var(--cc-brown-700);

      /* primitives */
      --cc-radius:        14px;
      --cc-shadow-1:      0 1px 4px rgb(0 0 0 / .07);
      --cc-shadow-2:      0 4px 14px rgb(0 0 0 / .12);
      --cc-tr:            .18s cubic-bezier(.4,.2,.2,1); /* transition */
      
      /* typography specifics from first guide */
      --cc-pill-fs:       .8em;
      --cc-h3-fs:         1.05rem;
    }

    /* ---- Global & Typography ---- */
    body {
      background: var(--cc-bg); color: var(--cc-text);
      font-family: 'Nunito', sans-serif; margin:0; padding:0;
    }
    h1{font-size:1.6rem;margin:.3rem 0; color: #fff;}
    h2{font-size:1.3rem; color: var(--cc-text-header); display: flex; align-items: center; justify-content: space-between;}
    h3{font-size:var(--cc-h3-fs); margin:.2rem 0; color: var(--cc-text-header);}
    h4 { color: var(--cc-text-header); margin:.2rem 0;}
    p { margin:.25rem 0;font-size:.92em;line-height:1.45;}

    /* ---- Header & Nav ---- */
    header{
      background:var(--cc-brown-700);color:#fff;text-align:center;
      padding:1rem 0;position:relative;
      box-shadow:inset 0 -4px 10px rgba(0,0,0,.15);
    }
    header::after{
      content:"";position:absolute;inset:auto 0 -6px 0;height:6px;
      background:#b07b56;border-bottom-left-radius:10px;border-bottom-right-radius:10px;
    }
    .nav-container {
      position:sticky; top:0; z-index:900; 
      box-shadow:0 2px 6px rgba(0,0,0,.06); background:var(--cc-bg-card); 
      padding:0.5rem 1rem; display: flex; justify-content: space-between; align-items: center;
      left: 280px; 
      width: calc(100% - 280px); 
      box-sizing: border-box;
    }
    nav{ display:flex; justify-content:center; gap:1rem; flex-grow: 1; align-items: center; }
    nav a{
      text-decoration:none; color:var(--cc-brown-700); font-weight:bold;
      padding:.4rem .9rem;border-radius:999px; transition: background var(--cc-tr);
      position: relative; /* Added for badge positioning */
    }
    nav a.active, nav a:hover{ background:var(--cc-pill-bg); color: var(--cc-primary); }
    #reset-view-btn { padding: .4rem .9rem; font-size: 0.8em; margin-left: 1rem; margin-top:0; background: var(--cc-brown-300); color: var(--cc-brown-700);}
    #ping-unread-badge {
        background: red; color: white;
        border-radius: 50%;
        padding: 0.1em 0.4em;
        font-size: 0.7em;
        position: absolute;
        top: 0px; /* Adjusted for better alignment with new tab structure */
        right: 0px; /* Adjusted for better alignment */
        line-height: 1;
        min-width: 10px; text-align: center;
        transform: translate(50%, -50%); /* Nudge for better corner placement */
    }

    /* ---- Main Content Area ---- */
    #main {
        margin-left: 280px; 
        box-sizing: border-box;
    }
    #main > section { 
        padding:2rem; border-bottom:1px solid var(--cc-brown-300); 
        display: none; box-sizing: border-box;
    }
    #main > section:last-child { border-bottom: none; }
    /* Generic quick search style, will be used by multiple sections */
    .quick-search { 
        margin-left:1rem;padding:.3rem .5rem;font-size:0.8em;width:220px;
        border:1px solid var(--cc-brown-300);border-radius:var(--cc-radius); font-family: 'Nunito',sans-serif;
    }
    /* Ensure sections like items can use flex if needed by their content */
    #items { display: none; /* initially hidden, showTab will manage */ }
    #jobs { display: none; /* initially hidden */ }
    #pings { display: none; /* initially hidden */ }
    #social { display: none; /* initially hidden */ }
    #companies { display: none; /* initially hidden */ } /* NEW */
    #items-container, #my-items-container { display:flex; flex-wrap:wrap; gap:1.5rem; width:100%;}


    /* ---- Card Shell ---- */
    .card-shell{
      position:relative; background:var(--cc-card); border-radius:var(--cc-radius);
      box-shadow:var(--cc-shadow-1); transition:transform var(--cc-tr),box-shadow var(--cc-tr);
      padding:1rem; margin:0; display:flex; align-items:flex-start; box-sizing: border-box; 
    }
    .card-shell:hover{ transform:translateY(-3px); box-shadow:var(--cc-shadow-2); }
    .card-shell::before{ 
      content:""; position:absolute; inset:0 0 auto 0; height:6px;
      background:var(--cc-brown-700); border-top-left-radius:inherit; border-top-right-radius:inherit;
      opacity:.92;
    }
    /* Card width for items and profile cards in candidate deck AND SOCIAL TAB */
    .market-item-card, 
    #candidates-container .card-shell,
    #social-profile-cards-container .card-shell { /* ADDED social tab here */
        width:clamp(300px, calc(50% - 0.75rem), 400px); 
    }
    @media(max-width:720px){ 
      .market-item-card, 
      #candidates-container .card-shell,
      #social-profile-cards-container .card-shell { /* ADDED social tab here */
        width:100%;
      } 
    }
    .inquiry-card.card-shell, .event-tree > li.card-shell { width: 100%; margin-bottom:1rem;}

    /* ---- Avatar ---- */
    .avatar-80{ width:80px;height:80px;border-radius:50%;object-fit:cover;flex-shrink:0; margin-right:1rem; }
    .card-shell > label > img, .card-shell > img { 
        width:80px;height:80px;border-radius:50%;object-fit:cover;flex-shrink:0; margin-right:1rem;
    }

    /* ---- Profile Card Hover Accordion (for Candidate Deck) ---- */
    #candidates-container .profile-card.card-shell .card-content { 
        flex-grow: 1; max-height: 170px; overflow: hidden;
        opacity:.9; transition:max-height 0.4s ease-in-out, opacity .35s ease-in-out;
    }
    #candidates-container .profile-card.card-shell:hover .card-content { max-height: 1200px; opacity:1; overflow: visible; }
    .card-content p, .card-content div, .card-content ul, .card-content a, .card-content button, .card-content span, .card-content form { font-size:.92em;line-height:1.45;}
    .card-content h3, .card-content h4 { margin-top: 0.5rem;}
    .card-content .data-section { margin-top:0.5rem; margin-bottom: 0.3rem; } 
    .card-content .data-section .label { font-size: 0.85em; }
    .card-content .why-match { font-size: 0.8em; color: var(--cc-primary); margin-top: 0.3rem; padding-top: 0.3rem; border-top: 1px dotted var(--cc-brown-300); }
    .card-content .why-match strong { color: var(--cc-text-header); }

    /* ---- Pills & Badges (Role-based styling) ---- */
    .cc-pill{
      display:inline-block;font-size:var(--cc-pill-fs);font-weight:600;
      padding:.25rem .75rem;margin:.15rem .2rem .15rem 0;
      background:var(--cc-pill-bg);border:1px solid var(--cc-pill-border);
      border-radius:999px;color:var(--cc-pill-text);white-space:nowrap;
      transition:background var(--cc-tr);
    }
    .cc-pill:hover{background:#f7e1ce;} 
    .cc-pill.small { font-size: .7em; padding: .15rem .5rem; }
    
    .profile-active-role-candidate .cc-pill { background: #d4f0ff; border-color: #a9d8f0; }
    .profile-active-role-vendor .cc-pill, 
    .profile-active-role-host .cc-pill, 
    .profile-active-role-organizer .cc-pill,
    .profile-active-role-recruiter .cc-pill, 
    .profile-active-role-attendee .cc-pill 
    { background: #ffeebe; border-color: #f0dc9b; }
    
    .stage-slots-attendees .cc-pill {
      background:#e5f5ff;
      border-color:#badaff;
    }

    @keyframes pop{0%{transform:scale(.5);opacity:0;}100%{transform:scale(1);opacity:1;}}
    .mbti-badge.cc-pill{ 
        background-color: var(--cc-pill-bg); color: var(--cc-pill-text);
        border: 1px solid var(--cc-pill-border); animation:pop .25s ease-out;
    }
    .mbti-badge.cc-pill, .mbti-badge.cc-pill:hover { background:var(--cc-pill-bg); border-color: var(--cc-pill-border); color:var(--cc-pill-text); }
    .mbti-badge.cc-pill:hover {background:#f7e1ce;} 

    /* ---- Interactive Tag Popout Styling (Highlight Tags & DEEP_DIVE_INFO_JS tags) ---- */
    .cc-pill.tag-interactive { position: relative; cursor: pointer; } /* Changed cursor to pointer */
    .profile-active-role-candidate .cc-pill.tag-interactive:hover { background-color: #c0e8ff; border-color: #7ec5eb; }
    .profile-active-role-vendor .cc-pill.tag-interactive:hover, 
    .profile-active-role-host .cc-pill.tag-interactive:hover, 
    .profile-active-role-organizer .cc-pill.tag-interactive:hover,
    .profile-active-role-recruiter .cc-pill.tag-interactive:hover, 
    .profile-active-role-attendee .cc-pill.tag-interactive:hover 
    { background-color: #fce6a4; border-color: #e6c673; }
    .cc-pill.tag-interactive:not([class*="profile-active-role-"]):hover { background-color: #f5d8c4; border-color: var(--cc-brown-500); }

    .detail-popout { 
        position: absolute; bottom: calc(100% + 10px); left: 50%;
        transform: translateX(-50%) translateY(10px) scale(0.95); transform-origin: bottom center;
        width: 280px; max-width: 90vw; padding: 0.85rem;
        background: var(--cc-card); border: 1px solid var(--cc-pill-border); 
        border-radius: var(--cc-radius); box-shadow: var(--cc-shadow-2); 
        opacity: 0; visibility: hidden; pointer-events: none; /* Popout itself is not interactive */
        transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
        z-index: 1000; font-size: 0.85em; line-height: 1.4;
        color: var(--cc-text); text-align: left; white-space: normal; 
    }
    .cc-pill.tag-interactive:hover .detail-popout,
    .cc-pill.tag-interactive:focus .detail-popout, /* Using :focus for tabindex */
    .cc-pill.tag-interactive:focus-within .detail-popout { /* For inner tag focus */
        opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0) scale(1); 
    }
    .detail-popout strong { color: var(--cc-text-header); display: block; margin-bottom: 0.3rem; font-weight: bold; font-size: 1em; }
    .detail-popout .context-snippet { font-style: italic; color: var(--cc-text); opacity: 0.85; margin-bottom: 0.5rem; display: block; font-size: 0.9em; }
    .detail-popout .related-tags { margin-top: 0.6rem; padding-top: 0.4rem; border-top: 1px dotted var(--cc-brown-300); }
    .detail-popout .inner-tag { 
        position: relative; display: inline-block; background: var(--cc-pill-bg);
        color: var(--cc-pill-text); border: 1px solid var(--cc-pill-border);
        padding: .2rem .6rem; border-radius: 999px; margin-right: 0.4rem; margin-bottom: 0.4rem;
        cursor: pointer; pointer-events: auto; /* Inner tags are interactive */
        transition: background-color var(--cc-tr), border-color var(--cc-tr);
        font-size: 0.9em; white-space: nowrap;
    }
    .detail-popout .inner-tag:hover { background-color: #f7e1ce; border-color: var(--cc-primary); }
    
    .deep-detail-popout { 
        position: absolute; bottom: calc(100% + 8px); left: 50%;
        transform: translateX(-50%) translateY(8px) scale(0.9); transform-origin: bottom center;
        width: 220px; max-width: 80vw; padding: 0.6rem; background: var(--cc-bg-card); 
        border: 1px solid var(--cc-brown-300); border-radius: var(--cc-radius);
        box-shadow: var(--cc-shadow-1); opacity: 0; visibility: hidden; pointer-events: none; /* Deep popout itself non-interactive */
        font-size: 0.95em; line-height: 1.3; color: var(--cc-text);
        transition: opacity 0.15s ease, visibility 0.15s ease, transform 0.15s ease;
        z-index: 1100; text-align: left; white-space: normal;
    }
    .deep-detail-popout p { margin:0; font-size: inherit; }
    .detail-popout .inner-tag:hover .deep-detail-popout,
    .detail-popout .inner-tag:focus .deep-detail-popout, /* Using :focus for tabindex */
    .detail-popout .inner-tag:focus-within .deep-detail-popout {
        opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0) scale(1);
    }
    .deep-detail-popout a { 
        display: inline-block; margin-top: .3rem; color: var(--cc-primary); font-weight: bold;
        pointer-events: auto; /* Links inside deep popout are interactive */
    }
    
    .clickable-filter-tag{cursor:pointer;}
    .clickable-filter-tag:hover{background:#f7e1ce;}

    .flash-outline {
      outline: 3px solid var(--cc-primary) !important;
      outline-offset: 2px; /* Ensure outline is visible around padding/borders */
      transition: outline-color 0.2s ease-out, outline-offset 0.2s ease-out;
    }

    /* ---- Buttons ---- */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:.4rem;cursor:pointer;font-weight:700;font-size:.88em; 
      background:var(--cc-primary);color:#fff;border:none;
      border-radius:999px;padding:.5rem 1.3rem; 
      transition:background var(--cc-tr),transform var(--cc-tr);
      box-shadow:0 2px 4px rgb(0 0 0 /.1);
      letter-spacing:.2px; margin-top: 0.5rem; 
    }
    .btn i{font-size:1.1em; stroke-width: 2.5px;} 
    .btn:hover{background:var(--cc-primary-dark);transform:translateY(-1px);}
    .btn:disabled{background:var(--cc-latte-foam);cursor:not-allowed;transform:none; color: var(--cc-brown-700);}
    .join-btn, .apply-btn { font-size: 0.8em; padding: 0.3rem 0.8rem; margin-top: 0.8rem; } 

    .endorse-btn { 
        background: transparent; border: 1px solid var(--cc-brown-300); color: var(--cc-brown-500);
        padding: 0.2rem 0.5rem; font-size: 0.9em; margin-left: 0.3rem;
        border-radius: 6px;
    }
    .endorse-btn:hover { background: var(--cc-pill-bg); }
    .endorse-btn.active { background: var(--cc-primary); color: white; border-color: var(--cc-primary); }
    
    .ping-btn {
        background-color: var(--cc-pill-bg); color: var(--cc-brown-700); border: 1px solid var(--cc-brown-300);
        cursor: pointer; border-radius: 4px;
    }
    .ping-btn:hover { background-color: #f0e0d0; }
    .ping-btn.btn-ghost { background: transparent; border: none; color: var(--cc-primary); }
    .ping-btn.ping-event-btn {
        font-size: 0.8em; padding: 0.3rem 0.8rem; margin-top:0.5rem; display: block;
        width: fit-content;
    }

    /* ---- Event tree & Stage Slots ---- */
    .event-tree { list-style:none; padding-left:0; font-size:0.95em; }
    .event-tree ul { padding-left:1.5rem; margin-top: 0.5rem; } 
    .event-tree details ul { margin-top: 0.2rem; } 
    .event-tree > li.card-shell { margin-bottom:1.5rem; padding-top: 1.5rem; cursor: pointer; } /* Added cursor pointer to event card */
    .event-tree > li.card-shell:hover { transform:translateY(-3px); box-shadow:var(--cc-shadow-2); } /* Ensure hover works */

    .event-node.card-base { 
        padding: 0.2rem 0.4rem; margin:0.1rem 0; display: inline-block; 
        box-shadow: none; background: transparent; border-radius: 4px;
        color: var(--cc-primary); text-decoration: underline;
    }
    .event-node.card-base:hover { background-color: var(--cc-pill-bg); transform: none; }
    .stage-slots-list { list-style: none; padding-left: 0.5rem; font-size: 0.9em; }
    .stage-slots-list li { margin-bottom: 0.2rem; display: flex; align-items: center; } 
    .stage-slots-list li a { color: var(--cc-primary); text-decoration: none; margin-right: 5px;}
    .stage-slots-list li a:hover { text-decoration: underline; }
    
    .event-tree .involvement-tree summary { 
        cursor: pointer; font-weight: 600; color: var(--cc-text-header);
        padding: 0.2rem 0.4rem; margin-bottom: 0.3rem;
        border-bottom: 1px dotted var(--cc-brown-300);
    }
    .event-tree .involvement-tree ul { 
      list-style-type: none;
      padding-left: 0.5rem; 
      margin-top: 0.2rem;
    }
    .event-tree .involvement-tree ul > li {
        padding: 0.1rem 0;
        font-size: 0.92em;
    }
    .event-tree .involvement-tree ul > li strong {
        color: var(--cc-text-header);
        font-size: 0.95em;
    }
    .event-tree .involvement-tree ul > li > ul { 
        padding-left: 1rem; 
        font-size: 0.95em;
        margin-top:0.1rem;
    }
    .event-tree .involvement-tree ul > li > ul > li a {
        color: var(--cc-primary);
    }

    /* ---- Detail panels ---- */
    .detail { 
      position:fixed; top:0; left:0; right:0; bottom:0;
      z-index: 1050; 
      background:rgba(245,245,247,0.985); padding:2rem;
      overflow:auto; visibility:hidden; opacity:0;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      /* Defaulting detail panel to Inter, like React component */
      font-family: 'Inter', sans-serif; 
      color: #374151; /* text-gray-700 from React component */
    }
    .detail.show { visibility:visible; opacity:1; }
    /* Apply Merriweather to headings inside detail panels */
    .detail h1, .detail h2, .detail h3, .detail h4, .detail h5, .detail h6 {
        font-family: 'Merriweather', serif;
        color: #1A202C; /* text-gray-900 from React component */
    }
    /* Utility class for very small text, like keywords in profile timeline */
    .detail .text-xxs {
        font-size: 0.625rem; /* 10px */
        line-height: 0.75rem; /* 12px */
    }

    .back-btn { margin-bottom:1rem; }
    .detail .detail-card-content-wrapper.card-shell { padding-top: 1.5rem; }
    /* Generic image styling in detail panels */
    .detail .detail-card-content-wrapper img.avatar-80, 
    .detail .detail-card-content-wrapper img#detail-event-cover-img, 
    .detail .detail-card-content-wrapper img#item-cover, 
    .detail .detail-card-content-wrapper img#co-logo, 
    .detail .detail-card-content-wrapper .project-image 
     {
      width: 120px; height: 120px; 
      border-radius:var(--cc-radius); flex-shrink: 0; 
      margin-right: 1.5rem; object-fit: cover;
    }
    .detail .card-content { flex-grow: 1;} 
    .data-section { margin-top: 1rem; margin-bottom: 1rem; }
    .data-section .label { font-weight: bold; color: var(--cc-text-header); margin-bottom: 0.25rem; display: block; }
    .data-section ul { list-style-type: disc; margin-left: 1.5rem; padding-left: 0.5rem; }
    .data-section ul li { margin-bottom: 0.3rem; }
    .experience-item, .education-item, .project-item { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px dotted var(--cc-brown-300); }
    .experience-item:last-child, .education-item:last-child, .project-item:last-child { border-bottom: none; }
    .experience-item h4, .education-item h4, .project-item h4 { margin-bottom: 0.2rem; }
    .experience-item .company-dates, .education-item .degree-dates, .project-item .project-meta { font-size: 0.9em; color: #555; margin-bottom: 0.3rem; }
    
    /* Project Detail Card Specific Styling (from Ch 4) */
    .project-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin: 0.5rem 0;
    }
    .project-image { /* For tpl-project-detail gallery */
        width: 100%;
        height: 75px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--cc-brown-300);
    }
    .project-status.cc-pill { /* For tpl-project-detail status pill */
      margin-bottom: 0.5rem; /* Space below status */
    }
    /* Project Detail Card - existing template styling - kept for now */
    .detail-project-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.5rem;
        margin: 1rem 0;
    }
    .detail-project-gallery img {
        width: 100%;
        height: 90px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--cc-brown-300);
    }
    .detail-project-status {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      background: #10b981; /* Example: Green for active */
      color: white;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    /* Item Detail (Lightbox) Specific Styling */
    #tpl-item-detail .item-image { /* Specific to item detail template */
        width: 140px !important; 
        height: 140px !important; 
        margin-right: 1.5rem !important; 
        object-fit: cover !important; 
        border-radius: var(--cc-radius) !important; 
    }


    /* ---- Ping Modal Specific Styles ---- */
    #ping-thread-modal .card-shell { max-width: 500px; margin: 2rem auto; }
    #ping-thread-modal { z-index: 1100; } 
    #ping-messages-container {
        height: 300px; overflow-y: auto; border: 1px solid var(--cc-brown-300); 
        padding: 0.5rem; margin-bottom: 0.5rem; display: flex; flex-direction: column;
    }
    .ping-message {
        padding: 0.5rem 0.75rem; border-radius: var(--cc-radius);
        margin-bottom: 0.5rem; max-width: 75%;
        font-size: 0.9em; line-height: 1.4;
    }
    .ping-message.zero { 
        text-align: center; color: #777; padding: 1rem;
        background-color: transparent; align-self: center;
        width: 100%; max-width:100%;
    }
    .ping-message.sent {
        background-color: var(--cc-primary); color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }
    .ping-message.received {
        background-color: var(--cc-pill-bg); color: var(--cc-text);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    .ping-message .timestamp { font-size:0.75em; opacity:0.7; display:block; margin-top:0.2rem; }
    .ping-message .sender-name { font-size:0.8em; font-weight:bold; color: var(--cc-text-header); display:block; margin-bottom:0.1rem; }


    /* ---- Barista search (now Candidate Deck search in Jobs tab) ---- */
    .candidate-deck-search { display:flex; gap:0.5rem; margin-bottom:1rem; }
    .candidate-deck-search input { flex:1; padding:0.5rem; border:1px solid var(--cc-brown-300); border-radius:var(--cc-radius); font-family: 'Nunito',sans-serif;}
    
    /* ---- Inquiry Form & Create Forms ---- */
    .create-form-container.card-shell { margin-top: 1.5rem; padding: 1.5rem; background-color: var(--cc-bg-cappuccino); }
    .create-form-container summary { font-weight: bold; color: var(--cc-text-header); cursor: pointer; display: block; margin-bottom: 0.5rem;}
    .create-form-container form { display:flex; flex-direction:column; gap:0.5rem; padding-top: 0.5rem; }
    .create-form-container input, .create-form-container textarea, .create-form-container select,
    .mini-comment-form input, #send-ping-form textarea, .chat-form textarea { 
      padding:0.5rem; border:1px solid var(--cc-brown-300); border-radius:var(--cc-radius);
      font-family: inherit;
    }
    #send-ping-form textarea { width: calc(100% - 1rem); box-sizing: border-box; }
    .mini-comment-form input { font-size: 0.85em; margin-top: 0.5rem; width: calc(100% - 1rem); }
    
    /* ---- Involvement Tree Styling (Profile Panel & Event Detail Panel) ---- */
    .involvement-tree-section { 
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--cc-brown-300);
    }
    .involvement-tree-section > h4 { 
        margin-bottom: 0.5rem;
    }
    .involvement-tree-section details { 
        margin-left: 0; 
        margin-bottom: 0.3rem;
    }
    .involvement-tree-section details summary { 
        cursor: pointer;
        padding: 0.3rem 0.5rem;
        background-color: var(--cc-pill-bg);
        border: 1px solid var(--cc-pill-border);
        border-radius: 6px;
        font-weight: 600;
        color: var(--cc-text-header);
        list-style-position: inside; 
    }
    .involvement-tree-section details summary:hover {
        background-color: #f7e1ce;
    }
    .involvement-tree-section details[open] > summary {
        background-color: #f0e0d0; 
    }
    .involvement-tree-section details > ul { 
        list-style-type: none;
        padding-left: 1.5rem; 
        margin-top: 0.3rem;
        border-left: 1px dashed var(--cc-brown-300);
    }
    .involvement-tree-section details > ul > li {
        padding: 0.2rem 0;
        font-size: 0.9em;
    }
    .involvement-tree-section details > ul > li strong { /* For "Date:", "Location:", "Also at this event:" */
        color: var(--cc-text-header);
    }
    .involvement-tree-section details > ul > li > ul { /* For the list under "Also at this event:" */
        padding-left: 1rem; 
        font-size: 0.95em;
        list-style-type: none; /* Ensures no bullets for role lists */
    }
    .involvement-tree-section details > ul > li > ul > li { /* For "Host(s):", "Vendor(s):" */
         padding: 0.1rem 0;
    }
    .involvement-tree-section details > ul > li > ul > li strong { /* For "Host(s):", "Vendor(s):" text*/
        font-size: 0.95em; /* Match outer strong */
    }
     .involvement-tree-section details > ul > li > ul > li > ul { /* For participant lists under each role */
        padding-left: 1rem;
        font-size: 1em; /* Relative to parent li */
        list-style-type: none;
     }
     .involvement-tree-section details > ul > li > ul > li > ul > li a {
        color: var(--cc-primary);
     }

    /* ---- NEW: Items Page Specific Styles ---- */
    .items-nav {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--cc-brown-300);
    }
    .items-nav button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--cc-brown-300);
        background-color: var(--cc-bg-card);
        color: var(--cc-text-header);
        border-radius: var(--cc-radius);
        cursor: pointer;
        font-weight: 600;
    }
    .items-nav button.active {
        background-color: var(--cc-primary);
        color: white;
        border-color: var(--cc-primary);
    }
    .items-nav button:hover:not(.active) {
        background-color: var(--cc-pill-bg);
    }
    #items .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: center;
    }
    #items .filters input, #items .filters select {
        padding: 0.4rem 0.6rem;
        border: 1px solid var(--cc-brown-300);
        border-radius: var(--cc-radius);
        font-family: 'Nunito', sans-serif;
        font-size: 0.9em;
    }
    #items .filters input#items-search { flex-grow: 1; }
    .metrics { font-size: 0.8em; color: #777; display: block; margin-top: 0.3rem; }

    /* ---- NEW: Jobs Page Specific Styles ---- */
    .jobs-layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.5fr); /* Flexible ratio */
        gap: 2rem;
    }
    .jobs-main-column { /* Contains job filters, job cards, new job form */
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    .jobs-sidebar-column { /* Contains candidate deck */
        padding-left: 1.5rem;
        border-left: 1px solid var(--cc-brown-300);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    #jobs-container { display: flex; flex-direction: column; gap: 1.5rem; }
    #candidates-container { display:flex; flex-wrap:wrap; gap:1.5rem; width:100%;} 

    @media (max-width: 900px) { 
        .jobs-layout-grid {
            grid-template-columns: 1fr; 
        }
        .jobs-sidebar-column {
            border-left: none;
            padding-left: 0;
            margin-top: 2rem; 
        }
    }
    
    /* ---- NEW: Pings Page Specific Styles ---- */
    #ping-thread-list .thread-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--cc-brown-300);
        cursor: pointer;
        transition: background-color var(--cc-tr);
    }
    #ping-thread-list .thread-row:hover {
        background-color: var(--cc-pill-bg);
    }
    #ping-thread-list .thread-row:last-child {
        border-bottom: none;
    }
    #ping-thread-list .thread-row span:first-child {
        font-weight: 600;
    }
    #ping-thread-list .thread-row small {
        color: #777;
        margin-left: auto;
        margin-right: 0.5rem;
    }

    /* ---- NEW: Social Tab Specific Styles ---- */
    #social-profile-cards-container { /* NEW */
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        width: 100%;
        margin-bottom: 2rem; /* Space before community chat */
    }
    .chat-window { /* Used by Social tab's #social-messages */
        height: 400px; /* Or other suitable height */
        overflow-y: auto;
        border: 1px solid var(--cc-brown-300);
        padding: 0.75rem;
        margin-bottom: 1rem;
        background-color: var(--cc-bg-card);
        border-radius: var(--cc-radius);
        display: flex;
        flex-direction: column;
    }
    .chat-form { /* Used by Social tab's #social-send */
        display: flex;
        gap: 0.5rem;
        align-items: stretch; /* Align items for consistent height */
    }
    .chat-form textarea {
        flex-grow: 1;
        resize: vertical;
        min-height: 40px; /* Ensure textarea has a decent initial height */
        padding: 0.5rem;
        border: 1px solid var(--cc-brown-300);
        border-radius: var(--cc-radius);
        font-family: inherit;
    }
    .chat-form button.btn {
        margin-top: 0; /* Override default .btn margin-top */
        align-self: flex-end; /* Align button to bottom if textarea grows */
    }
    /* Styling for Company Detail Card from Ch 12 */
    #tpl-company-detail #co-logo {
        width:120px;height:120px;object-fit:cover;border-radius:var(--cc-radius);margin-right:1.5rem;flex-shrink:0;
    }
    #tpl-company-detail h4 { margin-top: 1rem; margin-bottom: 0.3rem;}
    #tpl-company-detail div[id^="co-"] > a {display: block; margin-bottom: 0.2rem;}
    #tpl-company-detail div[id^="co-"] > a:hover {text-decoration: underline;}

    /* --- START: Companies tab CSS (NEW) --- */
    #companies{
      display:flex;
      gap:2rem;
    }
    .sidebar-company{
      width:260px;
      background:var(--cc-bg-card);
      border:1px solid var(--cc-brown-300);
      border-radius:var(--cc-radius);
      padding:1rem;
      height:max-content;
      position:sticky;
      top:1.5rem;
    }
    .sidebar-company .filter-block {
        margin-bottom: 1rem;
    }
    .sidebar-company .filter-block:last-child {
        margin-bottom: 0;
    }
    .sidebar-company .filter-block .cc-pill.tag-filter { /* Specific for company filter pills */
        cursor: pointer;
    }
    .sidebar-company .filter-block .cc-pill.tag-filter.active {
      background-color: var(--cc-primary);
      color: white;
      border-color: var(--cc-primary-dark);
    }
    .sidebar-company #co-filter-search input[type="search"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--cc-brown-300);
        border-radius: var(--cc-radius);
        font-family: 'Nunito', sans-serif;
        box-sizing: border-box;
    }

    .companies-grid{
      flex:1;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:1.25rem;
    }
    .company-card{
      background:var(--cc-bg-card);
      border-radius:var(--cc-radius);
      box-shadow:var(--cc-shadow-1);
      padding:1rem;
      cursor:pointer;
      transition:transform var(--cc-tr),box-shadow var(--cc-tr);
    }
    .company-card:hover{
      transform:translateY(-2px);
      box-shadow:var(--cc-shadow-2);
    }
    .company-logo{
      width:56px;height:56px;border-radius:12px;object-fit:cover;margin-right:.75rem;flex-shrink:0;
    }
    .company-card h4{margin:0;font-size:1.05rem;color:var(--cc-brown-700);}
    .company-card p {margin:.3rem 0 0;font-size:.83rem;color:var(--cc-espresso);}
    /* --- END: Companies tab CSS (NEW) --- */

    /* ---- NEW: Biography Chapter Styling ---- */
    .biography-chapter-item {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px dashed var(--cc-brown-300);
    }
    .biography-chapter-item:last-child {
      border-bottom: none;
      margin-bottom: 0.5rem; /* Reduce margin for the last item */
    }
    .biography-chapter-item h4 { /* Chapter Title */
      font-size: 1.05em; 
      /* color: var(--cc-text-header); Will be overridden by detail panel heading styles */
      margin-top: 0; 
      margin-bottom: 0.5rem;
    }
    .biography-chapter-item p,
    .biography-chapter-item ul {
      font-size: 0.92em;
      line-height: 1.5;
      /* color: var(--cc-text); Will be overridden by detail panel text styles */
      margin-left: 0; 
    }
    .biography-chapter-item ul {
      list-style-type: disc;
      padding-left: 1.2rem; 
      margin-top: 0.3rem;
    }
    .biography-chapter-item ul li {
      margin-bottom: 0.25rem;
    }
    #detail-profile-biography-chapters-section > .label { 
        display: block; 
        margin-bottom: 0.75rem; 
    }

    /* ---- PROFILE TIMELINE DETAIL STYLES (ai-2027.com inspired + React component styles) ---- */
    #tpl-profile-detail .profile-header-container { 
        display: flex; align-items: flex-start; margin-bottom: 1.5rem;
        padding-bottom: 1rem; border-bottom: 1px solid #E2E8F0; /* Equiv. border-gray-200 */
    }
    #tpl-profile-detail .profile-header-text h2,
    #tpl-profile-detail .profile-header-text h3,
    #tpl-profile-detail .profile-header-text p { margin-bottom: 0.25rem; }

    #tpl-profile-detail #detail-profile-content-columns { 
        display: flex; flex-direction: row; width: 100%; gap: 1.5rem; 
    }
    #tpl-profile-detail .profile-timeline-nav-container { 
        flex: 0 0 240px; /* approx w-64 */
        padding-right: 1rem; /* approx p-5 for internal, then some for right border */
        max-height: calc(100vh - 220px); 
        overflow-y: auto;
        border-right: 1px solid #E2E8F0; /* border-gray-200 */
    }
    #tpl-profile-detail .profile-timeline-nav { 
        list-style: none; padding-left: 15px; /* space for bullet and line */
        position: relative; margin-top: 0;
    }
    #tpl-profile-detail .profile-timeline-nav::before { /* The vertical line */
        content: ''; position: absolute; 
        left: 5.5px; /* (12px dot / 2) - (1px line / 2) -> center alignment if dot is 12px wide */
        top: 10px; bottom: 10px; /* Adjust top/bottom to align with first/last bullet */
        width: 1px; /* w-px */
        background-color: #CBD5E0; /* bg-gray-300 */
        z-index: 1;
    }
    #tpl-profile-detail .profile-timeline-nav li { 
        position: relative; 
        /* padding-left: 20px; /* Space from line to text. Item content starts after bullet */
        margin-bottom: 10px; 
    }
    #tpl-profile-detail .profile-timeline-nav li.timeline-item-hidden {
        opacity: 0;
        transform: translateY(10px); 
    }
    #tpl-profile-detail .profile-timeline-nav li.timeline-item-visible {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.4s ease-out, transform 0.4s ease-out; /* Matches React component suggestion */
    }

    #tpl-profile-detail .profile-timeline-nav a { 
        display: block; padding: 8px 10px; 
        text-decoration: none;
        font-size: 0.8rem; /* text-xs like */
        color: #4A5568; /* text-gray-700 for nav items (React had gray-600) */
        position: relative; z-index: 2; 
        background-color: #FFFFFF; /* bg-white */
        border-radius: 6px; /* rounded-md equivalent */
        border: 1px solid #E2E8F0; /* border-gray-200 */
        /* For ring effect */
        outline: 1px solid transparent; 
        outline-offset: 1px; /* ring-offset-0 equivalent */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-xs */
        transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, 
                    border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, 
                    outline-color 0.15s ease-in-out;
    }
    #tpl-profile-detail .profile-timeline-nav a:hover {
        border-color: #A0AEC0; /* hover:border-gray-300 (was gray-400) */
        background-color: #F7FAFC; /* hover:bg-gray-50 */
    }
    #tpl-profile-detail .profile-timeline-nav a.active-timeline-item { 
        font-weight: 500; /* font-medium */
        color: #2D3748; /* text-gray-800 */
        background-color: #F7FAFC; /* bg-gray-100 */
        border-color: var(--bullet-accent-color, var(--cc-primary)); /* Use accent color, was gray-300 */
        /* outline uses accent color */
        outline-color: var(--bullet-accent-color, var(--cc-primary));
    }
    #tpl-profile-detail .profile-timeline-nav a .nav-item-title {
        font-weight: 600; /* font-semibold for title */
        font-size: 0.875rem; /* text-sm */
        color: #1A202C; /* text-gray-900 */
        margin-bottom: 2px;
    }
    #tpl-profile-detail .profile-timeline-nav a .nav-item-subtitle {
        font-size: 0.75rem; /* text-xs */
        color: #718096; /* text-gray-500 */
    }

    #tpl-profile-detail .profile-timeline-nav a::before { /* The bullet/marker */
        content: ''; position: absolute; 
        left: -17.5px; /* (nav padding-left 15px) - (bullet 12px/2) - (bullet border 2px) */
                       /* Adjusted for 12px dot, 2px border -> 15 - 6 - 2 = 7px. Needs to be further left. */
                       /* React: pl-6 (24px) for item, dot is left:0. So, left: - (24px - half_dot_width) */
                       /* Here, nav li has no padding. Link has padding. Bullet relative to link. */
                       /* If link has padding-left: 10px, and line is at 5.5px, bullet is 5.5 - 10 + half_bullet_width */
                       /* For a 12px dot + 2px white border, total 16px. Center it on the line (5.5px) */
                       /* Left pos of link edge: 15px from ul start. Line is at 5.5px. Distance: 9.5px. */
                       /* Half width of bullet (12px+2*2px border = 16px -> 8px). Position: 9.5px - 8px = 1.5px from link edge. */
                       /* This means -1.5px from the link's internal content area. This is complex. */
                       /* Let's try React's method: relative to item div: left-0 */
                       /* Our timeline-item-academic li is the reference. Bullet is child of <a>. */
                       /* If <li> has padding-left 24px, and bullet is left: 0 of <li>. */
                       /* Current: ul has padding-left 15px. Line at 5.5px from ul start. */
                       /* Link `a` is child of `li`. Let's make `li` do the padding-left for item text. */
                       /* --> Change: `li` gets `padding-left: 24px`. `a::before` is `left: -24px + 6px = -18px;` */
        top: 0.5rem; /* approx top-2 of React */
        transform: translateY(0%); /* Align top of bullet with top of text line */
        width: 12px; /* h-3 w-3 */
        height: 12px; /* h-3 w-3 */
        border-radius: 50%; 
        background-color: var(--bullet-accent-color, #A0AEC0); /* Default gray, overridden by JS */
        border: 2px solid #FFFFFF; /* border-white from React */
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05); /* Subtle shadow from React */
        z-index: 3;
        transition: background-color 0.15s ease-in-out;
    }


    #tpl-profile-detail .profile-main-details-column { 
        flex: 3; min-width: 0; 
    }
    /* Styling for the card in the center column (Academic Timeline Content) */
    #tpl-profile-detail #profile-timeline-center-content .timeline-center-card {
        background-color: #FFFFFF; /* bg-white */
        border-radius: 0.375rem; /* rounded-md */
        border: 1px solid #E2E8F0; /* border-gray-200 */
        /* React's shadow-sm and ring-1 on expanded */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); /* shadow-sm */
        outline: 1px solid transparent; /* For accent "ring" effect */
        outline-offset: 0px; /* ring-offset-0 */
        padding: 1rem 1.25rem; /* Approx p-3 md:p-4 */
        transition: border-color 0.15s ease-in-out, outline-color 0.15s ease-in-out;
    }
    /* Card content styling (shared structure for elements within the center card) */
    .timeline-card-header-meta { 
        display: flex; align-items: center; justify-content: space-between;
        font-size: 0.75rem; /* text-xs */ color: #718096; /* text-gray-500 */
        margin-bottom: 0.25rem; /* mb-1 */
    }
    .timeline-card-header-meta .read-time { color: #A0AEC0; /* text-gray-400 */ }

    /* Use h4 for title in center card, as it's inside a detail panel */
    #tpl-profile-detail #profile-timeline-center-content .timeline-center-card h4.item-title {
        font-family: 'Merriweather', serif; /* Ensure heading font */
        color: #1A202C; /* gray-900 */
        font-size: 1rem; /* text-base or md:text-base */ font-weight: 600; /* font-semibold */
        line-height: 1.375; /* leading-snug */
        margin-top: 0; margin-bottom: 0.1rem;
    }
    .timeline-card-subtitle {
        font-size: 0.75rem; /* text-xs */ color: #718096; /* text-gray-500 */
        margin-top: 0.25rem; /* mt-1 */
    }
    .timeline-card-description {
        font-size: 0.875rem; /* text-sm */ color: #4A5568; /* text-gray-700 */
        line-height: 1.625; /* leading-relaxed */ margin-bottom: 0.75rem; /* mb-3 */
        margin-top: 0.75rem; /* Added for spacing */
    }
    .timeline-card-keywords-container {
        display: flex; flex-wrap: wrap; gap: 0.25rem; /* gap-1 from React (0.25rem) */
        margin-bottom: 0.75rem; /* mb-3 */
    }
    /* Using text-xxs from React for keywords */
    .timeline-card-keyword {
        padding: 0.25rem 0.5rem; /* px-2 py-1 */
        background-color: #F7FAFC; /* bg-gray-100 */ color: #4A5568; /* text-gray-600 */
        font-size: 0.625rem; /* text-xxs */ line-height: 0.75rem;
        border-radius: 0.25rem; /* rounded */ border: 1px solid #E2E8F0; /* border-gray-200 */
    }
    .timeline-card-details-section { 
        margin-top: 0.75rem; padding-top: 0.75rem;
        border-top: 1px solid #E2E8F0; /* border-gray-200 */
        font-size: 0.75rem; /* text-xs */ color: #718096; /* text-gray-500 */
    }
    .timeline-card-details-section > p, .timeline-card-details-section > div { margin-bottom: 0.25rem; /* space-y-1 like */ }
    .timeline-card-details-section p span { color: #4A5568; } /* Values inside details */
    .timeline-card-details-section a { color: #3182CE; text-decoration: none; } /* text-blue-600 */
    .timeline-card-details-section a:hover { text-decoration: underline; }
    .timeline-card-action-links {
        display: flex; align-items: center; gap: 0.75rem; /* gap-3 */
        padding-top: 0.5rem; /* pt-2 */
        font-size: 0.75rem; /* text-xs */
    }
    .timeline-card-action-links a, .timeline-card-action-links button {
        color: #3182CE; /* text-blue-600 */ text-decoration: none;
        background: none; border: none; padding: 0; cursor: pointer;
    }
    .timeline-card-action-links a:hover, .timeline-card-action-links button:hover { text-decoration: underline; }


    #tpl-profile-detail .profile-timeline-contextual-info-column { 
        flex: 2; min-width: 220px; 
        max-height: calc(100vh - 220px); overflow-y: auto;
        padding-left: 1.5rem; border-left: 1px solid var(--cc-brown-300);
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column h4, 
    #tpl-profile-detail #profile-timeline-center-content h4 {  /* Existing style, ensure it uses Merriweather if desired */
        margin-top: 0; margin-bottom: 0.75rem; padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--cc-brown-300); 
        /* color: var(--cc-text-header); Font set by .detail h4 */
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column ul {
        list-style: none; padding-left: 0; margin-top: 0;
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column ul li {
        margin-bottom: 0.4rem; font-size: 0.9em;
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column ul li strong {
        /* color: var(--cc-text-header); Font set by .detail strong, if needed */
        display: block; margin-bottom: 0.1rem;
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column p {
        font-size: 0.875rem; 
        margin-top: 0;
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column a:not(.btn),
    #tpl-profile-detail #profile-timeline-center-content .timeline-center-card a:not(.btn) { 
        color: #3182CE; /* text-blue-600 */
        text-decoration: none;
    }
    #tpl-profile-detail .profile-timeline-contextual-info-column a:not(.btn):hover,
    #tpl-profile-detail #profile-timeline-center-content .timeline-center-card a:not(.btn):hover {
        text-decoration: underline;
    }
     #tpl-profile-detail .mbti-btn i.feather {
       vertical-align: middle; margin-right: 0.35em;
    }

    /* Responsive stacking for profile timeline columns */
    @media (max-width: 1100px) { 
        #tpl-profile-detail #detail-profile-content-columns {
            flex-direction: column; gap: 1rem;
        }
        #tpl-profile-detail .profile-timeline-nav-container {
            width: 100%; border-right: none; border-bottom: 1px solid #E2E8F0; /* gray-200 */
            padding-right: 0; padding-bottom: 1rem; margin-bottom: 1rem;
            max-height: 280px; 
        }
        #tpl-profile-detail .profile-main-details-column { padding-right: 0; }
        #tpl-profile-detail .profile-timeline-contextual-info-column {
            padding-left: 0; border-left: none; border-top: 1px solid #E2E8F0; /* gray-200 */
            margin-top: 1rem; padding-top: 1rem; max-height: none;
        }
    }
    /* END PROFILE TIMELINE DETAIL STYLES */

  </style>
</head>
<body>

  <div id="sidebar" style="position:fixed;left:0;top:60px;width:260px;
      height:calc(100vh - 60px);padding:1rem;background:#fff;box-shadow:2px 0 8px rgb(0 0 0 /.05); z-index: 901; display: flex; flex-direction: column;">
    <div id="my-card"></div>
    <hr/>
    <strong>Active as:</strong>
    <div id="role-switcher" style="margin-top:.4rem;"></div>
    <small style="display:block;margin-top:.8rem;font-size:.8em;">
      Show me as:<br/>
      <label><input type="radio" name="multi" value="all" checked> all checked</label><br/>
      <label><input type="radio" name="multi" value="one"> only one</label>
    </small>
    <div id="mini-bot" style="margin-top: auto; 
        background:#f8f8fb;border:1px solid var(--cc-brown-300);border-radius:10px;
        padding:.5rem .6rem;font-size:.8em;max-height:230px;display:flex;flex-direction:column;">
      <div id="bot-log" style="flex:1;overflow:auto; margin-bottom: 0.3rem;"></div>
      <form id="bot-form" style="display:flex;gap:.3rem;margin-top:.3rem;">
        <input name="q" placeholder="Ask me‚Ä¶" style="flex:1;padding:.3rem;border:1px solid var(--cc-brown-300);border-radius:6px;">
        <button class="btn" style="padding:.25rem .7rem;">‚Ü©Ô∏é</button>
      </form>
    </div>
  </div>

  <header><h1>CafeCorner</h1></header>
  <div class="nav-container">
    <nav>
      <a href="#" data-target="social">üí¨ Social</a>
      <a href="#" data-target="events">üìÖ Events</a>
      <a href="#" data-target="items" class="active">üõçÔ∏è Items</a> 
      <a href="#" data-target="companies">üè≠ Companies</a> <!-- NEW TAB BUTTON -->
      <a href="#" data-target="jobs">üíº Jobs</a>
      <a href="#" data-target="pings" id="nav-pings">üîî Pings <span id="ping-unread-badge" style="display:none;">0</span></a>
    </nav>
    <button id="reset-view-btn" class="btn"><i data-feather="refresh-cw"></i> Reset View</button>
  </div>
  
  <div id="main">
    <section id="social" class="tab-panel" hidden> <!-- Ensure class tab-panel and hidden if not default -->
     <h2>People</h2>
     <div id="social-profile-cards-container">
        <!-- Profile cards will be rendered here by JS -->
     </div>
     <h2>üí¨ Community Chat</h2>
     <div id="social-messages" class="chat-window"></div>
     <form id="social-send" class="chat-form">
        <textarea name="txt" placeholder="Say something‚Ä¶" required></textarea>
        <button type="submit" class="btn">Send ‚Ü©Ô∏é</button>
     </form>
   </section>

    <section id="events" class="tab-panel" hidden> <!-- Ensure class tab-panel and hidden if not default -->
      <h2>
        <span style="flex-grow:1;">üìÖ Upcoming Events</span>
        <input class="quick-search" data-scope="events" placeholder="üîé quick filter‚Ä¶">
      </h2>
      <ul class="event-tree" id="event-list-container">
      </ul>
      <details id="new-event-form-container" class="create-form-container card-shell" style="width:100%;">
        <summary class="btn" style="background:var(--cc-pill-bg); color:var(--cc-primary);">‚ûï New Event</summary>
        <form id="new-event-form">
          <input name="title" placeholder="Event Title" required>
          <input name="date" type="date" placeholder="Event Date" required>
          <input name="time" placeholder="Event Time (e.g., 10 AM - 5 PM)">
          <input name="locationName" placeholder="Location Name (e.g., City Park)" required>
          <input name="address" placeholder="Full Address">
          <textarea name="description" placeholder="Event description"></textarea>
          <input name="coverImage" placeholder="Cover Image URL">
          <input name="websiteUrl" placeholder="Event Website URL">
          <textarea name="tags" placeholder="e.g., Artisan Market, Tech Conference, AAPI-Owned, Python Workshop, Sustainable"></textarea>
          <label style="margin-top:.6rem;display:block;">
            <span style="font-size:.85em; cursor:pointer;">üìπ Promo video/image (drag file or record)</span><br>
            <input type="file" accept="video/*,image/*,audio/*" style="display:none" id="pitch-file-event" data-form-type="event"> 
            <button type="button" class="btn record-btn-dynamic" id="record-btn-event" data-form-type="event">Record 30 s</button>
            <video id="pitch-preview-event" style="width:100%;max-height:120px;margin-top:.4rem;display:none;" controls></video>
          </label>
          <button type="submit" class="btn">Create Event</button>
        </form>
      </details>
    </section>
    
    <section id="items" class="tab-panel"> <!-- This might be active by default -->
      <h2>üõçÔ∏è Marketplace</h2>
      <div class="items-nav">
          <button data-view="browse" class="active">Browse Items</button>
          <button data-view="my" style="display:none;">My Listings</button>
      </div>
      <div class="filters">
          <input id="items-search" class="quick-search" data-scope="items" placeholder="Search items by name, description, tag‚Ä¶" />
          <select id="items-category">
            <option value="">All Categories</option>
          </select>
          <select id="items-sort">
            <option value="created_at-desc">üÜï Newest First</option>
            <option value="created_at-asc">üÜï Oldest First</option>
            <option value="price-asc">üí≤ Price: Low to High</option>
            <option value="price-desc">üí≤ Price: High to Low</option>
          </select>
      </div>
      <div id="items-container"></div>
      <div id="my-items-container" style="display:none;"></div>
      <details id="new-item-form-container" class="create-form-container card-shell" style="width:100%; display:none;">
          <summary class="btn" style="background:var(--cc-pill-bg); color:var(--cc-primary);">‚ûï List New Item</summary>
          <form id="new-item-form">
              <input name="title" placeholder="Item Name" required>
              <input name="price" type="number" step="0.01" placeholder="Price" required>
              <select name="currency" required>
                  <option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option>
              </select>
              <input name="img_url" placeholder="Image URL">
              <textarea name="description" placeholder="Item description"></textarea>
              <textarea name="tags" placeholder="Comma-separated tags/categories (e.g., Handmade, Decor, Coffee)"></textarea>
              <label><input type="checkbox" name="venmo"> Accept Venmo</label>
              <label><input type="checkbox" name="paypal"> Accept PayPal</label>
              <input name="external_url" placeholder="Link to external store/social (optional)">
              <label style="margin-top:.6rem;display:block;">
                  <span style="font-size:.85em; cursor:pointer;">üìπ Item video/image (drag file or record)</span><br>
                  <input type="file" accept="video/*,image/*,audio/*" style="display:none" id="pitch-file-item" data-form-type="item"> 
                  <button type="button" class="btn record-btn-dynamic" id="record-btn-item" data-form-type="item">Record 30 s</button>
                  <video id="pitch-preview-item" style="width:100%;max-height:120px;margin-top:.4rem;display:none;" controls></video>
              </label>
              <button type="submit" class="btn">List Item</button>
          </form>
      </details>
    </section>

    <!-- NEW COMPANIES TAB MARKUP -->
    <section id="companies" class="tab-panel" hidden>
      <aside class="sidebar sidebar-company">
        <h3 style="margin-top:0;">Filters</h3>
        <div id="co-filter-tags"   class="filter-block"></div>
        <div id="co-filter-size"   class="filter-block"></div>
        <div id="co-filter-search" class="filter-block">
          <input type="search" placeholder="Search company‚Ä¶"> <!-- oninput removed, will be handled by JS -->
        </div>
      </aside>
      <div class="companies-grid" id="companies-grid"></div>
    </section>
    <!-- END NEW COMPANIES TAB MARKUP -->

    <section id="jobs" class="tab-panel" hidden> <!-- Ensure class tab-panel and hidden if not default -->
      <h2>üíº Jobs Marketplace</h2>
      <div class="jobs-layout-grid">
        <div class="jobs-main-column">
          <input class="quick-search" data-scope="jobs" id="jobs-quick-search" placeholder="üîé Filter jobs by title, skill, description...">
          <div id="jobs-container"></div>
          <details id="new-job-form-container" class="create-form-container card-shell" style="width:100%; display:none;"> 
            <summary class="btn" style="background:var(--cc-pill-bg); color:var(--cc-primary);">‚ûï Post New Job</summary>
            <form id="new-job-form"> 
              <input name="title" placeholder="Job Title" required>
              <textarea name="description" placeholder="Detailed description of the job" required></textarea>
              <textarea name="skills" placeholder="Comma-separated skills required (e.g., Graphic Design, SEO)" required></textarea>
              <select name="status">
                <option value="open">Open</option><option value="in progress">In Progress</option><option value="closed">Closed</option>
              </select>
              <label style="margin-top:.6rem;display:block;">
                <span style="font-size:.85em; cursor:pointer;">üìπ Job details video/image (drag file or record)</span><br>
                <input type="file" accept="video/*,image/*,audio/*" style="display:none" id="pitch-file-job" data-form-type="job"> 
                <button type="button" class="btn record-btn-dynamic" id="record-btn-job" data-form-type="job">Record 30 s</button>
                <video id="pitch-preview-job" style="width:100%;max-height:120px;margin-top:.4rem;display:none;" controls></video>
              </label>
              <button type="submit" class="btn">Post Job</button>
            </form>
          </details>
        </div>
        <div class="jobs-sidebar-column" id="candidate-deck-panel">
          <h3>Candidate Deck</h3>
          <div class="candidate-deck-search">
            <input type="text" id="candidate-deck-search-input" placeholder="Search candidates by highlight‚Ä¶"/>
            <button class="btn" id="candidate-deck-search-btn">Search Candidates</button>
          </div>
          <div id="candidates-container"></div>
            <details class="create-form-container card-shell" style="width:100%; margin-top: 1.5rem;" id="new-candidate-profile-form-container">
                <summary class="btn" style="background:var(--cc-pill-bg); color:var(--cc-primary);">‚ûï New Candidate Profile</summary>
                <form id="new-profile-candidate-form">
                  <input name="name" placeholder="Full Name" required>
                  <input name="avatar" placeholder="Avatar URL (e.g., pexels.com/...)" required>
                  <input name="title" placeholder="Job Title / Headline" required>
                  <textarea name="highlights" placeholder="Comma-separated highlights (e.g., Figma, LLMs)" required></textarea>
                  <textarea name="bio" placeholder="Short bio / tagline"></textarea>
                  <input name="location" placeholder="Location (e.g., Remote, City, CA)">
                  <label style="margin-top:.6rem;display:block;">
                    <span style="font-size:.85em; cursor:pointer;">üìπ Pitch video/image (drag file or record)</span><br>
                    <input type="file" accept="video/*,image/*,audio/*" style="display:none" id="pitch-file-candidate" data-form-type="candidate"> 
                    <button type="button" class="btn record-btn-dynamic" id="record-btn-candidate" data-form-type="candidate">Record 30 s</button>
                    <video id="pitch-preview-candidate" style="width:100%;max-height:120px;margin-top:.4rem;display:none;" controls></video>
                  </label>
                  <button type="submit" class="btn">Create Candidate</button>
                </form>
            </details>
        </div>
      </div>
    </section>

    <section id="pings" class="tab-panel" hidden> <!-- Ensure class tab-panel and hidden if not default -->
     <h2>üîî Pings</h2>
     <div id="ping-thread-list"></div>
   </section>
  </div>

  <!-- Unified Detail Overlay -->
  <div id="detail-overlay" class="detail">
    <!-- Content will be injected here by showDetailPanel -->
  </div>

  <!-- Profile Detail Template (Modified for Academic Timeline) -->
  <template id="tpl-profile-detail">
    <button class="btn back-btn"><i data-feather="arrow-left"></i> Back to Overview</button>
    <div class="detail-card-content-wrapper card-shell">
        <div class="profile-header-container"> 
            <label style="cursor:pointer; flex-shrink:0;">
                <img src="" alt="Profile Avatar" id="detail-profile-avatar" class="avatar-80" 
                     style="width: 80px; height: 80px; border-radius: 9999px; border: 2px solid #CBD5E0;" > <!-- React w-20 h-20 styling -->
            </label>
            <div class="profile-header-text">
                <h2 id="detail-profile-name-header" style="margin-top:0; font-size: 1.25rem; font-weight: 700;"></h2> <!-- React h1#profile-name-academic style -->
                <h3 id="detail-profile-name-sub" style="display:none; font-size: 1rem; color: var(--cc-brown-500);"></h3>
                <p id="detail-profile-title" style="font-style:italic; font-size: 0.875rem; color: #718096; margin-bottom: 0.5rem;"></p> <!-- React p#profile-title-academic style -->
            </div>
        </div>
      
        <div id="detail-profile-content-columns"> 
            <div class="profile-timeline-nav-container">
                <!-- Academic Timeline Nav Items will be primary here for Dr. Reed -->
                 <h4 style="font-size: 0.75rem; font-weight: 600; color: #718096; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; padding-left: 5px;">
                    Timeline Navigation
                 </h4>
                <ul class="profile-timeline-nav" id="profile-timeline-nav-list">
                </ul>
            </div>

            <div class="profile-main-details-column"> 
                <div class="data-section"><span class="label">Bio:</span><p id="detail-profile-bio" style="font-size: 0.875rem; color: #4A5568; line-height: 1.5;"></p></div> <!-- React p#profile-bio-academic style -->
                <div class="data-section"><span class="label">Location:</span><p id="detail-profile-location"></p></div>
                <div class="data-section" id="detail-profile-highlights-parent"><span class="label">Highlights:</span><div id="detail-profile-highlights"></div></div>
                <div class="data-section" id="detail-profile-skills-parent" style="display:none;"><span class="label">Skills (Legacy):</span><div id="detail-profile-skills"></div></div>
                <div class="data-section" id="detail-profile-interests-parent"><span class="label">Interests:</span><div id="detail-profile-interests"></div></div>
                
                <div id="detail-profile-biography-chapters-section" class="data-section" style="display:none;">
                    <h4 class="label" style="font-size: 1.1em; margin-bottom: 0.75rem;">Biography Chapters:</h4>
                    <div id="detail-profile-biography-chapters-container">
                    </div>
                </div>
                
                <!-- Academic Timeline Content will be rendered here -->
                <div id="profile-timeline-center-content" class="data-section" style="margin-top: 1.5rem; padding-top: 0; border-top: none;">
                    <p style="font-style: italic;">Select an item from the timeline navigation to see details.</p>
                </div>

                <a href="#" target="_blank" class="btn" id="detail-profile-link" style="display:none; margin-top:1rem;">Visit Profile/Website</a>
                <button class="btn mbti-btn" style="margin-top:1rem;"><i data-feather="coffee"></i> What Coffee Am I?</button>
                <span class="mbti-badge cc-pill" style="display:none;margin-left:.5rem;"></span>
            </div>

            <div class="profile-timeline-contextual-info-column"> 
                 <!-- Contextual Info for Academic Timeline Item -->
                <div id="profile-timeline-right-sidebar-content">
                    <p style="font-style: italic;">Contextual information for the selected timeline item will appear here.</p>
                </div>
                 <!-- Original Involvement Tree can be here if Dr. Reed has CafeCorner event/job involvements -->
                <div id="profile-involvement-tree-container" class="involvement-tree-section" style="display:none;">
                    <h4>CafeCorner Involvements:</h4>
                    <div id="detail-profile-involvement-tree"></div>
                </div>
            </div>
        </div>
    </div>
  </template>
  <!-- === END REPLACEMENT OF tpl-profile-detail === -->

  <!-- Event Detail Template -->
  <template id="tpl-event-detail">
    <button class="btn back-btn"><i data-feather="arrow-left"></i> Back</button>
    <div class="detail-card-content-wrapper card-shell">
      <img src="" alt="Event Cover" id="detail-event-cover-img" style="width:120px; height:120px; object-fit:cover; border-radius:var(--cc-radius); margin-right:1.5rem; flex-shrink:0;">
      <div class="card-content" id="detail-event-content">
        <h2 id="detail-event-title" style="margin-top:0;"></h2>
        <p id="detail-event-date-time" style="font-size:0.9em; color:#555;"></p>
        <p id="detail-event-location" style="font-size:0.9em; color:#555;"></p>
        
        <div class="data-section">
            <span class="label">Description:</span>
            <p id="detail-event-description"></p>
        </div>

        <div class="data-section" id="detail-event-tags-parent">
            <span class="label">Tags:</span>
            <div id="detail-event-tags"></div>
        </div>
        
        <div class="data-section involvement-tree-section" id="detail-event-participants-parent">
            <h4 class="label">Participants & Roles:</h4>
            <div id="detail-event-participants-tree">
            </div>
        </div>
        
        <div style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
            <a href="#" target="_blank" class="btn" id="detail-event-website-link" style="display:none;">Visit Event Website</a>
            <button class="btn join-btn" id="detail-event-join-btn" data-stage-id="">+ Add My Profile to Event</button>
            <button class="ping-btn ping-event-btn" id="detail-event-ping-btn" data-event-id="">üí¨ Ping Event</button>
        </div>

        <form class="mini-comment-form" id="detail-event-comment-form" data-ctx-id="" style="margin-top: 1rem;">
            <input name="comment" maxlength="120" placeholder="Say hi about this event‚Ä¶">
            <button type="submit" class="btn" style="font-size:0.8em; padding: 0.2rem 0.6rem; margin-top:0.2rem;">Comment</button>
        </form>
      </div>
    </div>
  </template>

  <template id="tpl-project-detail">
    <button class="btn back-btn"><i data-feather="arrow-left"></i> Back</button>
    <div class="detail-card-content-wrapper card-shell">
      <div class="card-content" style="width:100%;">
        <h2 id="proj-title"></h2>
        <p id="proj-blurb"></p>
        <span class="project-status cc-pill" id="proj-status"></span>
  
        <h4>Gallery</h4>
        <div class="project-gallery" id="proj-gallery"></div>
  
        <h4>Core Features</h4>
        <ul id="proj-features"></ul>
  
        <h4>Tech Stack</h4>
        <div id="proj-tech"></div>
  
        <div style="margin-top:1rem;">
          <a id="proj-owner-link" href="#" class="btn">About the Founder ‚Üó</a>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-item-detail">
    <button class="btn back-btn"><i data-feather="arrow-left"></i> Back</button>
    <div class="detail-card-content-wrapper card-shell">
      <img id="item-cover" class="item-image" style="width:140px;height:140px;margin-right:1.5rem;object-fit:cover;border-radius:var(--cc-radius);">
      <div class="card-content" style="width:100%;">
        <h2 id="item-title"></h2>
        <p id="item-price" style="font-weight:700;"></p>
        <p id="item-desc"></p>
        <div id="item-tags" style="margin:.6rem 0;"></div>
        <div id="item-payment" style="margin-bottom:.8rem;"></div>
        <a id="item-ext-link" class="btn" target="_blank" style="display:none;">Visit store ‚Üó</a>
        <div style="margin-top:1rem;">
          <button id="item-ping-btn" class="btn">Message Vendor üí¨</button>
        </div>
      </div>
    </div>
  </template>

  <template id="tpl-company-detail">
    <button class="btn back-btn"><i data-feather="arrow-left"></i> Back</button>
    <div class="detail-card-content-wrapper card-shell">
      <img id="co-logo" style="width:120px;height:120px;object-fit:cover;border-radius:var(--cc-radius);margin-right:1.5rem;flex-shrink:0;">
      <div class="card-content" style="width:100%;">
        <h2 id="co-name"></h2>
        <p id="co-blurb"></p>
        <p><strong>Founded:</strong> <span id="co-founded"></span></p>
        <div id="co-tags" style="margin:.6rem 0;"></div>
  
        <h4>Team</h4>
        <div id="co-team"></div>
  
        <h4>Projects</h4>
        <div id="co-projects"></div>
  
        <h4>Marketplace Items</h4>
        <div id="co-items"></div>
  
        <h4>Products / Repos</h4>
        <div id="co-products"></div>
  
        <a id="co-site" class="btn" target="_blank">Visit website ‚Üó</a>
      </div>
    </div>
  </template>


  <div id="ping-thread-modal" class="detail" style="background:rgba(0,0,0,0.6); padding: 1rem; display:none;">
      <div class="card-shell">
          <div class="card-content" style="width:100%;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                  <h3 id="ping-thread-header" style="margin:0;">Chat</h3>
                  <button id="close-ping-modal-btn" class="btn" style="padding:0.2rem 0.5rem; margin:0; font-size:1.2em; line-height:1;">√ó</button>
              </div>
              <div id="ping-messages-container">
              </div>
              <form id="send-ping-form" style="margin-top:0.5rem;">
                  <input type="hidden" name="ping_thread_id_form_input"> 
                  <input type="hidden" name="ping_receiver_id_form_input"> 
                  <textarea name="ping_text_form_input" placeholder="Type your message..." required></textarea>
                  <button type="submit" class="btn" style="margin-top:0.5rem;">Send <i data-feather="send" style="width:1em;height:1em;"></i></button>
              </form>
          </div>
      </div>
  </div>

  <button id="fab-new-listing" class="btn"
          style="position:fixed;bottom:1.2rem;right:1.2rem;z-index:999;
                 display:none;">üõçÔ∏èÔºã</button>

  <script id="mock-data">
    // Data for Dr. Evelyn Reed (Academic Profile)
    const drEvelynReedProfileData = {
        id: "p_evelyn",
        name: "Dr. Evelyn Reed",
        title: "Researcher in AI Ethics & Cognitive Science",
        bio: "Exploring the intersection of artificial intelligence, human cognition, and ethical frameworks. Focused on developing principles for beneficial AI and fostering interdisciplinary collaboration.",
        avatar: "https://images.pexels.com/photos/3769021/pexels-photo-3769021.jpeg?auto=compress&cs=tinysrgb&w=120&h=120&dpr=1",
        kind: "candidate", // For CafeCorner categorization, can also be 'researcher', 'academic' etc. if new kinds are supported
        location: "Stanford, CA",
        highlights: ["AI Ethics", "Cognitive Science", "Algorithmic Bias", "Explainable AI", "Human-AI Interaction", "AI Alignment", "Responsible AI"],
        interests: ["Philosophy of Mind", "Neuroscience", "Effective Altruism", "Science Communication"],
        user_roles: ["candidate", "attendee", "organizer"], // Example roles
        active_role: "candidate",
        allow_multi: true,
        profileUrl: "https://example.com/evelynreed",
        // Academic Timeline Data will be directly embedded or referenced
        academicTimeline: [
            {
              id: "acad_1", date: "2020-09-15", year: "2020", title: "The Algorithmic Bias in Predictive Policing: A Critical Analysis",
              subtitle: "Journal of AI Ethics, Vol. 5, Issue 2, pp. 112-130", category: "publications", type: "journal_article",
              description: "This paper investigates inherent biases in predictive policing algorithms, analyzing their societal impact and proposing a novel framework for fairness-aware model development. It received the 'Best Early Career Researcher' award at the 2020 International Conference on AI and Society.",
              keywords: ["Algorithmic Bias", "Predictive Policing", "AI Ethics", "Fairness in ML", "Societal Impact"],
              readTime: "25 min read", citationLink: "#cite-paper-1", doi: "10.1234/jaie.2020.001", metrics: { citations: 112, views: "1.5k" }
            },
            {
              id: "acad_2", date: "2021-03-01", year: "2021", title: "Cognitive Models of Human Understanding of AI Systems",
              subtitle: "Lead Investigator, National Science Foundation Grant #AIS2021-CM", category: "projects", type: "research_grant",
              description: "Led a multi-disciplinary team of 5 researchers to develop and validate computational models simulating how humans perceive, understand, and trust AI-driven decisions. This project secured $250,000 in funding and aims to produce guidelines for transparent AI design.",
              keywords: ["Cognitive Modeling", "Human-AI Interaction", "Explainable AI", "Trust in AI", "Computational Psychology"],
              duration: "March 2021 - Feb 2023", funding: "$250,000 (NSF)", teamSize: 5, outputs: ["3 Journal Papers", "Open Source Toolkit", "Policy Brief"]
            },
            {
              id: "acad_3", date: "2021-07-22", year: "2021", title: "AI Alignment: Navigating Challenges and Charting Future Pathways",
              subtitle: "Keynote Address, Global Summit on AI Futures (Virtual)", category: "talks", type: "keynote_speech",
              description: "Presented an overview of current challenges in the field of AI alignment, discussing various theoretical approaches and proposing a collaborative roadmap for future research. The talk was delivered to an international audience of over 500 researchers, policymakers, and industry leaders.",
              keywords: ["AI Alignment", "AI Safety", "Responsible AI", "Future of AI", "Long-Term Impact"],
              attendees: "500+", location: "Virtual Conference", videoLink: "#talk-video-3"
            },
            {
              id: "acad_4", date: "2022-01-10", year: "2022", title: "Chapter: Ethical Considerations in the Deployment of Autonomous Systems",
              subtitle: "In 'The Cambridge Handbook of Artificial Intelligence Ethics', pp. 235-258", category: "publications", type: "book_chapter",
              description: "Authored a comprehensive chapter analyzing the nuanced ethical dilemmas posed by increasingly autonomous AI systems across various domains. The chapter focuses on issues of accountability, moral responsibility, and societal trust.",
              keywords: ["Autonomous Systems", "Moral Responsibility", "AI Governance", "Robotics Ethics", "Accountability"],
              readTime: "35 min read", citationLink: "#cite-chapter-4", publisher: "Cambridge University Press"
            },
            {
              id: "acad_5", date: "2022-06-05", year: "2022", title: "Workshop on Applied Rationality and Effective Altruism in Tech Development",
              subtitle: "Co-organizer and Facilitator, EA Global Connect Series", category: "events", type: "workshop",
              description: "Designed and co-facilitated an interactive workshop for 40 technology professionals. The sessions explored practical applications of rationality principles and effective altruism concepts in the context of software development, product design, and organizational strategy.",
              keywords: ["Rationality", "Effective Altruism", "Tech Ethics", "Decision Making", "Community Building"],
              participants: 40, collaboration: "Centre for Effective Altruism"
            },
            {
              id: "acad_6", date: "2023-04-18", year: "2023", title: "The Scaling Hypothesis and Its Implications for AGI Safety",
              subtitle: "Long-form Essay, AI Alignment Forum", category: "posts", type: "long_form_post",
              description: "A critical analysis of the 'scaling hypothesis' in large language models and its potential implications for achieving safe artificial general intelligence. This essay examines current research trends and argues for a diversified approach to AGI safety research. It generated over 120 comments and significant discussion.",
              keywords: ["Large Language Models", "AGI Safety", "Scaling Laws", "AI Capabilities", "Alignment Research"],
              readTime: "18 min read", comments: 127, link: "#post-link-6"
            },
            {
              id: "acad_7", date: "2023-08-12", year: "2023", title: "Metacognitive Strategies for Uncertainty Quantification in AI",
              subtitle: "Proceedings of the 32nd International Joint Conference on AI (IJCAI-23)", category: "publications", type: "conference_paper",
              description: "Introduces a novel framework for incorporating metacognitive principles into uncertainty estimation for machine learning models. The approach draws from cognitive science research on human metacognition to improve AI system reliability and interpretability.",
              keywords: ["Metacognition", "Uncertainty Quantification", "AI Reliability", "Cognitive Science", "Interpretability"],
              readTime: "22 min read", doi: "10.24963/ijcai.2023/401", metrics: { citations: 89, views: "2.1k" }
            },
            {
              id: "acad_8", date: "2023-11-30", year: "2023", title: "AI Safety Research Collaborative",
              subtitle: "Principal Investigator, Multi-institutional Initiative", category: "projects", type: "collaborative_research",
              description: "Established and leads a collaborative research network spanning 8 universities and 3 industry partners. The initiative focuses on developing practical tools for AI safety assessment and has produced 12 peer-reviewed publications and 3 open-source software packages.",
              keywords: ["AI Safety", "Research Collaboration", "Open Source", "Multi-institutional", "Safety Assessment"],
              funding: "$1.2M (Multi-source)", institutions: 8, outputs: ["12 Publications", "3 Software Packages", "Annual Conference"]
            }
        ].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime())
    };

    window.CAFE_DB = {
      profiles: [ drEvelynReedProfileData ], // Only Dr. Reed
      stages: [ // Example CafeCorner events/jobs Dr. Reed might be involved in
        { 
          id:"s_ethics_workshop", type:"event", title:"Community Workshop on AI Ethics", 
          date:"2024-09-10", time: "2 PM - 4 PM", locationName: "University Hall, Room 101", 
          description: "Dr. Reed hosts an interactive workshop for students and the public on understanding AI ethics in everyday life.", 
          keywords: ["AI Ethics", "Workshop", "Community Event", "Education", "Public Engagement"],
          tags:["AI Ethics", "Workshop", "Community"], websiteUrl:"#", coverImage: "https://images.pexels.com/photos/3184328/pexels-photo-3184328.jpeg?auto=compress&cs=tinysrgb&w=600&h=400&dpr=1",
          slots:{ 
            vendors:[], candidates:[], hosts:["p_evelyn"], organizers:["p_evelyn"], attendees:[], recruiters:[] 
          } 
        },
        { id:"job_research_assistant", type:"job", title:"Research Assistant (Part-Time) - AI Cognition Lab", posted_by:"p_evelyn", 
          description:"Seeking a motivated student to assist with literature reviews, data collection, and experiment setup for ongoing projects in AI and cognitive science. Background in psychology or computer science preferred.", 
          skills:["Research", "Data Collection", "Literature Review", "Psychology", "Computer Science"], 
          keywords: ["Research Assistant", "AI", "Cognitive Science", "Part-Time", "Academia"],
          status:"open", created_at: "2024-07-15T10:00:00Z", job_applications:[] 
        }
      ],
      items: [ // Example items Dr. Reed might list
        { 
          id: "item_consult_ethics", vendor_id: "p_evelyn", title: "AI Ethics Consultation (1hr)", 
          price: 300, currency: "USD", 
          img_url: "https://images.pexels.com/photos/3184418/pexels-photo-3184418.jpeg?auto=compress&cs=tinysrgb&w=120&h=120&dpr=1", 
          description: "One-hour expert consultation on AI ethics, responsible AI development, or bias mitigation strategies for your project or organization.", 
          tags: ["Consulting", "AI Ethics", "Professional Services", "Strategy"], 
          keywords: ["AI Consulting", "Ethical AI", "Responsible AI", "Bias Mitigation", "Expert Advice"], 
          venmo: true, paypal: true, external_url: "#", created_at: "2024-07-01T10:00:00Z", 
          stats:{ views:15, likes:5, dms:2 }
        }
      ],
      projects: [ // CafeCorner style projects - some academic ones can also be here
          {
            id: "proj_ai_cognition_lab", owner_id: "p_evelyn",     
            title: "AI & Human Cognition Lab Portal",
            blurb: "Online portal for research updates, publications, and resources from Dr. Reed's lab focusing on AI and human understanding.",
            status: "Active", created_at: "2022-01-15T00:00:00Z",
            features: [ "Publication Archive", "Research Blog", "Dataset Access (restricted)", "Contact Forms"],
            keywords: ["Cognitive Science", "AI Research", "Lab Website", "Open Science", "Human-AI Interaction"],
            tech_stack: ["Python", "Flask", "HTML/CSS", "JavaScript", "Academic Blogging Platform"],
            gallery: [ "https://images.pexels.com/photos/265087/pexels-photo-265087.jpeg?auto=compress&cs=tinysrgb&w=300&h=200&dpr=1" ]
          }
      ],
      companies: [ // Example company (University/Institute)
        {
          id: "c_stanford_cs", name: "Stanford AI Lab (SAIL)",
          logo: "https://via.placeholder.com/56/8C1515/FFFFFF?text=SAIL", // Stanford Cardinal Red
          blurb: "Advancing AI research, education, and societal impact. Home to leading researchers in various AI subfields.",
          founded: 1962, website: "https://ai.stanford.edu/",
          tags: ["Academia", "Research Institute", "AI", "Computer Science", "University", "Education"], 
          headcount: 500, // Placeholder for faculty, staff, students
          people: ["p_evelyn"],      
          projects: ["proj_ai_cognition_lab"], // Link to the lab portal project
          items: [],                             
          products : [ { kind:"website", label:"Main Website", url:"https://ai.stanford.edu/" } ]
        }
      ],
      endorsements: [], 
      mentions:     [], 
      approvals:    [],
      messages:     [], 
      uploads:      [] 
    };

    window.HIGHLIGHT_KB = {
       "AI Ethics": { desc: "Moral principles and techniques to guide the development and use of artificial intelligence.", related: { "Dr. Evelyn Reed": { type:"profile", id:"p_evelyn", desc:"Researcher in AI Ethics" }, "AI Ethics Consultation": {type:"item", id:"item_consult_ethics", desc:"1hr consultation with Dr. Reed"} }},
       "Cognitive Science": { desc: "The interdisciplinary study of mind and intelligence, embracing philosophy, psychology, AI, neuroscience, linguistics, and anthropology.", related: { "Dr. Evelyn Reed": { type:"profile", id:"p_evelyn", desc:"Focus on human cognition & AI" }}},
       "Algorithmic Bias": { desc: "Systematic and repeatable errors in a computer system that create unfair outcomes.", related: {"The Algorithmic Bias in Predictive Policing": {type:"academic_publication", id:"acad_1", desc:"Dr. Reed's paper on this topic"}}},
       "Explainable AI": { desc: "Methods and techniques in AI that enable human users to understand and trust the results created by machine learning algorithms.", related: {"Cognitive Models of Human Understanding of AI Systems": {type:"academic_project", id:"acad_2", desc:"Dr. Reed's research project"}}},
       "AI Alignment": { desc: "The problem of ensuring that AI systems pursue goals that are aligned with human values and intentions.", related: {"AI Alignment: Navigating Challenges": {type:"academic_talk", id:"acad_3", desc:"Dr. Reed's keynote on this"}}},
       // Add more from Dr. Reed's keywords
       "Metacognition": { desc: "Awareness and understanding of one's own thought processes." },
       "Uncertainty Quantification": {desc: "The science of characterizing and reducing uncertainties in computational and real-world applications."},
       "AGI Safety": { desc: "Research focused on ensuring Artificial General Intelligence benefits humanity."}
    };

    window.TAG_METADATA = window.TAG_METADATA || {}; 
    Object.assign(window.TAG_METADATA, {
      'AI Ethics': { category: 'skill', relatedProfiles: ['p_evelyn'] },
      'Cognitive Science': { category: 'skill', relatedProfiles: ['p_evelyn'] },
      'Algorithmic Bias': { category: 'skill', relatedProfiles: ['p_evelyn'] },
      'Explainable AI': { category: 'skill', relatedProfiles: ['p_evelyn'] },
      'AI Alignment': { category: 'skill', relatedProfiles: ['p_evelyn'] },
      'Responsible AI': { category: 'skill', relatedProfiles: ['p_evelyn'] },
      'Consulting': { category: 'item', relatedItems: ['item_consult_ethics'] }
    });
    
    // Ensure Dr. Reed's profile is processed like others if needed by original script
    window.CAFE_DB.profiles.forEach(profile => {
        profile.allow_multi = profile.allow_multi !== undefined ? profile.allow_multi : true; 
        let initialRole = 'attendee'; 
        if (profile.kind) { 
            switch(profile.kind) {
                case 'candidate': initialRole = 'candidate'; break;
                case 'vendor':    initialRole = 'vendor'; break;
                // Add other kinds if necessary
            }
        }
        profile.user_roles = profile.user_roles || [initialRole]; 
        profile.active_role = profile.active_role || profile.user_roles[0];

        // Consolidate highlights if they exist as 'skills' too
        let currentHighlights = [];
        if (profile.skills && Array.isArray(profile.skills)) { 
            currentHighlights = [...profile.skills]; 
        }
        if (profile.highlights && Array.isArray(profile.highlights)) {
            currentHighlights = [...new Set([...currentHighlights, ...profile.highlights])];
        }
        profile.highlights = currentHighlights; 
        delete profile.skills; 
    });

    // For the 1-1 pings demo, let's add a dummy profile for Dr. Reed to ping
    const dummyProfileForPings = { 
        id:"p_dummy_contact", kind:"candidate", name:"Dr. Alan Turing (Bot)", 
        avatar:"https://via.placeholder.com/80/777/fff?text=AT", title:"Historical AI Pioneer", 
        bio:"A placeholder contact for ping demonstration.", location:"History", 
        highlights:["Cryptography", "Early Computing"], interests:[], user_roles: ['candidate'], active_role: 'candidate', allow_multi: true 
    };
    if (!window.CAFE_DB.profiles.find(p => p.id === "p_dummy_contact")) {
        window.CAFE_DB.profiles.push(dummyProfileForPings);
    }
    window.CAFE_DB.messages.push(
        { id:"msg_reed_dummy1", thread_id: `p_dummy_contact_p_evelyn`, sender_id:"p_dummy_contact", receiver_id:"p_evelyn", text:"Hello Dr. Reed, fascinating work on AI ethics!", created_at: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString(), read_at: null, is_event_message: false },
        { id:"msg_reed_dummy2", thread_id: `p_dummy_contact_p_evelyn`, sender_id:"p_evelyn", receiver_id:"p_dummy_contact", text:"Thank you, Dr. Turing! Your foundational concepts are an inspiration.", created_at: new Date(Date.now() - 1000 * 60 * 60 * 4).toISOString(), read_at: new Date().toISOString(), is_event_message: false }
    );
     window.CAFE_DB.messages.push(
        { id:"soc_reed1", thread_id: "thread_social_global", sender_id:"p_evelyn", receiver_id:"thread_social_global", text:"Hello CafeCorner community! Looking forward to discussions on beneficial AI.", created_at: new Date(Date.now() - 1000 * 60 * 10).toISOString() }
    );

  </script>
  <script>
    const mainContentEl = document.getElementById('main');
    const navLinksEl = document.querySelectorAll('nav a'); 
    let sectionsEl; 
    const resetButtonEl = document.getElementById('reset-view-btn');
    const detailOverlayEl = document.getElementById('detail-overlay'); 
    const pingThreadModalEl = document.getElementById('ping-thread-modal'); 
    const pingMessagesContainerEl = document.getElementById('ping-messages-container');
    const sendPingFormEl = document.getElementById('send-ping-form');
    const pingThreadHeaderEl = document.getElementById('ping-thread-header');
    const closePingModalBtnEl = document.getElementById('close-ping-modal-btn');
    const pingUnreadBadgeEl = document.getElementById('ping-unread-badge');
    const fabNewListingEl = document.getElementById('fab-new-listing');

    const MOCK_LOGGED_IN_USER_ID = "p_evelyn"; // Dr. Reed is our user
    let CURRENT_USER; 

    const ROLES = ['candidate','recruiter','vendor','host','organizer','attendee'];
    const SOCIAL_THREAD_ID = 'thread_social_global';

    const eventBus = {
      listeners: {},
      on(evt, fn) {
        (this.listeners[evt] ||= []).push(fn);
      },
      emit(evt, payload) {
        (this.listeners[evt]||[]).forEach(fn=>fn(payload));
      }
    };

    const TAG_TYPES = {
      item: 'item', skill: 'bio', experience: 'bio', branding: 'bio',
      project: 'project', profile: 'profile', event: 'event', company: 'company',
      // Add types for academic timeline items if needed for tag clicks
      academic_publication: 'profile', // Treat as part of bio/profile for now
      academic_project: 'profile',
      academic_talk: 'profile',
      academic_event: 'profile', // Could also be 'event'
      academic_post: 'profile'
    };
    const FALLBACK_CARD = 'item';   

    let lastActiveTabId = 'items'; 
    let lastScrollPosition = 0;

    let profileTimelineObserver = null;
    let visibleTimelineItems = new Set();

    // Helper to get category config for Academic Timeline items (from React component)
    function getAcademicItemCategoryConfig(category) {
        const configs = {
          publications: { accentColor: '#4A5568', icon: 'üìÑ', label: 'Publications' },
          projects: { accentColor: '#2B6CB0', icon: 'üî¨', label: 'Research Projects' },
          talks: { accentColor: '#805AD5', icon: 'üí¨', label: 'Talks & Presentations' },
          events: { accentColor: '#38A169', icon: 'üìÖ', label: 'Workshops & Events' },
          posts: { accentColor: '#DD6B20', icon: 'üìù', label: 'Posts & Essays' },
        };
        return configs[category] || { accentColor: '#A0AEC0', icon: '‚Ä¢', label: 'Other Activity' };
    }


    function getCurrentActiveRole() {
        return CURRENT_USER ? CURRENT_USER.active_role : null;
    }
    function userHasRole(role) { 
        return CURRENT_USER && CURRENT_USER.user_roles && CURRENT_USER.user_roles.includes(role);
    }
    
    function dispatchRoleChangeEvent(newRole) {
        console.log(`Role changed to: ${newRole}. Dispatching event 'role:change'.`);
        window.dispatchEvent(new CustomEvent('role:change', { detail: newRole }));
        updateUserRoleSpecificUI(); 
    }
    
    function renderSidebar(){
      if (!CURRENT_USER) return;

      const me = CURRENT_USER;
      const myCardEl = document.getElementById('my-card');
      let myCardHTML = `<img src="${me.avatar}" alt="${me.name}" class="avatar-80" style="cursor:pointer;" onclick="showDetailPanel('profile', '${me.id}')"><h3>${me.name}</h3>
                        <p style="font-size:.85em">${me.title}</p>`;
      if (me.highlights && me.highlights.length > 0) {
          myCardHTML += `<div style="margin-top: 0.5rem;">
                            ${me.highlights.map(h => highlightPill(h, {type: 'skill', id: me.id})).join('')}
                         </div>`;
      }
      myCardEl.innerHTML = myCardHTML;
      hydratePills(myCardEl); 

      const rSwitch = ROLES.map(r=>{
         const checked = me.user_roles?.includes(r);
         const active  = me.active_role===r;
         return `<label style="display:block; cursor:pointer;">
            <input type="checkbox" data-role="${r}" ${checked?'checked':''}>
            <span style="font-weight:${active?'700':'400'}" data-role-span="${r}">${r.charAt(0).toUpperCase() + r.slice(1)}</span>
         </label>`;
      }).join('');
      document.getElementById('role-switcher').innerHTML = rSwitch;

      const multiAllRadio = document.querySelector('input[name="multi"][value="all"]');
      const multiOneRadio = document.querySelector('input[name="multi"][value="one"]');
      if (multiAllRadio && multiOneRadio) {
         if (me.allow_multi) multiAllRadio.checked = true;
         else multiOneRadio.checked = true;
      }
    }

    function updateUserRoleSpecificUI() {
        if (!CURRENT_USER) return;
        const newJobFormContainer = document.getElementById('new-job-form-container');
        if (newJobFormContainer) {
            const canPostJob = userHasRole('recruiter'); 
            newJobFormContainer.style.display = canPostJob ? 'block' : 'none';
            const newJobSummary = newJobFormContainer.querySelector('summary');
            if (newJobSummary) newJobSummary.title = canPostJob ? "" : "Must have Recruiter role to post a job.";
        }
        const newItemFormContainer = document.getElementById('new-item-form-container');
        if (newItemFormContainer) {
            const canListItems = userHasRole('vendor');
            newItemFormContainer.style.display = canListItems ? 'block' : 'none';
             const newItemSummary = newItemFormContainer.querySelector('summary');
            if (newItemSummary) newItemSummary.title = canListItems ? "" : "Must have Vendor role to list items.";
        }
        const myListingsButton = document.querySelector('.items-nav button[data-view="my"]');
        if (myListingsButton) {
            myListingsButton.style.display = userHasRole('vendor') ? 'inline-block' : 'none';
        }
        const itemsSection = document.getElementById('items');
        if (itemsSection && itemsSection.style.display !== 'none') {
            if (myListingsButton && myListingsButton.classList.contains('active') && !userHasRole('vendor')) {
                document.querySelector('.items-nav button[data-view="browse"]')?.click();
            }
        }
        const activeTabEl = document.querySelector('nav a.active');
        if (activeTabEl) {
            const activeTabId = activeTabEl.dataset.target;
            if (activeTabId === 'jobs') renderJobApp(); 
            if (activeTabId === 'items') { 
                 document.getElementById('items-search')?.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
        toggleFab();
    }

    const DEEP_DIVE_INFO_JS = { 
        "Generative AI": {"detail_title": "Generative AI Focus","detail_snippet": "Exploring cutting-edge models for content creation, problem-solving, and workflow automation.","inner_tags": {"Deep Learning": "Neural networks with many layers.","Creative Tech": "Tech for artistic expression.","LLMs": "Core of many GenAI systems."}},
        "Data Analysis": {"detail_title": "Data Analysis Pro", "detail_snippet": "Expert in analyzing data to extract insights."}
    };
    
    function generateThreadId(userId1, userId2) { 
        return [userId1, userId2].sort().join('_');
    }

    function addPingButtonHTML(targetId, options = {}) {
        if (!targetId || targetId === MOCK_LOGGED_IN_USER_ID) return ''; 

        const isEventPing = options.isEventPing || false;
        const text = options.text || (options.compact ? 'üí¨' : (isEventPing ? 'üí¨ Ping Event' : 'üí¨ Ping'));
        let btnClass = options.ghost ? 'ping-btn btn-ghost' : 'ping-btn';
        if (isEventPing) btnClass += ' ping-event-btn';

        let style = options.compact ? 'padding:0.1rem 0.3rem; font-size:0.8em; margin-left:5px; vertical-align:middle;' : 'font-size:0.8em; padding:0.2rem 0.5rem; margin-left:5px; vertical-align:middle;';
        if (options.additionalStyle) style += options.additionalStyle;

        const threadIdForButton = isEventPing ? targetId : generateThreadId(MOCK_LOGGED_IN_USER_ID, targetId);
        const receiverIdForButton = targetId;

        const dataAttribute = `data-thread-id="${threadIdForButton}" data-is-event="${isEventPing}" data-receiver-id="${receiverIdForButton}"`;
        const title = isEventPing ? `Ping everyone in ${options.targetName || 'Event'}` : `Ping ${options.targetName || 'user'}`;

        return `<button class="${btnClass}" ${dataAttribute} style="${style}" title="${title}">${text}</button>`;
    }
    
    function renderMessagesInModal(threadId, headerText, isEventThread) {
        pingMessagesContainerEl.innerHTML = '';
        pingThreadHeaderEl.textContent = headerText;
        const messagesForThread = window.CAFE_DB.messages
            .filter(msg => msg.thread_id === threadId)
            .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        if (messagesForThread.length === 0) {
            pingMessagesContainerEl.innerHTML = '<p class="ping-message zero">No messages yet.<br/>Be the first to say hi üëã</p>';
            sendPingFormEl.ping_text_form_input.placeholder = "Be the first to say hi üëã";
        } else {
            sendPingFormEl.ping_text_form_input.placeholder = "Type your message...";
            messagesForThread.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.classList.add('ping-message');
                msgDiv.classList.toggle('sent', msg.sender_id === MOCK_LOGGED_IN_USER_ID);
                msgDiv.classList.toggle('received', msg.sender_id !== MOCK_LOGGED_IN_USER_ID);
                if (isEventThread && msg.sender_id !== MOCK_LOGGED_IN_USER_ID) {
                    const senderProfile = window.CAFE_DB.profiles.find(p => p.id === msg.sender_id);
                    const senderNameDiv = document.createElement('div');
                    senderNameDiv.className = 'sender-name';
                    senderNameDiv.textContent = senderProfile ? senderProfile.name : 'Unknown Sender';
                    msgDiv.appendChild(senderNameDiv);
                }
                const textNode = document.createElement('span');
                textNode.textContent = msg.text;
                msgDiv.appendChild(textNode);
                const timestampNode = document.createElement('span');
                timestampNode.className = 'timestamp';
                timestampNode.textContent = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                msgDiv.appendChild(timestampNode);
                pingMessagesContainerEl.appendChild(msgDiv);
            });
        }
        pingMessagesContainerEl.scrollTop = pingMessagesContainerEl.scrollHeight;
        if (typeof feather !== 'undefined') feather.replace();
    }

    function openPingThread(threadId, isEventThread = false) {
        let headerText, receiverIdForForm;
        const threadIdToUse = threadId; 

        if (isEventThread) {
            const eventStage = window.CAFE_DB.stages.find(s => s.id === threadId && s.type === 'event');
            if (!eventStage) { console.error("Event for ping not found:", threadId); return; }
            headerText = `Event Chat: ${eventStage.title}`;
            receiverIdForForm = threadId; 
        } else {
            const participantIds = threadId.split('_');
            const otherUserId = participantIds.find(id => id !== MOCK_LOGGED_IN_USER_ID);
            const targetProfile = window.CAFE_DB.profiles.find(p => p.id === otherUserId);

            if (!targetProfile) { console.error("Target profile for 1-1 ping not found from threadId:", threadId, "derived otherUserId:", otherUserId); return; }
            headerText = `Chat with ${targetProfile.name}`;
            receiverIdForForm = targetProfile.id; 

            window.CAFE_DB.messages.forEach(msg => {
                if (msg.thread_id === threadId && msg.receiver_id === MOCK_LOGGED_IN_USER_ID && !msg.read_at) {
                    msg.read_at = new Date().toISOString();
                }
            });
        }

        sendPingFormEl.ping_thread_id_form_input.value = threadIdToUse;
        sendPingFormEl.ping_receiver_id_form_input.value = receiverIdForForm; 

        renderMessagesInModal(threadIdToUse, headerText, isEventThread);
        pingThreadModalEl.classList.add('show');
        pingThreadModalEl.style.display = 'block';
        sendPingFormEl.ping_text_form_input.focus();
        updateUnreadPingBadge(); 
    }

    function handleSendPing(event) {
        event.preventDefault();
        const threadId = sendPingFormEl.ping_thread_id_form_input.value;
        const receiverContextId = sendPingFormEl.ping_receiver_id_form_input.value; 
        const text = sendPingFormEl.ping_text_form_input.value.trim();
        if (!text || !threadId || !receiverContextId) return;
        
        const isEventMessage = receiverContextId.startsWith('s_'); 
        
        const newMessage = {
            id: `m_${crypto.randomUUID().slice(0,8)}`,
            thread_id: threadId,
            sender_id: MOCK_LOGGED_IN_USER_ID,
            receiver_id: receiverContextId, 
            text: text,
            created_at: new Date().toISOString(),
            read_at: null, 
            is_event_message: isEventMessage 
        };
        window.CAFE_DB.messages.push(newMessage);

        if (isEventMessage) {
            const eventStage = window.CAFE_DB.stages.find(s => s.id === receiverContextId && s.type === 'event');
            console.log(`%c[EVENT PING] Message to ${eventStage?.title || receiverContextId}: "${text}" by ${MOCK_LOGGED_IN_USER_ID}`, "color: green;");
            renderMessagesInModal(threadId, `Event Chat: ${eventStage?.title}`, true);
        } else {
            const receiverProfile = window.CAFE_DB.profiles.find(p => p.id === receiverContextId);
            console.log(`%c[1-to-1 PING] Email to ${receiverProfile?.name || receiverContextId}: "${MOCK_LOGGED_IN_USER_ID} sent: ${text}"`, "color: blue;");
            renderMessagesInModal(threadId, `Chat with ${receiverProfile?.name || 'User'}`, false);
        }
        sendPingFormEl.ping_text_form_input.value = '';
        updateUnreadPingBadge(); 
    }
    
    function updateUnreadPingBadge() {
        let unreadCount = 0;
        const unreadThreads = new Set();
        window.CAFE_DB.messages.forEach(msg => {
            if (!msg.is_event_message && msg.receiver_id === MOCK_LOGGED_IN_USER_ID && !msg.read_at) {
                unreadThreads.add(msg.thread_id);
            }
        });
        unreadCount = unreadThreads.size;

        if (unreadCount > 0) {
            pingUnreadBadgeEl.textContent = unreadCount;
            pingUnreadBadgeEl.style.display = 'inline-block';
        } else {
            pingUnreadBadgeEl.style.display = 'none';
        }
    }

    if(sendPingFormEl) sendPingFormEl.addEventListener('submit', handleSendPing);
    if(closePingModalBtnEl) closePingModalBtnEl.addEventListener('click', () => {
        pingThreadModalEl.classList.remove('show');
        pingThreadModalEl.style.display = 'none';
    });
    
    function renderPingThreadList(){
      const listDiv = document.getElementById('ping-thread-list');
      if (!listDiv) return; 
      const byThread = Object.groupBy(window.CAFE_DB.messages.filter(m => m.thread_id !== SOCIAL_THREAD_ID), m => m.thread_id);
      const ordered = Object.entries(byThread)
        .sort((a,b)=>new Date(b[1].at(-1).created_at) - new Date(a[1].at(-1).created_at));
      
      listDiv.innerHTML = ordered.map(([tid,msgs])=>{
          const last = msgs.at(-1);
          const unread = msgs.some(m => m.receiver_id === MOCK_LOGGED_IN_USER_ID && !m.read_at && !m.is_event_message);
          
          let label;
          if (tid.startsWith('s_')) { 
              label = window.CAFE_DB.stages.find(s=>s.id===tid)?.title || 'Event';
          } else { 
              const participantIds = tid.split('_');
              const otherUserId = participantIds.find(id => id !== MOCK_LOGGED_IN_USER_ID);
              label = window.CAFE_DB.profiles.find(p=>p.id===otherUserId)?.name || 'User';
          }

          return `<div class="thread-row" data-thread-id="${tid}">
            <span>${label}</span>
            <small>${new Date(last.created_at).toLocaleString()}</small>
            ${unread?'<span class="cc-pill small">new</span>':''}
          </div>`;
        }).join('') || '<p style="font-style:italic; text-align:center; padding:1rem;">No conversations yet.</p>';
    }

    function renderSocial(){
        const profileCardsContainer = document.getElementById('social-profile-cards-container');
        if (profileCardsContainer) {
            profileCardsContainer.innerHTML = window.CAFE_DB.profiles
                .map(profile => renderProfileCard(profile)) 
                .join('');
        }

        const box=document.getElementById('social-messages');
        if (!box) return; 
        const msgs=window.CAFE_DB.messages
                        .filter(m=>m.thread_id===SOCIAL_THREAD_ID)
                        .sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
        box.innerHTML=msgs.map(m=>{
            const mine=m.sender_id===MOCK_LOGGED_IN_USER_ID;
            const p=window.CAFE_DB.profiles.find(x=>x.id===m.sender_id);
            return `<div class="ping-message ${mine?'sent':'received'}"> ${
                     !mine?`<span class="sender-name">${p?.name||'???'}</span>`:''}${m.text}
                     <span class="timestamp">${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></div>`;
        }).join('') || '<p class="ping-message zero">No messages yet. Be first!</p>';
        box.scrollTop=box.scrollHeight;

        if (typeof feather !== 'undefined') feather.replace();
    }

    const socialSendForm = document.getElementById('social-send');
    if (socialSendForm) {
        socialSendForm.onsubmit = e => {
            e.preventDefault();
            const txtInput = e.target.txt;
            const txt = txtInput.value.trim();
            if(!txt) return;
            window.CAFE_DB.messages.push({
                id:`m_${crypto.randomUUID().slice(0,8)}`,
                thread_id:SOCIAL_THREAD_ID,
                sender_id:MOCK_LOGGED_IN_USER_ID,
                receiver_id:SOCIAL_THREAD_ID, 
                text:txt, created_at:new Date().toISOString()
            });
            e.target.reset(); 
            renderSocial(); 
            txtInput.focus(); 
        };
    }

    function highlightPill(tag, options = {}) {
      const info = window.HIGHLIGHT_KB[tag] || {};
      let tagType = options.type || determineTagType(tag);
      if (!tagType && info.related) { 
          const firstRelatedKey = Object.keys(info.related)[0];
          if (firstRelatedKey && info.related[firstRelatedKey] && info.related[firstRelatedKey].type) {
              tagType = info.related[firstRelatedKey].type; 
          }
      }
      tagType = tagType || 'skill'; 
      const dataId = options.id || generateIdFromTag(tag, tagType); 

      return `<span class="cc-pill tag-interactive"
              data-type="${tagType}"
              data-id="${dataId}"
              data-tag="${tag}"
              tabindex="0">
          ${tag}
          ${info.desc || info.related ? `
            <div class="detail-popout">
              <strong>${tag}</strong>
              ${info.desc ? `<span class="context-snippet">${info.desc}</span>` : ''}
              ${info.related ? `<div class="related-tags">${
                Object.entries(info.related).map(([label, obj]) => `
                  <span class="inner-tag"
                        data-type="${obj.type}"
                        data-id="${obj.id}"
                        tabindex="0">
                    ${label}
                    ${obj.desc || obj.buy ? `
                      <div class="deep-detail-popout">
                        ${obj.desc ? `<p>${obj.desc}</p>` : ''}
                        ${obj.buy ? `<a href="${obj.buy}" target="_blank">Buy ‚Üó</a>` : ''}
                      </div>
                    ` : ''}
                  </span>
                `).join('')
              }</div>` : ''}
            </div>
          ` : ''}
        </span>`;
    }

    function determineTagType(tag) {
      if (window.TAG_METADATA && window.TAG_METADATA[tag]) {
        return window.TAG_METADATA[tag].category; 
      }
      const kbEntry = window.HIGHLIGHT_KB[tag];
      if (kbEntry && kbEntry.related) {
        const firstRelated = Object.values(kbEntry.related)[0];
        if (firstRelated && firstRelated.type) {
          if (firstRelated.type === 'profile') return 'skill'; 
          if (TAG_TYPES[firstRelated.type]) return firstRelated.type;
        }
      }
      if (window.CAFE_DB.items.some(i => (i.tags || []).includes(tag) || i.title.toLowerCase().includes(tag.toLowerCase()))) return 'item';
      if (window.CAFE_DB.projects.some(p => (p.tech_stack || []).includes(tag) || p.title.toLowerCase().includes(tag.toLowerCase()))) return 'project';
      if (window.CAFE_DB.stages.some(s => s.type === 'event' && ((s.tags || []).includes(tag) || s.title.toLowerCase().includes(tag.toLowerCase())))) return 'event';
      if (window.CAFE_DB.companies.some(c => (c.tags || []).includes(tag) || c.name.toLowerCase().includes(tag.toLowerCase()))) return 'company';
      if (window.CAFE_DB.profiles.some(p => (p.highlights || []).includes(tag))) return 'skill'; 
      const brandingKeywords = ["friendly", "owned", "certified", "focused"];
      if (brandingKeywords.some(kw => tag.toLowerCase().includes(kw))) return 'branding';
      return 'skill'; 
    }

    function generateIdFromTag(tag, determinedType) {
      if (determinedType === 'item') {
        const item = window.CAFE_DB.items.find(i => (i.tags || []).includes(tag) || i.title.toLowerCase() === tag.toLowerCase());
        if (item) return item.id;
      }
      if (determinedType === 'project') {
        const project = window.CAFE_DB.projects.find(p => (p.tech_stack || []).includes(tag) || p.title.toLowerCase() === tag.toLowerCase());
        if (project) return project.id;
      }
      if (determinedType === 'event') {
        const event = window.CAFE_DB.stages.find(s => s.type === 'event' && ((s.tags || []).includes(tag) || s.title.toLowerCase() === tag.toLowerCase()));
        if (event) return event.id;
      }
      if (determinedType === 'company') {
        const company = window.CAFE_DB.companies.find(c => (c.tags || []).includes(tag) || c.name.toLowerCase() === tag.toLowerCase());
        if (company) return company.id;
      }
      if (['skill', 'branding', 'experience'].includes(determinedType)) {
        const profile = window.CAFE_DB.profiles.find(p => (p.highlights || []).includes(tag));
        if (profile) return profile.id;
        if (window.TAG_METADATA && window.TAG_METADATA[tag] && window.TAG_METADATA[tag].relatedProfiles && window.TAG_METADATA[tag].relatedProfiles.length > 0) {
            return window.TAG_METADATA[tag].relatedProfiles[0]; 
        }
      }
      // For academic timeline items, the ID might be directly from the item
      if (determinedType && determinedType.startsWith('academic_')) {
          const profile = window.CAFE_DB.profiles.find(p => p.id === MOCK_LOGGED_IN_USER_ID); // Assuming these tags relate to the logged-in user
          if (profile && profile.academicTimeline) {
              const academicItem = profile.academicTimeline.find(item => item.title === tag || (item.keywords && item.keywords.includes(tag)));
              if (academicItem) return academicItem.id;
          }
      }
      return `generated_${tag.toLowerCase().replace(/\s+/g, '_')}`;
    }

    function hydratePills(root = document) {
      root.querySelectorAll('.cc-pill.tag-interactive:not([data-ready])')
        .forEach(pill => {
          pill.dataset.ready = '1'; 
          pill.addEventListener('click', e => {
            if (e.target === pill || e.target.parentNode === pill && !e.target.matches('div, span.inner-tag')) {
                e.stopPropagation(); 
                e.preventDefault();  
                const type = pill.dataset.type;
                const id = pill.dataset.id;
                const tag = pill.dataset.tag;
                console.log('[hydratePills] Pill clicked:', { type, id, tag, el: pill });
                eventBus.emit('pill:click', { type, id, tag, el: pill });
            }
          });
          pill.querySelectorAll('.inner-tag').forEach(innerTag => {
            if (innerTag.dataset.ready !== '1') { 
                innerTag.dataset.ready = '1';
                innerTag.addEventListener('click', e => {
                    e.stopPropagation(); 
                    e.preventDefault();
                    const type = innerTag.dataset.type;
                    const id = innerTag.dataset.id;
                    const tagText = innerTag.textContent.trim().split('\n')[0].trim(); 
                    console.log('[hydratePills] Inner tag clicked:', { type, id, tag: tagText, el: innerTag });
                    eventBus.emit('pill:click', { type, id, tag: tagText, el: innerTag });
                });
            }
          });
        });
    }

    function showCardByTag({ type, id, tag, el }) { 
      console.log(`[showCardByTag] Received: type=${type}, id=${id}, tag='${tag}'`);
      const cardKind = TAG_TYPES[type] || FALLBACK_CARD; 
      console.log(`[showCardByTag] Mapped data-type '${type}' to cardKind '${cardKind}'`);
      if (cardKind === 'bio' || type.startsWith('academic_')) { // Handle academic tags to show profile
        let profileToView = window.CAFE_DB.profiles.find(p => p.id === id);
        if (!profileToView && tag) { 
            profileToView = window.CAFE_DB.profiles.find(p => (p.highlights || []).map(h => h.toLowerCase()).includes(tag.toLowerCase()));
        }
        if (!profileToView && id && id.startsWith('generated_') && tag) {
            const inferredProfile = window.CAFE_DB.profiles.find(p => (p.highlights || []).map(h => h.toLowerCase()).includes(tag.toLowerCase()));
            if (inferredProfile) profileToView = inferredProfile;
        }
         // If an academic item ID was passed, ensure we show Dr. Reed's profile
        if (type.startsWith('academic_') && id && id.startsWith('acad_')) {
            profileToView = window.CAFE_DB.profiles.find(p => p.id === MOCK_LOGGED_IN_USER_ID);
        }

        if (profileToView) {
          console.log(`[showCardByTag] Showing 'bio' (profile) card for ID: ${profileToView.id} (found via tag: ${tag} or academic item)`);
          showDetailPanel('profile', profileToView.id);
          // If it's an academic item, try to auto-select it in the timeline
          if (type.startsWith('academic_') && id && id.startsWith('acad_')) {
              setTimeout(() => {
                  const navLink = detailOverlayEl.querySelector(`.profile-timeline-nav a[data-timeline-item-id="${id}"]`);
                  if (navLink) navLink.click();
              }, 100); // Small delay for panel to render
          }
        } else {
          console.warn(`[showCardByTag] Profile not found for bio-type tag '${tag}' or id '${id}'. Cannot show detail.`);
        }
        return;
      }
      if (id && !id.startsWith('generated_')) { 
        console.log(`[showCardByTag] Using handleJump for cardKind '${cardKind}' with ID '${id}'`);
        handleJump(cardKind, id);
      } else {
        console.warn(`[showCardByTag] Cannot show card for type '${type}' (kind '${cardKind}') with generic or missing ID: '${id}'. Tag: '${tag}'.`);
      }
    }

    function renderProfileCard(profile) {
        if (!profile) {
            console.error("renderProfileCard received undefined profile");
            return '';
        }
        const stageInvolvementCount = window.CAFE_DB.stages.filter(stage =>
            Object.values(stage.slots || {}).some(slotArray => slotArray && slotArray.includes(profile.id)) ||
            (stage.type === 'job' && stage.posted_by === profile.id) ||
            (stage.job_applications && stage.job_applications.some(app => app.candidate_id === profile.id))
        ).length;
        const highlightsHTML = (profile.highlights || []).map(h => highlightPill(h, { type: 'skill', id: profile.id })).join(''); 
        let interestsHTML = (profile.interests && Array.isArray(profile.interests) ? profile.interests : [])
                                .map(interest => `<span class="cc-pill">${interest}</span>`).join('');
        const cardClass = profile.user_roles?.includes('candidate') ? 'profile-card' : '';
        const roleClass = profile.active_role ? `profile-active-role-${profile.active_role}` : ''; 
        const hasEndorsed = window.CAFE_DB.endorsements.some(e => e.targetId === profile.id && e.actorId === MOCK_LOGGED_IN_USER_ID && e.type === '‚ô•');
        const endorseBtnClass = hasEndorsed ? 'endorse-btn active' : 'endorse-btn';
        const displayName = profile.allow_multi === false && profile.active_role ?
                            `${profile.name} <small>(${profile.active_role})</small>` :
                            profile.name;
        const mbtiButtonHTML = (profile.id === MOCK_LOGGED_IN_USER_ID) ?
            `<button class="btn mbti-btn" style="margin-top:0.5rem; font-size:0.8em; padding: 0.3rem 0.7rem;"><i data-feather="coffee" style="width:1em; height:1em;"></i> What Coffee Am I?</button>
             <span class="mbti-badge cc-pill" style="display:none;margin-left:.5rem;"></span>` : '';
        return `
            <div class="${cardClass} card-shell ${roleClass}" id="profile-card-${profile.id}" data-profile-id="${profile.id}">
                <label style="cursor:pointer; flex-shrink:0;">
                    <img src="${profile.avatar || 'https://via.placeholder.com/80/ccc/000?text=??'}" alt="${profile.name || 'Unknown Name'}" class="avatar-80">
                </label>
                <div class="card-content">
                    <h3 style="display:flex; align-items:center; justify-content:space-between;">
                        <span>${displayName || 'Unnamed Profile'}</span>
                        <div>
                           ${addPingButtonHTML(profile.id, { targetName: profile.name, additionalStyle: 'margin-right:5px;' })}
                           <button class="${endorseBtnClass}" data-target-id="${profile.id}" title="Endorse ${profile.name}">‚ô•</button>
                        </div>
                    </h3>
                    <p><em>${profile.title || 'No title'}</em></p>
                    ${profile.bio ? `<p style="font-size:0.9em; max-height: 5.4em; overflow:hidden; text-overflow:ellipsis;">${profile.bio}</p>` : ''}
                    ${profile.location ? `<p style="font-size:0.85em;"><i data-feather="map-pin" style="width:0.9em;height:0.9em;vertical-align:middle;"></i> ${profile.location}</p>` : ''}
                    ${highlightsHTML ? `<div class="data-section"><span class="label">Highlights:</span>${highlightsHTML}</div>`:''}
                    ${interestsHTML && profile.user_roles?.includes('candidate') ? `<div class="data-section" style="margin-top:0.3rem;"><span class="label" style="font-size:0.8em;">Interests:</span><div style="margin-top:0.1rem;">${interestsHTML}</div></div>` : ''}
                    ${profile.profileUrl && profile.profileUrl !== '#' ? `<a href="${profile.profileUrl}" target="_blank" style="font-size:0.85em; color:var(--cc-primary); display: inline-block; margin-top:0.4rem;">View Profile</a>` : ''}
                    ${stageInvolvementCount > 0 ? `<div style="margin-top:0.4rem;"><span class="cc-pill small">üîó In ${stageInvolvementCount} Stage${stageInvolvementCount > 1 ? 's' : ''}</span></div>` : ''}
                    <div class="why-match" style="display:none; font-size:0.85em; margin-top:0.4rem;"></div>
                    ${mbtiButtonHTML}
                </div>
            </div>
        `;
    }
    
    function buildStageInvolvementTreeHTML(stage, excludeProfileId=null){
      const roleDisplayNames={hosts:'Host(s)',organizers:'Organizer(s)',vendors:'Featured Vendor(s)',attendees:'Attendee(s)',candidates:'Participant(s)',recruiters:'Recruiter(s)'};
      const order=['hosts','organizers','vendors','attendees','candidates','recruiters'];
      const root=document.createElement('ul');
      order.forEach(role=>{
        const ids=stage.slots[role]||[];
        const remainingIds=excludeProfileId?ids.filter(pid=>pid!==excludeProfileId):ids;
        if(!remainingIds.length) return;
        const li=document.createElement('li');
        li.innerHTML=`<strong>${roleDisplayNames[role]||role}:</strong>`;
        const ul=document.createElement('ul');
        remainingIds.forEach(pid=>{
          const p=window.CAFE_DB.profiles.find(x=>x.id===pid);
          if(!p) return;
          const liInner=document.createElement('li');
          const suffix=p.allow_multi===false&&p.active_role?` <small>(${p.active_role})</small>`:'';
          liInner.innerHTML=`<a href="#" class="profile-link" data-profile-id="${p.id}">${p.name}${suffix}</a>`; 
          ul.appendChild(liInner);
        });
        li.appendChild(ul);
        root.appendChild(li);
      });
      return root.children.length?root:null;
    }

    function buildCompanyInvolvementTreeHTML(coId){
      const root=document.createElement('ul');
      const co=window.CAFE_DB.companies.find(c=>c.id===coId);
      if(!co) return null;
      (co.people||[]).forEach(pid=>{ const p=window.CAFE_DB.profiles.find(x=>x.id===pid);
         if(p) root.innerHTML+=`<li>üë§ <a href="#" data-jump-type="profile" data-jump-id="${p.id}">${p.name}</a></li>`; });
      (co.projects||[]).forEach(prid=>{ const pr=window.CAFE_DB.projects.find(x=>x.id===prid);
         if(pr) root.innerHTML+=`<li>üöÄ <a href="#" data-jump-type="project" data-jump-id="${pr.id}">${pr.title}</a></li>`; });
      (co.items||[]).forEach(iid=>{ const it=window.CAFE_DB.items.find(x=>x.id===iid);
         if(it) root.innerHTML+=`<li>üõçÔ∏è <a href="#" data-jump-type="item" data-jump-id="${it.id}">${it.title}</a></li>`; });
      return root.children.length?root:null;
    }


    function renderStageSlots(stageId) { 
        const stage = window.CAFE_DB.stages.find(s => s.id === stageId && s.type === 'event');
        if (!stage) return;
        const stageCardEl = document.getElementById(`stage-card-${stageId}`);
        if (!stageCardEl) return;
        const slotsMapping = [
            { key: 'hosts',      title: 'Host(s)',         containerClass: 'stage-slots-hosts' },
            { key: 'organizers', title: 'Organizer(s)',    containerClass: 'stage-slots-organizers' },
            { key: 'vendors',    title: 'Featured Vendors',containerClass: 'stage-slots-vendors' },
            { key: 'attendees',  title: 'Attendees',       containerClass: 'stage-slots-attendees' }, 
            { key: 'candidates', title: 'Participants',    containerClass: 'stage-slots-candidates' },
            { key: 'recruiters', title: 'Recruiters',      containerClass: 'stage-slots-recruiters' }
        ];
        slotsMapping.forEach(mapInfo => {
            const slotContainer = stageCardEl.querySelector(`.${mapInfo.containerClass}`);
            if (slotContainer) {
                slotContainer.innerHTML = ''; 
                const profileIdsInSlot = stage.slots[mapInfo.key] || [];
                if (profileIdsInSlot.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'stage-slots-list';
                     if (mapInfo.key === 'attendees') {ul.style.display = 'flex'; ul.style.flexWrap = 'wrap';}
                    profileIdsInSlot.forEach(profileId => {
                        const profile = window.CAFE_DB.profiles.find(p => p.id === profileId);
                        if (profile) {
                            const nameSuffix = profile.allow_multi === false && profile.active_role ? ` <small>(${profile.active_role})</small>` : '';
                            const li = document.createElement('li');
                            if (mapInfo.key === 'attendees') {
                                li.innerHTML = `<span class="cc-pill profile-link" data-profile-id="${profile.id}" style="cursor:pointer; display:inline-flex; align-items:center;">
                                                  ${profile.name}${nameSuffix}
                                                  ${addPingButtonHTML(profile.id, { compact: true, targetName: profile.name })}
                                                </span>`;
                            } else { 
                                 li.innerHTML = `<a href="#" class="profile-link" data-profile-id="${profile.id}">${profile.name}${nameSuffix}</a>
                                                 <span style="font-size:0.8em; color:#777; margin-left: 4px;">(${profile.active_role || 'N/A'})</span>
                                                 ${addPingButtonHTML(profile.id, { compact: true, targetName: profile.name, additionalStyle: 'font-size:0.9em;' })}`;
                            }
                            ul.appendChild(li);
                        }
                    });
                    slotContainer.appendChild(ul);
                } else {
                    let placeholderText = `No ${mapInfo.title.toLowerCase().replace(/\(s\)/,'').replace('featured ','')} listed yet.`;
                    slotContainer.innerHTML = `<p style="font-size:0.85em; font-style:italic; margin:0.2rem 0;">${placeholderText}</p>`;
                }
            }
        });
        const treeHolder = stageCardEl.querySelector(`.event-involvement-tree-placeholder[data-stage-id="${stageId}"]`);
        if (treeHolder) {
            treeHolder.innerHTML = ''; 
            const tree = buildStageInvolvementTreeHTML(stage);
            const detailsParent = treeHolder.closest('details.involvement-tree');
            if (tree) {
                treeHolder.appendChild(tree);
                if(detailsParent) detailsParent.style.display = '';
            } else {
                if(detailsParent) detailsParent.style.display = 'none';
            }
        }
         if (typeof feather !== 'undefined') feather.replace();
    }
    
    function renderEventCard(eventStage) {
        const tagsHTML = (eventStage.tags || []).map(tag => highlightPill(tag)).join('');
        let joinButtonHTML = `<button class="btn join-btn" data-stage-id="${eventStage.id}">+ Add My Profile to Event</button>`;
        if (CURRENT_USER) { 
            const currentRole = CURRENT_USER.active_role;
            let targetSlotKey;
            if (['vendor', 'host', 'organizer', 'recruiter'].includes(currentRole)) {
                targetSlotKey = currentRole + 's'; 
            } else if (currentRole === 'candidate') { 
                 targetSlotKey = 'attendees';
            } else { 
                targetSlotKey = 'attendees'; 
            }
            if (eventStage.slots[targetSlotKey] && eventStage.slots[targetSlotKey].includes(CURRENT_USER.id)) {
                joinButtonHTML = `<button class="btn join-btn" data-stage-id="${eventStage.id}" disabled>‚úì Added as ${currentRole}</button>`;
            } else if (Object.values(eventStage.slots).flat().includes(CURRENT_USER.id)) {
                const existingRole = Object.entries(eventStage.slots).find(([key, ids]) => ids.includes(CURRENT_USER.id))?.[0].slice(0, -1);
                joinButtonHTML = `<button class="btn join-btn" data-stage-id="${eventStage.id}" disabled>‚úì Added as ${existingRole || 'participant'}</button>`;
            }
        }
        const hasEndorsedEvent = window.CAFE_DB.endorsements.some(e => e.targetId === eventStage.id && e.actorId === MOCK_LOGGED_IN_USER_ID && e.type === '‚ô•');
        const endorseEventBtnClass = hasEndorsedEvent ? 'endorse-btn active' : 'endorse-btn';
        let pingOrganizersButtonHTML = '';
        const mainOrganizerId = eventStage.slots.organizers && eventStage.slots.organizers[0];
        const mainOrganizer = mainOrganizerId ? window.CAFE_DB.profiles.find(p => p.id === mainOrganizerId) : null;
        if (mainOrganizer) {
            pingOrganizersButtonHTML = addPingButtonHTML(mainOrganizer.id, { ghost: true, compact: true, targetName: mainOrganizer.name, additionalStyle: 'font-size:1.2em;' });
        }
        const pingEventButton = addPingButtonHTML(eventStage.id, { isEventPing: true, targetName: eventStage.title });
        return `
            <li class="card-shell" id="stage-card-${eventStage.id}" data-stage-id="${eventStage.id}" data-stage-type="event">
              <div class="card-content" style="width:100%;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <strong>${eventStage.title}</strong>
                    <div style="white-space:nowrap;">
                        ${pingOrganizersButtonHTML}
                        <button class="${endorseEventBtnClass}" data-target-id="${eventStage.id}" data-ctx-id="${eventStage.id}" title="Endorse this event">‚ô•</button>
                    </div>
                </div>
                <p style="font-size:0.9em; color:#555;">
                    Date: ${eventStage.date} (${eventStage.time || 'Time TBD'})<br>
                    Location: ${eventStage.locationName || 'Location TBD'}
                </p>
                <p>${eventStage.description || 'No description available.'}</p>
                ${tagsHTML ? `<div style="margin-top: 0.5rem; margin-bottom: 0.5rem;">${tagsHTML}</div>` : ''}
                <details open>
                    <summary>Participants & Roles</summary>
                    <ul>
                        <li><strong>Host(s):</strong> <div class="stage-slots-hosts"></div></li>
                        <li><strong>Organizer(s):</strong> <div class="stage-slots-organizers"></div></li>
                        <li><strong>Featured Vendors:</strong> <div class="stage-slots-vendors"></div></li>
                        <li><strong>Recruiter(s):</strong> <div class="stage-slots-recruiters"></div></li>
                        <li><strong>Attendees:</strong> <div class="stage-slots-attendees"></div></li>
                    </ul>
                </details>
                <details class="involvement-tree" open style="margin-top: 0.8rem;">
                  <summary>Stage Involvement Graph (All Participants)</summary>
                  <div class="event-involvement-tree-placeholder" data-stage-id="${eventStage.id}">
                  </div>
                </details>
                ${pingEventButton}
                ${eventStage.websiteUrl && eventStage.websiteUrl !== '#' ? `<a href="${eventStage.websiteUrl}" target="_blank" class="btn">View Event Details</a>` : ''}
                ${joinButtonHTML}
                <form class="mini-comment-form" data-ctx-id="${eventStage.id}" style="margin-top: 0.8rem;">
                  <input name="comment" maxlength="120" placeholder="Say hi about this event‚Ä¶">
                  <button type="submit" class="btn" style="font-size:0.8em; padding: 0.2rem 0.6rem; margin-top:0.2rem;">Comment</button>
                </form>
              </div>
            </li>
        `;
    }

    function renderJobCard(job) { 
        const skillsHTML = (job.skills || []).map(skill => highlightPill(skill)).join(''); 
        const postedByProfile = window.CAFE_DB.profiles.find(p => p.id === job.posted_by);
        let applyButtonHTML;
        const alreadyApplied = CURRENT_USER && job.job_applications && job.job_applications.some(app => app.candidate_id === CURRENT_USER.id);
        const canApply = CURRENT_USER && (CURRENT_USER.active_role === 'candidate' || (CURRENT_USER.allow_multi && CURRENT_USER.user_roles.includes('candidate')));
        if (alreadyApplied) {
            applyButtonHTML = `<button class="btn apply-btn" data-stage-id="${job.id}" disabled>‚úì Applied</button>`;
        } else if (canApply) {
            applyButtonHTML = `<button class="btn apply-btn" data-stage-id="${job.id}">Apply <i data-feather="send" style="width:1em;height:1em;"></i></button>`;
        } else {
            applyButtonHTML = `<button class="btn apply-btn" data-stage-id="${job.id}" disabled title="Switch to 'candidate' role to apply">Apply</button>`;
        }
        const applicants = job.job_applications || [];
        let applicantsHTML = '<p style="font-size:0.85em; font-style:italic; margin:0.2rem 0;">No applicants yet.</p>';
        if (applicants.length > 0) {
            applicantsHTML = '<ul class="stage-slots-list" style="flex-direction:column; align-items: flex-start;">';
            applicants.forEach(app => {
                const candidateProfile = window.CAFE_DB.profiles.find(p => p.id === app.candidate_id);
                if (candidateProfile) {
                    applicantsHTML += `<li>
                        <a href="#" class="profile-link" data-profile-id="${candidateProfile.id}">${candidateProfile.name}</a>
                        ${addPingButtonHTML(candidateProfile.id, { compact: true, targetName: candidateProfile.name, additionalStyle: 'font-size:0.9em;' })}
                    </li>`;
                }
            });
            applicantsHTML += '</ul>';
        }
        const recruiterPingButton = postedByProfile ? addPingButtonHTML(postedByProfile.id, {compact:true, text:'Ping Recruiter', targetName: postedByProfile.name}) : '';
        return `
            <div class="inquiry">
                <div class="inquiry-card card-shell" id="stage-card-${job.id}" data-stage-id="${job.id}" data-stage-type="job">
                    <div class="card-content" style="width:100%;">
                        <h4>${job.title}</h4>
                        <p><em>by ${postedByProfile ? `<a href="#" class="profile-link" data-profile-id="${postedByProfile.id}">${postedByProfile.name}</a>` : (job.clientName || 'Recruiter')}</em> ${recruiterPingButton}</p>
                        <p>${job.description || 'No description.'}</p>
                        ${skillsHTML ? `<p><span class="label">Skills Required:</span> ${skillsHTML}</p>` : ''}
                        <p><strong>Status:</strong> ${job.status || 'Unknown'}</p>
                        <div style="margin-top:0.5rem;">
                            <strong>Applicants (${applicants.length}):</strong>
                            <div class="stage-slots-candidates" style="margin-top:0.2rem;">
                                ${applicantsHTML}
                            </div>
                        </div>
                        ${applyButtonHTML}
                    </div>
                </div>
            </div>
        `;
    }

    function renderMarketItemCard(item) { 
        const vendorProfile = window.CAFE_DB.profiles.find(p => p.id === item.vendor_id);
        let messageVendorButtonHTML = '';
        if (vendorProfile) {
            messageVendorButtonHTML = addPingButtonHTML(item.vendor_id, { 
                targetName: vendorProfile.name, 
                text: 'Message Vendor',
                additionalStyle: 'margin-top: 0.5rem;' 
            });
        } else {
            messageVendorButtonHTML = `<span class="cc-pill small">Vendor info missing</span>`;
        }
        let paymentBadges = '';
        if (item.venmo) paymentBadges += `<span class="cc-pill small" title="Accepts Venmo">üíµ Venmo</span>`;
        if (item.paypal) paymentBadges += `<span class="cc-pill small" title="Accepts PayPal">üÖøÔ∏è PayPal</span>`;
        if (!item.venmo && !item.paypal && item.external_url) {
            paymentBadges += `<a href="${item.external_url}" target="_blank" class="cc-pill small">üîó DM on Social/Store</a>`;
        } else if (item.external_url) {
             paymentBadges += ` <a href="${item.external_url}" target="_blank" class="cc-pill small">üîó More Info</a>`;
        }
        const stats = item.stats || { views: 0, likes: 0, dms: 0 };
        const metricsHTML = `<small class="metrics">üëÅÔ∏è${stats.views}   ‚ù§Ô∏è${stats.likes}   üí¨${stats.dms}</small>`;
        return `
            <div class="card-shell market-item-card" data-item-id="${item.id}" style="cursor:pointer;">
                <img src="${item.img_url || item.coverImage || 'https://via.placeholder.com/80/eee/000?text=Item'}" alt="${item.title}" class="avatar-80">
                <div class="card-content" style="width:100%;">
                    <h3>${item.title}</h3>
                    <p><strong>Price:</strong> ${item.price} ${item.currency}</p>
                    <p>${item.description || 'No description.'}</p>
                    <div style="margin-top: 0.3rem; margin-bottom: 0.5rem;">${(item.tags || []).map(t => highlightPill(t)).join('')}</div>
                    <div style="margin-top: 0.3rem; margin-bottom: 0.5rem;">${paymentBadges}</div>
                    ${messageVendorButtonHTML}
                    ${metricsHTML}
                </div>
            </div>
        `;
    }
    
    function renderEvents(list = null) {
        const container = document.getElementById('event-list-container');
        if (!container) return;
        const eventStages = list || window.CAFE_DB.stages.filter(s => s.type === 'event');
        container.innerHTML = eventStages.map(renderEventCard).join('');
        eventStages.forEach(s => renderStageSlots(s.id)); 
        if (typeof feather !== 'undefined') feather.replace();
    }

    function renderJobApp(list = null) { 
        const container = document.getElementById('jobs-container'); 
        if (!container) return;
        const jobStages = list || window.CAFE_DB.stages.filter(s => s.type === 'job')
                                     .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
        container.innerHTML = jobStages.map(renderJobCard).join('');
        if (typeof feather !== 'undefined') feather.replace();
    }
    
    function renderBrowseItems(itemsList) {
        const container = document.getElementById('items-container');
        if (!container) return;
        let itemsToRender = [...itemsList]; 
        const itemsSortEl = document.getElementById('items-sort');
        if (itemsSortEl && itemsSortEl.value) {
            const [sortBy, sortDir] = itemsSortEl.value.split('-');
            if (sortBy === 'price') {
                itemsToRender.sort((a, b) => (parseFloat(a.price) - parseFloat(b.price)) * (sortDir === 'asc' ? 1 : -1));
            } else if (sortBy === 'created_at') {
                itemsToRender.sort((a, b) => (new Date(a.created_at) - new Date(b.created_at)) * (sortDir === 'asc' ? 1 : -1));
            }
        }
        const itemsCategoryEl = document.getElementById('items-category');
        const selectedCategory = itemsCategoryEl ? itemsCategoryEl.value : '';
        if (selectedCategory) {
            itemsToRender = itemsToRender.filter(item => item.tags && item.tags.includes(selectedCategory));
        }
        if (itemsToRender.length === 0) {
            container.innerHTML = `<p style="width:100%; text-align:center; font-style:italic;">No items match your filters. Try broadening your search!</p>`;
        } else {
            container.innerHTML = itemsToRender.map(renderMarketItemCard).join('');
        }
        if (typeof feather !== 'undefined') feather.replace();
    }

    function renderMyListingsOnly(itemsList) {
        const container = document.getElementById('my-items-container');
        if (!container) return;
        if (!CURRENT_USER || !userHasRole('vendor')) {
            container.innerHTML = `<p style="width:100%; text-align:center; font-style:italic;">This section is for vendors. Activate your vendor role to list items.</p>`;
            return;
        }
        let myItemsToRender = itemsList.filter(item => item.vendor_id === CURRENT_USER.id);
        const itemsSortEl = document.getElementById('items-sort');
         if (itemsSortEl && itemsSortEl.value) {
            const [sortBy, sortDir] = itemsSortEl.value.split('-');
            if (sortBy === 'price') {
                myItemsToRender.sort((a, b) => (parseFloat(a.price) - parseFloat(b.price)) * (sortDir === 'asc' ? 1 : -1));
            } else if (sortBy === 'created_at') {
                myItemsToRender.sort((a, b) => (new Date(a.created_at) - new Date(b.created_at)) * (sortDir === 'asc' ? 1 : -1));
            }
        }
        const itemsCategoryEl = document.getElementById('items-category');
        const selectedCategory = itemsCategoryEl ? itemsCategoryEl.value : '';
        if (selectedCategory) {
            myItemsToRender = myItemsToRender.filter(item => item.tags && item.tags.includes(selectedCategory));
        }
        if (myItemsToRender.length === 0) {
            container.innerHTML = `<p style="width:100%; text-align:center; font-style:italic;">You haven't listed any items yet, or none match the current filters. Click "List New Item" to start!</p>`;
        } else {
            container.innerHTML = myItemsToRender.map(renderMarketItemCard).join('');
        }
        if (typeof feather !== 'undefined') feather.replace();
    }
    
    function renderCandidateDeck(keywords = null, preFilteredList = null) {
        const container = document.getElementById('candidates-container');
        if (!container) return;
        let candidatesToConsider = preFilteredList ? [...preFilteredList] : window.CAFE_DB.profiles.filter(p => p.user_roles && p.user_roles.includes('candidate'));
        if (keywords && keywords.length > 0) {
            candidatesToConsider = candidatesToConsider.map(candidate => {
              const nameVec = simpleEmbed(candidate.name);
              const titleVec = simpleEmbed(candidate.title || '');
              const highlightsVec = simpleEmbed((candidate.highlights || []).join(' ')); 
              const bioVec = simpleEmbed(candidate.bio || '');
              const combinedVec = [...new Set([...nameVec, ...titleVec, ...highlightsVec, ...bioVec])];
              const score = jaccard(keywords, combinedVec);
              const matchedHighlights = (candidate.highlights || []).filter(hl => keywords.some(qTerm => simpleEmbed(hl).includes(qTerm)));
              return { ...candidate, score, matchedHighlights };
            })
            .filter(c => c.score > 0.01) 
            .sort((a, b) => b.score - a.score);
        } else {
            candidatesToConsider.sort((a,b) => a.name.localeCompare(b.name));
        }
        if (candidatesToConsider.length === 0) {
            container.innerHTML = `<p style="width:100%; text-align:center; font-style:italic;">No candidates found matching criteria.</p>`;
        } else {
            container.innerHTML = candidatesToConsider.map(renderProfileCard).join('');
        }
        candidatesToConsider.forEach(candidate => { 
            const cardEl = document.getElementById(`profile-card-${candidate.id}`);
            if (cardEl && cardEl.style.display !== 'none') { 
                const whyMatchEl = cardEl.querySelector('.why-match');
                if (whyMatchEl && candidate.score && candidate.score > 0.01) { 
                    whyMatchEl.innerHTML = `<strong>Match Score: ${candidate.score.toFixed(2)}</strong><br>Matched on: ${candidate.matchedHighlights && candidate.matchedHighlights.length > 0 ? candidate.matchedHighlights.join(', ') : 'name/title/bio'}`;
                    whyMatchEl.style.display = 'block';
                } else if (whyMatchEl) {
                    whyMatchEl.style.display = 'none';
                }
            }
        });
        if (typeof feather !== 'undefined') feather.replace();
    }

    function renderAllCurrentTab() { 
        const activeNav = document.querySelector('nav a.active');
        if (!activeNav) return;
        const targetId = activeNav.dataset.target;
        if (targetId === 'events') {
            const quickSearchEl = document.querySelector('#events .quick-search');
            if (quickSearchEl) quickSearchEl.dispatchEvent(new Event('input', {bubbles:true})); else renderEvents();
        } else if (targetId === 'items') {
             const quickSearchEl = document.getElementById('items-search');
             if (quickSearchEl) quickSearchEl.dispatchEvent(new Event('input', {bubbles:true})); else {
                renderBrowseItems(window.CAFE_DB.items); 
                if (userHasRole('vendor')) renderMyListingsOnly(window.CAFE_DB.items);
             }
        } else if (targetId === 'jobs') {
            const quickSearchEl = document.getElementById('jobs-quick-search');
             if (quickSearchEl) quickSearchEl.dispatchEvent(new Event('input', {bubbles:true})); else renderJobApp();
             const candidateSearchInput = document.getElementById('candidate-deck-search-input');
             if (candidateSearchInput && candidateSearchInput.value.trim()) {
                document.getElementById('candidate-deck-search-btn')?.click();
             } else {
                renderCandidateDeck(); 
             }
        } else if (targetId === 'pings') {
            renderPingThreadList();
        } else if (targetId === 'social') {
            renderSocial(); 
        } else if (targetId === 'companies') { 
             renderCompanyGrid();
        }
        updateUnreadPingBadge(); 
        updateUserRoleSpecificUI(); 
        if (typeof feather !== 'undefined') feather.replace();
    }

    function showTab(targetId) {
        if (!targetId) return;
        console.log(`[showTab] Switching to: ${targetId}`);
        sectionsEl.forEach(section => {
            section.style.display = (section.id === targetId) ? 'block' : 'none';
        });
        const currentNavLinks = document.querySelectorAll('nav a'); 
        currentNavLinks.forEach(link => link.classList.toggle('active', link.dataset.target === targetId));

        if (targetId === 'events') {
            renderEvents(); 
            document.querySelector('#events .quick-search')?.dispatchEvent(new Event('input', { bubbles: true }));
        } else if (targetId === 'items') {
            const browseButton = document.querySelector('#items .items-nav button[data-view="browse"]');
            if (browseButton && !document.querySelector('#items .items-nav button.active')) {
                browseButton.click(); 
            } else {
                 document.querySelector('#items .items-nav button.active')?.click(); 
            }
            populateItemCategoryFilter(); 
        } else if (targetId === 'jobs') {
            renderJobApp(); 
            renderCandidateDeck(); 
            document.querySelector('#jobs #jobs-quick-search')?.dispatchEvent(new Event('input', { bubbles: true }));
        } else if (targetId === 'pings') {
            renderPingThreadList();
        } else if (targetId === 'social') {
            renderSocial(); 
        } else if (targetId === 'companies') {
            renderCompanyGrid(); 
        }
        
        const activeSection = document.getElementById(targetId);
        if (activeSection) {
            let focusTarget = activeSection.querySelector('form textarea'); 
            if (!focusTarget && targetId !== 'pings' && targetId !== 'companies') { 
                focusTarget = activeSection.querySelector('.quick-search'); 
            }
            if (!focusTarget && targetId === 'companies') {
                focusTarget = activeSection.querySelector('#co-filter-search input');
            }
            if (!focusTarget && targetId !== 'pings') {
                focusTarget = activeSection.querySelector('textarea, input:not([type=hidden])'); 
            }
            focusTarget?.focus();
        }
        
        updateUserRoleSpecificUI(); 
        toggleFab();
        if (typeof feather !== 'undefined') feather.replace(); 
    }

    function buildProfileInvolvementTreeHTML(profileId){ 
      const involvementContainer = document.createElement('div');
      // Get CafeCorner specific involvements
      const events = window.CAFE_DB.stages.filter(s => s.type === 'event' && Object.values(s.slots).some(a => a?.includes(profileId)));
      const jobs = window.CAFE_DB.stages.filter(s => s.type === 'job' && (s.posted_by === profileId || (s.job_applications||[]).some(ap => ap.candidate_id === profileId)));
      
      let hasCafeCornerInvolvements = false;

      if (events.length > 0) {
        hasCafeCornerInvolvements = true;
        events.forEach(stage => {
            const det = document.createElement('details');
            det.innerHTML = `<summary>EVENT: ${stage.title} (as ${Object.entries(stage.slots).filter(([k,v]) => v?.includes(profileId)).map(([k]) => k.slice(0,-1)).join('/')})</summary>`;
            const ul = document.createElement('ul');
            ul.innerHTML = `<li><strong>Date:</strong> ${stage.date} (${stage.time||'TBD'})</li><li><strong>Location:</strong> ${stage.locationName||'N/A'}</li>`;
            const othersTree = buildStageInvolvementTreeHTML(stage, profileId); 
            if(othersTree && othersTree.children.length > 0){
                const othersLi = document.createElement('li');
                othersLi.innerHTML = '<strong>Also at this event:</strong>';
                othersLi.appendChild(othersTree);
                ul.appendChild(othersLi);
            }
            ul.innerHTML += `<li><a href="#" data-jump-type="event" data-jump-id="${stage.id}" class="btn small" style="margin-top:0.3rem;">View Event</a></li>`;
            det.appendChild(ul);
            involvementContainer.appendChild(det);
        });
      }

      if (jobs.length > 0) {
        hasCafeCornerInvolvements = true;
        jobs.forEach(job => {
            const det = document.createElement('details');
            const role = job.posted_by === profileId ? 'Poster' : 'Applicant';
            det.innerHTML = `<summary>JOB: ${job.title} (as ${role})</summary>`;
            const ul = document.createElement('ul');
            ul.innerHTML = `<li><strong>Status:</strong> ${job.status}</li>`;
            // ... (rest of job involvement details from original function)
            ul.innerHTML += `<li><a href="#" data-jump-type="job" data-jump-id="${job.id}" class="btn small" style="margin-top:0.3rem;">View Job</a></li>`;
            det.appendChild(ul);
            involvementContainer.appendChild(det);
        });
      }
      
      if (!hasCafeCornerInvolvements) {
        const p = document.createElement('p');
        p.style.fontStyle = 'italic';
        p.textContent = 'No standard CafeCorner event/job involvements listed.';
        involvementContainer.appendChild(p);
      }
      return involvementContainer;
    }

    // Helper to get accent color based on involvement type
    function getInvolvementConfig(involvement) { // For general CafeCorner Involvements
        const type = involvement.type;
        if (type === 'event') return { accentColor: '#38A169' };    // Green for events
        if (type === 'project') return { accentColor: '#2B6CB0' };  // Blue for projects
        if (type === 'job-posted' || type === 'job-applied') return { accentColor: '#805AD5' }; // Purple for jobs
        if (type === 'item') return { accentColor: '#DD6B20' };     // Orange for items/listings
        // For Academic items, use the specific config
        if (involvement.category) { // Academic items have a 'category'
            return getAcademicItemCategoryConfig(involvement.category);
        }
        return { accentColor: '#A0AEC0' }; // Default gray
    }

    function renderProfileTimelineNavItem(involvement, clickHandler) {
        const li = document.createElement('li');
        // Use involvement.id if it's from academicTimeline, or dbId for CafeCorner stages
        li.dataset.timelineItemId = involvement.id || involvement.dbId || `timeline-item-${involvement.originalIndex}`;
        li.classList.add('timeline-item-hidden'); 

        const a = document.createElement('a');
        a.href = "#";
        a.setAttribute('aria-expanded', 'false');
        a.dataset.timelineItemId = li.dataset.timelineItemId; // For easier selection in click handler
        
        const config = getInvolvementConfig(involvement);
        a.style.setProperty('--bullet-accent-color', config.accentColor); 

        const dateString = involvement.date && involvement.date !== 'N/A' 
            ? new Date(involvement.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })
            : 'Date N/A';
        
        // Use the category label from academic config if available, else role
        const roleOrCategoryLabel = involvement.category ? getAcademicItemCategoryConfig(involvement.category).label : (involvement.role || 'Activity');
        
        a.innerHTML = `
            <div class="nav-item-title">${involvement.title}</div>
            <div class="nav-item-subtitle">${dateString} &bull; ${roleOrCategoryLabel}</div>
        `;
        
        a.onclick = (e) => {
            e.preventDefault();
            const allNavLinks = li.parentElement.querySelectorAll('a');
            allNavLinks.forEach(link => {
                link.classList.remove('active-timeline-item');
                link.setAttribute('aria-expanded', 'false');
                // Reset border and outline if they were set directly (prefer class-based)
                link.style.borderColor = ""; 
                link.style.outlineColor = "";
            });
            a.classList.add('active-timeline-item');
            a.setAttribute('aria-expanded', 'true');
            // Active state styling (border and outline color) is now handled by .active-timeline-item CSS
            
            clickHandler(involvement); 
        };

        li.appendChild(a);
        return li;
    }

    function populateProfileDetailInTemplate(tplContent, profileId) {
        const profile = window.CAFE_DB.profiles.find(p => p.id === profileId);
        if (!profile) { 
            tplContent.innerHTML = '<p>Profile not found.</p>'; return; 
        }

        tplContent.querySelector('#detail-profile-avatar').src = profile.avatar || 'https://via.placeholder.com/120/ccc/000?text=??';
        tplContent.querySelector('#detail-profile-avatar').alt = profile.name;
        const displayName = profile.allow_multi === false && profile.active_role ?
                            `${profile.name} (${profile.active_role})` :
                            profile.name;
        tplContent.querySelector('#detail-profile-name-header').innerHTML = displayName;
        tplContent.querySelector('#detail-profile-name-sub').style.display = 'none'; 
        tplContent.querySelector('#detail-profile-title').textContent = profile.title || '';
        
        tplContent.querySelector('#detail-profile-bio').textContent = profile.bio || 'No bio available.';
        tplContent.querySelector('#detail-profile-location').textContent = profile.location || 'Location not specified.';
        
        const highlightsParent = tplContent.querySelector('#detail-profile-highlights-parent');
        const highlightsDiv = tplContent.querySelector('#detail-profile-highlights');
        if (profile.highlights && profile.highlights.length > 0) {
            highlightsDiv.innerHTML = (profile.highlights || []).map(h => highlightPill(h, { type: 'skill', id: profile.id })).join(''); 
            highlightsParent.style.display = 'block';
        } else {
            highlightsDiv.innerHTML = '';
            highlightsParent.style.display = 'none';
        }

        const skillsParent = tplContent.querySelector('#detail-profile-skills-parent');
        if (skillsParent) skillsParent.style.display = 'none'; 
        const skillsLegacyDiv = tplContent.querySelector('#detail-profile-skills');
        if (skillsLegacyDiv) skillsLegacyDiv.innerHTML = '';

        const interestsParent = tplContent.querySelector('#detail-profile-interests-parent');
        const interestsDiv = tplContent.querySelector('#detail-profile-interests');
        if(profile.interests && profile.interests.length > 0){
            interestsDiv.innerHTML = profile.interests.map(s => `<span class="cc-pill">${s}</span>`).join(''); 
            interestsParent.style.display = 'block';
        } else {
            interestsDiv.innerHTML = '';
            interestsParent.style.display = 'none';
        }
        
        const bioChaptersSectionEl = tplContent.querySelector('#detail-profile-biography-chapters-section');
        const bioChaptersContainerEl = tplContent.querySelector('#detail-profile-biography-chapters-container');
        if (bioChaptersContainerEl) bioChaptersContainerEl.innerHTML = ''; 

        if (profile.biographyChapters && profile.biographyChapters.length > 0) {
            profile.biographyChapters.forEach(chapter => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'biography-chapter-item';
                const chapterTitleEl = document.createElement('h4'); // Use h4 for chapter titles
                chapterTitleEl.textContent = chapter.title;
                chapterDiv.appendChild(chapterTitleEl);
                if (Array.isArray(chapter.content)) {
                    const contentList = document.createElement('ul');
                    chapter.content.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.textContent = item;
                        contentList.appendChild(listItem);
                    });
                    chapterDiv.appendChild(contentList);
                } else if (typeof chapter.content === 'string') {
                    const contentP = document.createElement('p');
                    contentP.textContent = chapter.content;
                    chapterDiv.appendChild(contentP);
                }
                if (bioChaptersContainerEl) bioChaptersContainerEl.appendChild(chapterDiv);
            });
            if (bioChaptersSectionEl) bioChaptersSectionEl.style.display = 'block';
        } else {
            if (bioChaptersSectionEl) bioChaptersSectionEl.style.display = 'none';
        }
        
        const timelineNavList = tplContent.querySelector('#profile-timeline-nav-list');
        const timelineCenterContentEl = tplContent.querySelector('#profile-timeline-center-content');
        const timelineRightSidebarContentEl = tplContent.querySelector('#profile-timeline-right-sidebar-content');
        
        timelineNavList.innerHTML = ''; 
        timelineCenterContentEl.innerHTML = '<p style="font-style: italic;">Select an item from the timeline navigation to see details.</p>';
        timelineRightSidebarContentEl.innerHTML = '<p style="font-style: italic;">Contextual information will appear here.</p>';

        // Build involvements: Prioritize academic timeline for Dr. Reed
        let involvements = [];
        if (profile.academicTimeline && profile.academicTimeline.length > 0) {
            involvements = profile.academicTimeline.map(item => ({
                ...item, // Spread all properties from academic item
                // 'type' will be its academic type (e.g., 'journal_article', 'research_grant')
                // 'category' will be 'publications', 'projects', etc.
                // 'role' can be derived or set if not present (e.g. Author, Speaker)
                role: item.role || (item.category ? getAcademicItemCategoryConfig(item.category).label : 'Participant'),
                dbId: item.id // Use academic item's ID as dbId for consistency
            }));
        } else { // Fallback to standard CafeCorner involvements if no academic timeline
            (window.CAFE_DB.stages || []).filter(s => s.type === 'event').forEach(stage => {
                Object.entries(stage.slots || {}).forEach(([roleKey, ids]) => {
                    if (Array.isArray(ids) && ids.includes(profile.id)) {
                        const role = roleKey.endsWith('s') ? roleKey.slice(0, -1) : roleKey; 
                        involvements.push({ ...stage, type: 'event', role: role.charAt(0).toUpperCase() + role.slice(1), date: stage.date, dbId: stage.id });
                    }
                });
            });
            // ... (add other CafeCorner involvement types like jobs, projects, items if needed)
        }

        involvements.sort((a, b) => new Date(b.date) - new Date(a.date)); 

        if (involvements.length > 0) {
            involvements.forEach((inv, index) => {
                inv.originalIndex = index; 
                const navItemClickHandler = (selectedInvolvement) => {
                    // The clicked `<a>` tag will get 'active-timeline-item' class by its own click handler.
                    // Here, we just update the center and right panels.
                    const activeConfig = getInvolvementConfig(selectedInvolvement);
                    
                    let centerHTML = `<article class="timeline-center-card" style="border-color: ${activeConfig.accentColor}; outline-color: ${activeConfig.accentColor};">`;
                    
                    const invDateFull = selectedInvolvement.date && selectedInvolvement.date !== 'N/A' 
                        ? new Date(selectedInvolvement.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) 
                        : 'Date N/A';
                    
                    centerHTML += `<div class="timeline-card-header-meta">
                                     <time datetime="${selectedInvolvement.date || ''}">${invDateFull}</time>
                                     ${selectedInvolvement.readTime ? `<span class="read-time">${selectedInvolvement.readTime}</span>` : ''}
                                   </div>`;
                    // Use h4 for title in center card as it's within a detail panel
                    centerHTML += `<h4 class="item-title">${selectedInvolvement.title}</h4>`; 
                    if (selectedInvolvement.subtitle) centerHTML += `<p class="timeline-card-subtitle">${selectedInvolvement.subtitle}</p>`;
                    
                    if (selectedInvolvement.description) centerHTML += `<p class="timeline-card-description">${selectedInvolvement.description}</p>`;
                    
                    if (selectedInvolvement.keywords && selectedInvolvement.keywords.length > 0) {
                        centerHTML += `<div class="timeline-card-keywords-container">
                                         ${selectedInvolvement.keywords.map(kw => `<span class="timeline-card-keyword">${kw}</span>`).join('')}
                                       </div>`;
                    }
                    
                    let detailsContent = '';
                     // Academic item specific details
                    if (selectedInvolvement.metrics) {
                        detailsContent += `<p>Metrics: 
                            ${selectedInvolvement.metrics.citations ? `<span>${selectedInvolvement.metrics.citations} citations</span>` : ''}
                            ${selectedInvolvement.metrics.citations && selectedInvolvement.metrics.views ? " / " : ""}
                            ${selectedInvolvement.metrics.views ? `<span>${selectedInvolvement.metrics.views} views</span>` : ''}
                        </p>`;
                    }
                    if (selectedInvolvement.doi) detailsContent += `<p>DOI: <a href="https://doi.org/${selectedInvolvement.doi}" target="_blank" rel="noopener noreferrer">${selectedInvolvement.doi}</a></p>`;
                    if (selectedInvolvement.funding) detailsContent += `<p>Funding: <span>${selectedInvolvement.funding}</span></p>`;
                    if (selectedInvolvement.outputs) detailsContent += `<p>Outputs: <span>${Array.isArray(selectedInvolvement.outputs) ? selectedInvolvement.outputs.join(', ') : selectedInvolvement.outputs}</span></p>`;
                    if (selectedInvolvement.publisher) detailsContent += `<p>Publisher: <span>${selectedInvolvement.publisher}</span></p>`;
                    if (selectedInvolvement.location) detailsContent += `<p>Location: <span>${selectedInvolvement.location}</span></p>`;
                    if (selectedInvolvement.attendees) detailsContent += `<p>Attendees: <span>${selectedInvolvement.attendees}</span></p>`;
                    if (selectedInvolvement.participants) detailsContent += `<p>Participants: <span>${selectedInvolvement.participants}</span></p>`;
                    if (selectedInvolvement.comments) detailsContent += `<p>Discussion: <span>${selectedInvolvement.comments} comments</span></p>`;
                    if (selectedInvolvement.duration) detailsContent += `<p>Duration: <span>${selectedInvolvement.duration}</span></p>`;
                    if (selectedInvolvement.collaboration) detailsContent += `<p>Collaboration: <span>${selectedInvolvement.collaboration}</span></p>`;
                    if (selectedInvolvement.institutions) detailsContent += `<p>Institutions: <span>${selectedInvolvement.institutions}</span></p>`;
                    
                    if (detailsContent) {
                        centerHTML += `<div class="timeline-card-details-section">${detailsContent}</div>`;
                    }
                    
                    let actionLinksHTML = '';
                    if (selectedInvolvement.citationLink) actionLinksHTML += `<button>Cite</button>`; 
                    if (selectedInvolvement.link || selectedInvolvement.videoLink || selectedInvolvement.doi) { // Added DOI as a possible link source
                        let linkUrl = selectedInvolvement.link || selectedInvolvement.videoLink;
                        let linkText = selectedInvolvement.link ? "Read Post" : (selectedInvolvement.videoLink ? "Watch Talk" : "");
                        if (!linkUrl && selectedInvolvement.doi) {
                            linkUrl = `https://doi.org/${selectedInvolvement.doi}`;
                            linkText = "View Publication";
                        }
                        if (linkUrl) {
                           actionLinksHTML += `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
                        }
                    }
                    // Add a generic "View Details" for CafeCorner stages if no specific link
                    if (!actionLinksHTML && selectedInvolvement.dbId && !selectedInvolvement.dbId.startsWith('acad_') && selectedInvolvement.type !== 'item' && selectedInvolvement.type !== 'project') {
                        let jumpType = selectedInvolvement.type;
                        if (jumpType === 'job-posted' || jumpType === 'job-applied') jumpType = 'job';
                        actionLinksHTML += `<a href="#" data-jump-type="${jumpType}" data-jump-id="${selectedInvolvement.dbId}">View Full Details</a>`;
                    }

                    if (actionLinksHTML) {
                         centerHTML += `<div class="timeline-card-action-links">${actionLinksHTML} <button>Share</button></div>`;
                    } else { // Add a default Share if no other actions
                         centerHTML += `<div class="timeline-card-action-links"><button>Share</button></div>`;
                    }
                    
                    centerHTML += `</article>`;
                    timelineCenterContentEl.innerHTML = centerHTML;
                    
                    // Right sidebar: For academic items, maybe list related keywords or a call to action
                    let rightHTML = `<h4>Contextual Info</h4>`;
                    if (selectedInvolvement.keywords && selectedInvolvement.keywords.length > 0) {
                        rightHTML += `<h5>Related Keywords:</h5><div>${selectedInvolvement.keywords.map(kw => `<span class="cc-pill small tag-interactive" data-type="skill" data-tag="${kw}" data-id="${profile.id}">${kw}</span>`).join(' ')}</div>`;
                    } else {
                        rightHTML += '<p><em>No specific contextual info for this item.</em></p>';
                    }
                    // Add jump links for CafeCorner items if they are part of the timeline
                    if (selectedInvolvement.type === 'event' && selectedInvolvement.dbId && !selectedInvolvement.dbId.startsWith('acad_')) {
                        rightHTML += `<p style="margin-top:0.75rem;"><a href="#" data-jump-type="event" data-jump-id="${selectedInvolvement.dbId}" class="btn small">View Full Event Details</a></p>`;
                    }

                    timelineRightSidebarContentEl.innerHTML = rightHTML;

                    hydratePills(timelineCenterContentEl); 
                    hydratePills(timelineRightSidebarContentEl);
                    if (typeof feather !== 'undefined') feather.replace();
                };
                const navItemElement = renderProfileTimelineNavItem(inv, navItemClickHandler);
                timelineNavList.appendChild(navItemElement);
            });
            if (timelineNavList.firstChild && timelineNavList.firstChild.querySelector('a')) {
                timelineNavList.firstChild.querySelector('a').click();
            }
        } else {
            timelineCenterContentEl.innerHTML = '<p style="font-style: italic;">No timeline activities recorded for this profile.</p>';
            timelineRightSidebarContentEl.innerHTML = '<p style="font-style: italic;">No timeline data available.</p>';
        }

        // Setup IntersectionObserver for nav items
        const timelineNavItems = Array.from(timelineNavList.querySelectorAll('li[data-timeline-item-id]'));
        if (profileTimelineObserver) {
            profileTimelineObserver.disconnect();
            visibleTimelineItems.clear(); 
        }
        if (timelineNavItems.length > 0) {
            profileTimelineObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const itemId = entry.target.dataset.timelineItemId;
                    if (entry.isIntersecting) {
                        if (!visibleTimelineItems.has(itemId)) { 
                            entry.target.classList.add('timeline-item-visible');
                            visibleTimelineItems.add(itemId);
                        }
                    }
                });
            }, { 
                threshold: 0.15, 
                rootMargin: '0px 0px -40px 0px', 
                root: tplContent.querySelector('.profile-timeline-nav-container') 
            });
            timelineNavItems.forEach(li => profileTimelineObserver.observe(li));
        }
        
        // Original CafeCorner Involvements (Events, Jobs)
        const involvementTreeContainer = tplContent.querySelector('#profile-involvement-tree-container');
        const involvementTreeDiv = tplContent.querySelector('#detail-profile-involvement-tree');
        const cafeCornerInvolvementsTree = buildProfileInvolvementTreeHTML(profileId);
        if (cafeCornerInvolvementsTree && cafeCornerInvolvementsTree.children.length > 0 && !(cafeCornerInvolvementsTree.children.length === 1 && cafeCornerInvolvementsTree.firstChild.textContent.includes('No standard CafeCorner'))) {
            involvementTreeDiv.innerHTML = '';
            involvementTreeDiv.appendChild(cafeCornerInvolvementsTree);
            involvementTreeContainer.style.display = 'block';
        } else {
            involvementTreeContainer.style.display = 'none';
        }
        
        const profileLinkEl = tplContent.querySelector('#detail-profile-link');
        if (profile.profileUrl && profile.profileUrl !== '#') {
            profileLinkEl.href = profile.profileUrl;
            profileLinkEl.style.display = 'inline-flex';
        } else {
            profileLinkEl.style.display = 'none';
        }

        const mbtiButton = tplContent.querySelector('.mbti-btn');
        const mbtiBadge = tplContent.querySelector('.mbti-badge');
        if (mbtiButton && mbtiBadge) {
            if (profile.id === MOCK_LOGGED_IN_USER_ID) {
                mbtiButton.style.display = 'inline-flex';
                mbtiBadge.style.display = 'none';
                mbtiBadge.textContent = '';
            } else {
                mbtiButton.style.display = 'none';
                mbtiBadge.style.display = 'none';
            }
        }
        hydratePills(tplContent);
        if (typeof feather !== 'undefined') feather.replace();
    }

    function populateEventDetailInTemplate(tpl, eventId) {
        const event = window.CAFE_DB.stages.find(s => s.id === eventId && s.type === 'event');
        if (!event) { console.error("Event not found for detail panel:", eventId); return; }

        tpl.querySelector('#detail-event-cover-img').src = event.coverImage || 'https://via.placeholder.com/120/eee/000?text=Event';
        tpl.querySelector('#detail-event-cover-img').alt = event.title + " Cover";
        tpl.querySelector('#detail-event-title').textContent = event.title;
        tpl.querySelector('#detail-event-date-time').textContent = `Date: ${event.date} (${event.time || 'Time TBD'})`;
        tpl.querySelector('#detail-event-location').textContent = `Location: ${event.locationName || 'Location TBD'}`;
        tpl.querySelector('#detail-event-description').textContent = event.description || 'No description available.';
        
        const tagsDiv = tpl.querySelector('#detail-event-tags');
        tagsDiv.innerHTML = (event.tags || []).map(t => highlightPill(t)).join(''); 
        tpl.querySelector('#detail-event-tags-parent').style.display = (event.tags && event.tags.length > 0) ? 'block' : 'none';

        const participantsTreeDiv = tpl.querySelector('#detail-event-participants-tree');
        participantsTreeDiv.innerHTML = ''; 
        const involvementTree = buildStageInvolvementTreeHTML(event); 
        if (involvementTree) {
            participantsTreeDiv.appendChild(involvementTree);
        } else {
            participantsTreeDiv.innerHTML = '<p style="font-style:italic;">No participants listed for these roles yet.</p>';
        }
        
        const websiteLink = tpl.querySelector('#detail-event-website-link');
        if (event.websiteUrl && event.websiteUrl !== '#') {
            websiteLink.href = event.websiteUrl;
            websiteLink.style.display = 'inline-flex';
        } else {
            websiteLink.style.display = 'none';
        }

        const joinBtn = tpl.querySelector('#detail-event-join-btn');
        joinBtn.dataset.stageId = event.id;
        if (CURRENT_USER) {
            const currentRole = CURRENT_USER.active_role;
            let targetSlotKey;
            if (['vendor', 'host', 'organizer', 'recruiter'].includes(currentRole)) targetSlotKey = currentRole + 's';
            else targetSlotKey = 'attendees';

            if (event.slots[targetSlotKey] && event.slots[targetSlotKey].includes(CURRENT_USER.id)) {
                joinBtn.textContent = `‚úì Added as ${currentRole}`;
                joinBtn.disabled = true;
            } else if (Object.values(event.slots).flat().includes(CURRENT_USER.id)) {
                const existingRole = Object.entries(event.slots).find(([key, ids]) => ids.includes(CURRENT_USER.id))?.[0].slice(0, -1);
                joinBtn.textContent = `‚úì Added as ${existingRole || 'participant'}`;
                joinBtn.disabled = true;
            } else {
                joinBtn.textContent = `+ Add My Profile to Event`;
                joinBtn.disabled = false;
            }
        }

        const pingBtn = tpl.querySelector('#detail-event-ping-btn');
        pingBtn.dataset.threadId = event.id; 
        pingBtn.dataset.isEvent = "true"; 
        pingBtn.dataset.receiverId = event.id; 
        
        const commentForm = tpl.querySelector('#detail-event-comment-form');
        commentForm.dataset.ctxId = event.id;
        commentForm.reset(); 
    }
    
    function populateTemplate(tplContent, kind, id) { 
        if (kind === 'profile') {
            populateProfileDetailInTemplate(tplContent, id);
        } else if (kind === 'event') {
            populateEventDetailInTemplate(tplContent, id);
        } 
        else if (kind === 'project') { 
          const p = window.CAFE_DB.projects.find(pr => pr.id === id);
          if (!p) { console.error("Project not found in CAFE_DB.projects for id:", id); return; }
          tplContent.querySelector('#proj-title').textContent = p.title;
          tplContent.querySelector('#proj-blurb').textContent = p.blurb;
          tplContent.querySelector('#proj-status').textContent = p.status;
          tplContent.querySelector('#proj-gallery').innerHTML = (p.gallery || []).map(src => `<img class="project-image" src="${src}" alt="Project gallery image for ${p.title}">`).join('');
          tplContent.querySelector('#proj-features').innerHTML = (p.features || []).map(f => `<li>${f}</li>`).join('') || '<li>No features listed.</li>';
          tplContent.querySelector('#proj-tech').innerHTML = (p.tech_stack || []).map(t => highlightPill(t)).join('') || '<span>No tech stack listed.</span>'; 
          
          const owner = window.CAFE_DB.profiles.find(o => o.id === p.owner_id);
          const ownerLink = tplContent.querySelector('#proj-owner-link');
          if (owner) {
            ownerLink.dataset.jumpType = 'profile'; 
            ownerLink.dataset.jumpId = owner.id;
            ownerLink.textContent = `About the Founder: ${owner.name} ‚Üó`;
            ownerLink.onclick = (e) => { e.preventDefault(); handleJump('profile', owner.id); };
            ownerLink.style.display = 'inline-flex';
          } else {
            ownerLink.style.display = 'none';
          }
        }
        else if (kind === 'item') {
          const it = window.CAFE_DB.items.find(i => i.id === id);
          if (!it) { console.error("Item not found for id:", id); return; }
          tplContent.querySelector('#item-cover').src = it.img_url || 'https://via.placeholder.com/140';
          tplContent.querySelector('#item-cover').alt = it.title;
          tplContent.querySelector('#item-title').textContent = it.title;
          tplContent.querySelector('#item-price').textContent = `${it.price} ${it.currency}`;
          tplContent.querySelector('#item-desc').textContent  = it.description || '';
          tplContent.querySelector('#item-tags').innerHTML    = (it.tags||[]).map(t => highlightPill(t)).join(''); 
          tplContent.querySelector('#item-payment').innerHTML = [
            it.venmo  ? '<span class="cc-pill small">üíµ Venmo</span>'  : '',
            it.paypal ? '<span class="cc-pill small">üÖøÔ∏è PayPal</span>' : ''
          ].join(' ').trim() || '<span>No payment methods specified.</span>';
          const ext = tplContent.querySelector('#item-ext-link');
          if (it.external_url) { 
            ext.href = it.external_url; 
            ext.style.display = 'inline-flex'; 
          } else {
            ext.style.display = 'none';
          }
          const ping = tplContent.querySelector('#item-ping-btn');
          ping.dataset.threadId = generateThreadId(MOCK_LOGGED_IN_USER_ID, it.vendor_id);
          ping.dataset.receiverId = it.vendor_id;
          ping.dataset.isEvent = "false";
          ping.onclick = () => { 
            if (it.vendor_id && it.vendor_id !== MOCK_LOGGED_IN_USER_ID) {
                openPingThread(generateThreadId(MOCK_LOGGED_IN_USER_ID, it.vendor_id), false);
            } else if (it.vendor_id === MOCK_LOGGED_IN_USER_ID) {
                alert("This is your own listing.");
            } else {
                alert("Vendor information not available for this item.");
            }
          };
        }
        else if (kind === 'company') {
          const c = window.CAFE_DB.companies.find(co => co.id === id);
          if (!c) { console.error("Company not found for id:", id); return; }
          tplContent.querySelector('#co-logo').src = c.logo || 'https://via.placeholder.com/120';
          tplContent.querySelector('#co-logo').alt = c.name + " logo";
          tplContent.querySelector('#co-name').textContent = c.name;
          tplContent.querySelector('#co-blurb').textContent = c.blurb || '';
          tplContent.querySelector('#co-founded').textContent = c.founded || '‚Äî';
          tplContent.querySelector('#co-tags').innerHTML = (c.tags||[]).map(t => highlightPill(t)).join(''); 

          const team = tplContent.querySelector('#co-team');
          team.innerHTML = (c.people||[]).map(pid=>{
              const p=window.CAFE_DB.profiles.find(x=>x.id===pid);
              return p?`<a href="#" data-jump-type="profile" data-jump-id="${p.id}">${p.name}</a>`:'';
          }).filter(Boolean).join('<br>')||'‚Äî';

          const proj = tplContent.querySelector('#co-projects');
          proj.innerHTML = (c.projects||[]).map(prid=>{
              const pr=window.CAFE_DB.projects.find(x=>x.id===prid);
              return pr?`<a href="#" data-jump-type="project" data-jump-id="${pr.id}">${pr.title}</a>`:'';
          }).filter(Boolean).join('<br>')||'‚Äî';

          const itm = tplContent.querySelector('#co-items');
          itm.innerHTML = (c.items||[]).map(iid=>{
              const it=window.CAFE_DB.items.find(x=>x.id===iid);
              return it?`<a href="#" data-jump-type="item" data-jump-id="${it.id}">${it.title}</a>`:'';
          }).filter(Boolean).join('<br>')||'‚Äî';

          const prod = tplContent.querySelector('#co-products');
          prod.innerHTML = (c.products||[]).map(p=>`<a href="${p.url}" target="_blank">${p.label||p.kind}</a>`).join('<br>')||'‚Äî';

          const site = tplContent.querySelector('#co-site');
          site.href = c.website || '#';
          if (!c.website || c.website === '#') site.style.display = 'none'; else site.style.display = 'inline-flex';
        }
    }

    function renderCompanyGrid(){
      const grid   = document.getElementById('companies-grid');
      if (!grid) return; 
      const searchInput = document.querySelector('#co-filter-search input');
      const search = searchInput ? searchInput.value.trim().toLowerCase() : '';

      const activeTagPills = document.querySelectorAll('#co-filter-tags .tag-filter.active');
      const activeTags = Array.from(activeTagPills).map(pill => pill.textContent.trim());

      const activeSizeCheckboxes = document.querySelectorAll('#co-filter-size input[type="checkbox"]:checked');
      const activeSizeRanges = Array.from(activeSizeCheckboxes).map(cb => {
        const [minStr, maxStr] = cb.dataset.size.split('-');
        const min = parseInt(minStr.replace('k', '000'), 10);
        const max = parseInt(maxStr.replace('k', '000'), 10);
        return { min, max };
      });

      grid.innerHTML = ''; 
      CAFE_DB.companies
        .filter(c => {
           if (search && !c.name.toLowerCase().includes(search) && !(c.blurb || '').toLowerCase().includes(search)) return false;
           if (activeTags.length > 0) {
             if (!c.tags || c.tags.length === 0) return false;
             const companyTagsLower = c.tags.map(t => t.toLowerCase());
             if (!activeTags.every(at => companyTagsLower.includes(at.toLowerCase()))) return false;
           }
           if (activeSizeRanges.length > 0) {
             const companySize = c.headcount; 
             if (typeof companySize !== 'number') return false; 
             if (!activeSizeRanges.some(range => companySize >= range.min && companySize <= range.max)) return false;
           }
           return true;
        })
        .forEach(c => {
          const el = document.createElement('div');
          el.className = 'company-card';
          el.innerHTML = `
             <div style="display:flex;align-items:center;">
                <img class="company-logo" src="${c.logo||'https://via.placeholder.com/56'}" alt="${c.name} logo">
                <div>
                   <h4>${c.name}</h4>
                   <p>${c.tags?.slice(0,3).join(' ¬∑ ')||''}</p>
                </div>
             </div>
          `;
          el.onclick = ()=> handleJump('company',c.id);
          grid.appendChild(el);
        });
    }

    function buildCompanySidebar(){
      const tagDiv = document.getElementById('co-filter-tags');
      if (tagDiv) { 
        const allTags = [...new Set(CAFE_DB.companies.flatMap(c=>c.tags||[]))].sort();
        tagDiv.innerHTML = allTags.map(t=>`<span class="cc-pill tag-filter">${t}</span>`).join('');
        tagDiv.querySelectorAll('.tag-filter').forEach(pill=>{
            pill.onclick = e=>{
               pill.classList.toggle('active');
               renderCompanyGrid();
            };
        });
      }

      const sizeDiv = document.getElementById('co-filter-size');
      if (sizeDiv) { 
        sizeDiv.innerHTML = `
           <label><input type="checkbox" data-size="1-50"> 1-50</label><br>
           <label><input type="checkbox" data-size="51-250"> 51-250</label><br>
           <label><input type="checkbox" data-size="251-1000"> 251-1k</label>
        `;
        sizeDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', renderCompanyGrid);
        });
      }
      
      const searchInput = document.querySelector('#co-filter-search input');
      if (searchInput) {
        searchInput.addEventListener('input', renderCompanyGrid);
      }
    }

    function showDetailPanel(kind, id){
      console.log(`[showDetailPanel] Called with kind: ${kind}, id: ${id}`);
      if (!detailOverlayEl) {
          console.error("#detail-overlay element not found!");
          return;
      }

      if (!detailOverlayEl.classList.contains('show')) {
          const activeNav = document.querySelector('nav a.active');
          if (activeNav) {
              lastActiveTabId = activeNav.dataset.target;
          } else {
             lastActiveTabId = lastActiveTabId || 'items'; 
          }
          lastScrollPosition = window.scrollY;
          console.log(`[showDetailPanel] Storing return state: tab=${lastActiveTabId}, scrollY=${lastScrollPosition}`);
      }
      
      detailOverlayEl.innerHTML = ''; 
      let tplId; 
      if (kind === 'profile') tplId = 'tpl-profile-detail';
      else if (kind === 'event') tplId = 'tpl-event-detail';
      else if (kind === 'project') tplId = 'tpl-project-detail'; 
      else if (kind === 'item') tplId = 'tpl-item-detail';       
      else if (kind === 'company') tplId = 'tpl-company-detail'; 
      else { console.error("Unknown kind for detail panel:", kind); return; }
      
      const templateElement = document.getElementById(tplId);

      if (!templateElement || !templateElement.content) {
          console.error(`Template with ID ${tplId} not found or is not a template element.`);
          return;
      }
      const tplClone = templateElement.content.cloneNode(true);

      populateTemplate(tplClone, kind, id); 
      
      detailOverlayEl.appendChild(tplClone);
      detailOverlayEl.classList.add('show');
      detailOverlayEl.scrollTop = 0; 
      
      if (typeof feather !== 'undefined') feather.replace(); 
      hydratePills(detailOverlayEl);
    }
    
    function closeDetailPanelAndReturn() {
        if (detailOverlayEl.classList.contains('show')) {
            detailOverlayEl.classList.remove('show');

            if (profileTimelineObserver) {
                profileTimelineObserver.disconnect();
                profileTimelineObserver = null;
                visibleTimelineItems.clear(); 
            }

            if (lastActiveTabId) {
                showTab(lastActiveTabId);
                requestAnimationFrame(() => {
                    window.scrollTo(0, lastScrollPosition);
                    console.log(`[Panel Closed] Restored scroll to ${lastScrollPosition} for tab ${lastActiveTabId}`);
                });
            } else {
                showTab('items'); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
    }

    function resetDefaultView() {
        detailOverlayEl.classList.remove('show'); 
        if (profileTimelineObserver) { 
            profileTimelineObserver.disconnect();
            profileTimelineObserver = null;
            visibleTimelineItems.clear();
        }
        pingThreadModalEl.classList.remove('show'); pingThreadModalEl.style.display = 'none';
        document.querySelectorAll('.quick-search').forEach(qs => qs.value = '');
        document.querySelectorAll('#candidates-container .why-match').forEach(el => {
            el.style.display = 'none';
            el.innerHTML = ''; 
        });
        document.querySelectorAll('.mbti-badge').forEach(badge => badge.style.display = 'none');
        showTab('items'); 
        renderSidebar(); 
        window.scrollTo({ top: 0, behavior: 'smooth' });
        lastActiveTabId = 'items';
        lastScrollPosition = 0;
    }

    const simpleEmbed = txt => txt ? txt.toLowerCase().split(/\W+/).filter(Boolean) : [];
    const jaccard = (a,b) => {
      if (!a || !b || a.length === 0 || b.length === 0) return 0;
      const setA = new Set(a), setB = new Set(b);
      const intersection = [...setA].filter(x => setB.has(x));
      const union = new Set([...setA, ...setB]);
      return union.size === 0 ? 0 : intersection.length / union.size;
    };

    let botFuse; 
    function initializeBotFuse() {
        if (!window.CAFE_DB || !window.CAFE_DB.profiles || !window.CAFE_DB.items || !window.CAFE_DB.stages || !window.CAFE_DB.projects || !window.CAFE_DB.companies || !window.HIGHLIGHT_KB) { 
            console.warn("Bot Fuse: CAFE_DB or HIGHLIGHT_KB not fully ready. Retrying in 1s.");
            setTimeout(initializeBotFuse, 1000); 
            return;
        }
        const fuseData = [
            ...window.CAFE_DB.profiles.map(p   => ({type:'profile', id:p.id,   txt:`${p.name} ${p.title} ${(p.highlights||[]).join(' ')}` })),
            ...window.CAFE_DB.items.map(it     => ({type:'item',    id:it.id,  txt:`${it.title} ${it.description} ${(it.tags || []).join(' ')}`})),
            ...window.CAFE_DB.stages.filter(s=>s.type==='event')
                             .map(ev   => ({type:'event',   id:ev.id,   txt:`${ev.title} ${(ev.tags||[]).join(' ')} ${ev.description}`  })),
            ...window.CAFE_DB.stages.filter(s=>s.type==='job')
                             .map(jb   => ({type:'job',   id:jb.id,   txt:`${jb.title} ${(jb.skills||[]).join(' ')} ${jb.description}`  })),
            ...(window.CAFE_DB.projects || []).map(pj => ({type:'project', id:pj.id, txt:`${pj.title} ${pj.blurb || pj.tagline || pj.description} ${(pj.tech_stack||pj.techStack||[]).join(' ')}`})),
            ...(window.CAFE_DB.companies || []).map(co => ({type:'company', id:co.id, txt:`${co.name} ${co.blurb} ${(co.tags||[]).join(' ')}`}))
          ];
        botFuse = new Fuse( fuseData, { includeScore:true, threshold:0.35, keys:['txt'] } );
        console.log("Bot Fuse.js instance created/updated with " + fuseData.length + " items.");
    }

    function botAnswer(q){
      if (!botFuse) return "Bot is still warming up..."; 
      const best = botFuse.search(q).slice(0,3);          
      if(!best.length) return "¬Ø\\_(„ÉÑ)_/¬Ø  Nothing pops up.";
      return best.map(hit=>{
        const {type,id} = hit.item;
        let entity;
        if (type === 'profile') entity = window.CAFE_DB.profiles.find(p=>p.id===id);
        else if (type === 'item') entity = window.CAFE_DB.items.find(i=>i.id===id);
        else if (type === 'project') entity = window.CAFE_DB.projects.find(p=>p.id===id);
        else if (type === 'company') entity = window.CAFE_DB.companies.find(co=>co.id===id);
        else entity = window.CAFE_DB.stages.find(s=>s.id===id);
        
        const nameOrTitle = entity?.name || entity?.title || id;
        if     (type==='profile') return `Maybe <a href="#" data-type="profile" data-id="${id}">${nameOrTitle}</a> fits?`; 
        else if(type==='item')    return `Check item <a href="#" data-type="item" data-id="${id}">${nameOrTitle}</a>`;
        else if(type==='event')   return `See event <a href="#" data-type="event" data-id="${id}">${nameOrTitle}</a>`;
        else if(type==='job')     return `About job <a href="#" data-type="job" data-id="${id}">${nameOrTitle}</a>?`; 
        else if(type==='project') return `How about project <a href="#" data-type="project" data-id="${id}">${nameOrTitle}</a>?`;
        else if(type==='company') return `Info on company <a href="#" data-type="company" data-id="${id}">${nameOrTitle}</a>?`;
        else return `Found something: ${nameOrTitle}`;
      }).join('<br>');
    }
    
    let fuseInstances = {}; 
    function wireQuickSearch(scope, listFn, renderFn, options = {}){
      const box = document.querySelector(`.quick-search[data-scope="${scope}"]`);
      if(!box) {
        console.warn(`Quick search box for scope "${scope}" not found.`);
        return;
      }
      const initializeFuse = () => {
        const listForFuse = listFn();
        if (!listForFuse || listForFuse.length === 0) {
            fuseInstances[scope] = null; 
            return;
        }
        fuseInstances[scope] = new Fuse(listForFuse, {threshold: 0.4, keys:['text'], ...options.fuseOptions});
        console.log(`Fuse for scope '${scope}' initialized/re-initialized with ${listForFuse.length} items.`);
      };
      initializeFuse(); 
      window.addEventListener('dataChangedForQuickSearch', (event) => {
          if (event.detail && event.detail.scope === scope) {
              console.log(`Data changed for quick search scope: ${scope}. Re-initializing Fuse.`);
              initializeFuse();
              box.dispatchEvent(new Event('input', { bubbles: true }));
          }
      });
      box.addEventListener('input', ()=>{
        if (!fuseInstances[scope] && listFn().length > 0) { 
            initializeFuse(); 
            if(!fuseInstances[scope]) { 
                 console.warn(`Fuse for ${scope} failed to init despite data. Search may not work correctly.`);
            }
        }
        const q = box.value.trim();
        const rawListProvider = options.rawListProvider || (() => listFn().map(item => item.raw || item));
        const fullList = rawListProvider();
        if(!q){ renderFn(fullList); return; } 
        if (!fuseInstances[scope]) { 
            console.warn(`Fuse for scope '${scope}' not available. Rendering full list (further filters may apply).`);
            renderFn(fullList); 
            return;
        }
        const hits = fuseInstances[scope].search(q).map(r=>r.item.raw);
        renderFn(hits);
      });
    }

    async function extractMetaFromFile(file){
      if(!file) return {}; 
      if(file.type.startsWith('image/')){
         return { title: file.name.replace(/\.\w+$/,''), coverImage: URL.createObjectURL(file) }; 
      }
      if(file.type.startsWith('video/')){
         const [thumb] = await getVideoFrame(file, 0.5); 
         return { coverImage: thumb, title: file.name.replace(/\.\w+$/,'') }; 
      }
      return { title: file.name.replace(/\.\w+$/,'') };
    }
    
    async function extractMetaFromFile(file){
      if(!file) return {}; 
      if(file.type.startsWith('image/')){
         return { title: file.name.replace(/\.\w+$/,''), coverImage: URL.createObjectURL(file) }; 
      }
      if(file.type.startsWith('video/')){
         const [thumb] = await getVideoFrame(file, 0.5); 
         return { coverImage: thumb, title: file.name.replace(/\.\w+$/,'') }; 
      }
      return { title: file.name.replace(/\.\w+$/,'') };
    }

    function getVideoFrame(file, percent){
      return new Promise(res=>{
        const v=document.createElement('video');
        v.src = URL.createObjectURL(file);  
        v.onloadedmetadata = ()=>{ 
            if (isFinite(v.duration)) {
                v.currentTime = v.duration*percent; 
            } else {
                console.warn("Video duration is not finite, cannot seek for thumbnail.");
                res([null]); 
                URL.revokeObjectURL(v.src); 
            }
        };
        v.onseeked = ()=>{
          const c=document.createElement('canvas');
          c.width=160; c.height=90; 
          const videoAspectRatio = v.videoWidth / v.videoHeight;
          const canvasAspectRatio = c.width / c.height;
          let drawWidth = c.width; let drawHeight = c.height;
          let x = 0; let y = 0;
          if (videoAspectRatio > canvasAspectRatio) { 
            drawHeight = c.width / videoAspectRatio; y = (c.height - drawHeight) / 2;
          } else { 
            drawWidth = c.height * videoAspectRatio; x = (c.width - drawWidth) / 2;
          }
          c.getContext('2d').drawImage(v, x, y, drawWidth, drawHeight);
          res([c.toDataURL()]);
          URL.revokeObjectURL(v.src); 
        };
        v.onerror = () => {
            console.error("Error loading video for thumbnail extraction.");
            res([null]); 
             URL.revokeObjectURL(v.src); 
        }
      });
    }

    function populateItemCategoryFilter() {
        const categorySelect = document.getElementById('items-category');
        if (!categorySelect) return;
        const allTags = new Set();
        window.CAFE_DB.items.forEach(item => {
            (item.tags || []).forEach(tag => allTags.add(tag));
        });
        const currentValue = categorySelect.value;
        categorySelect.innerHTML = '<option value="">All Categories</option>'; 
        allTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            categorySelect.appendChild(option);
        });
        if (Array.from(allTags).includes(currentValue)) {
            categorySelect.value = currentValue;
        }
    }

    function toggleFab(){ 
      if (!fabNewListingEl) return;
      const itemsTabActive = document.getElementById('items').style.display !== 'none';
      const show = userHasRole('vendor') && itemsTabActive;
      fabNewListingEl.style.display = show ? 'flex':'none'; 
    }

    function scrollWhenReady(selector, retries=10){
      const attemptScroll = (currentRetries) => {
        const el = document.querySelector(selector);
        if (el) {
          el.scrollIntoView({behavior:'smooth', block:'center'});
          el.classList.add('flash-outline');
          setTimeout(()=>el.classList.remove('flash-outline'), 2000); 
        } else if (currentRetries > 0) {
          requestAnimationFrame(() => attemptScroll(currentRetries - 1)); 
        } else {
          console.warn(`scrollWhenReady: Element not found after multiple retries for selector: ${selector}`);
        }
      };
      requestIdleCallback(() => { 
        attemptScroll(retries);
      });
    }

    function handleJump(type, id){
      console.log(`[handleJump] type: ${type}, id: ${id}`);
      let scrollTargetSelector;

      switch(type) {
        case 'profile':
          showDetailPanel('profile', id);
          break;
        case 'event':
          showDetailPanel('event', id); 
          break;
        case 'project': 
          showDetailPanel('project', id);
          break;
        case 'item': 
          showDetailPanel('item', id);
          break;
        case 'job': 
          showTab('jobs');
          scrollTargetSelector = `#stage-card-${id}`;
          break;
        case 'company': 
          showDetailPanel('company', id);
          break;
        default:
          console.warn(`[handleJump] Unknown jump type: ${type}`);
          return;
      }

      if (scrollTargetSelector) { 
        scrollWhenReady(scrollTargetSelector); 
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded: Initializing application...");
        sectionsEl = document.querySelectorAll('#main > section'); 
        
        const loggedInUserProfile = window.CAFE_DB.profiles.find(p => p.id === MOCK_LOGGED_IN_USER_ID);
        if (loggedInUserProfile) {
            CURRENT_USER = loggedInUserProfile;
            if (!CURRENT_USER.user_roles || CURRENT_USER.user_roles.length === 0) CURRENT_USER.user_roles = ['attendee']; 
            if (!CURRENT_USER.active_role || !CURRENT_USER.user_roles.includes(CURRENT_USER.active_role)) CURRENT_USER.active_role = CURRENT_USER.user_roles[0];
        } else {
            console.error("Mock logged in user (Dr. Reed) not found! This should not happen with the new data setup.");
            // Fallback, though ideally the data structure should prevent this.
            CURRENT_USER = { id: MOCK_LOGGED_IN_USER_ID, name: "Error User", title: "", avatar: "", user_roles: ['attendee'], active_role: 'attendee', allow_multi: true, highlights: [] };
            if (!window.CAFE_DB.profiles.some(p => p.id === MOCK_LOGGED_IN_USER_ID)) window.CAFE_DB.profiles.push(CURRENT_USER);
        }
        renderSidebar(); 

        eventBus.on('pill:click', showCardByTag); 
        hydratePills(document); 

        document.addEventListener('click', e => {
          const pingBtnTarget = e.target.closest('.ping-btn');
          if (pingBtnTarget && pingBtnTarget.id !== 'item-ping-btn') {
            e.preventDefault();
            e.stopPropagation(); 

            const threadId = pingBtnTarget.dataset.threadId;
            const isEvent = pingBtnTarget.dataset.isEvent === "true";

            if (threadId) {
                console.log(`[Profile Card Ping Click] Thread: ${threadId}, Event?: ${isEvent}`);
                openPingThread(threadId, isEvent);
            } else {
                const receiverContextId = pingBtnTarget.dataset.receiverId;
                if (receiverContextId && receiverContextId !== MOCK_LOGGED_IN_USER_ID) {
                    const isEventContext = receiverContextId.startsWith('s_');
                    const derivedThreadId = isEventContext ? receiverContextId : generateThreadId(MOCK_LOGGED_IN_USER_ID, receiverContextId);
                    console.warn(`[Profile Card Ping Click] Fallback to receiverId. Thread: ${derivedThreadId}, Event?: ${isEventContext}`);
                    openPingThread(derivedThreadId, isEventContext);
                } else {
                    console.error('[Profile Card Ping Click] Critical data attributes missing on ping button:', pingBtnTarget);
                }
            }
            return;
          }

          const profileLink = e.target.closest('a.profile-link[data-profile-id]');
          if (profileLink) {
            e.preventDefault();
            showDetailPanel('profile', profileLink.dataset.profileId);
            return;
          }

          const marketItemCardTarget = e.target.closest('.market-item-card');
          if (marketItemCardTarget && !e.target.closest('.cc-pill.tag-interactive, .btn, .ping-btn, a[target="_blank"], #item-ping-btn')) {
              const itemId = marketItemCardTarget.dataset.itemId;
              const item = window.CAFE_DB.items.find(i => i.id === itemId);
              if (item) {
                  if (!item.stats) item.stats = { views: 0, likes: 0, dms: 0 };
                  item.stats.views = (item.stats.views || 0) + 1;
                  document.getElementById('items-search')?.dispatchEvent(new Event('input', { bubbles: true }));
                  console.log(`Item ${itemId} views: ${item.stats.views}`);
                  handleJump('item', itemId); 
              }
              return;
          }

          const navAnchorTarget = e.target.matches('nav a') ? e.target : e.target.closest('nav a');
          if (navAnchorTarget) {
            e.preventDefault();
            if (detailOverlayEl.classList.contains('show')) {
                detailOverlayEl.classList.remove('show');
                 if (profileTimelineObserver) { // Also clean up observer when navigating away via main nav
                    profileTimelineObserver.disconnect();
                    profileTimelineObserver = null;
                    visibleTimelineItems.clear();
                }
            }
            const targetSectionId = navAnchorTarget.dataset.target;
            showTab(targetSectionId);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
          }

          if (!e.target.closest('.btn, .mbti-btn, .endorse-btn, .ping-btn, .cc-pill, .mini-comment-form, a[target="_blank"]:not(.profile-link), .tag-interactive, .inner-tag')) {
            const profileCardShellTarget = e.target.closest('.card-shell[data-profile-id]:not(.market-item-card)');
            if (profileCardShellTarget) {
                const profileId = profileCardShellTarget.dataset.profileId;
                if (profileId) {
                    e.preventDefault();
                    showDetailPanel('profile', profileId);
                    return;
                }
            }

            const eventCardTarget = e.target.closest('.event-tree > li.card-shell[data-stage-id][data-stage-type="event"]');
            if (eventCardTarget) {
                e.preventDefault();
                const eventId = eventCardTarget.dataset.stageId;
                if (eventId) {
                    showDetailPanel('event', eventId);
                    return;
                }
            }
          }

          const backButton = e.target.closest('.back-btn');
          if (backButton) {
            e.preventDefault();
            closeDetailPanelAndReturn();
            return;
          }

          const botLinkTarget = e.target.closest('#bot-log a[data-type][data-id]');
          if (botLinkTarget) {
            e.preventDefault();
            eventBus.emit('pill:click', { type: botLinkTarget.dataset.type, id: botLinkTarget.dataset.id, tag: botLinkTarget.textContent.trim(), el: botLinkTarget });
            return;
          }

          const detailJumpTarget = e.target.closest('#detail-overlay [data-jump-type][data-jump-id]');
          if (detailJumpTarget && !detailJumpTarget.classList.contains('inner-tag') && !detailJumpTarget.classList.contains('back-btn') && !detailJumpTarget.classList.contains('tag-interactive')) {
            e.preventDefault();
            e.stopPropagation();
            handleJump(detailJumpTarget.dataset.jumpType, detailJumpTarget.dataset.jumpId);
            return;
          }

          const joinOrApplyBtn = e.target.closest(".join-btn:not(:disabled), .apply-btn:not(:disabled)"); 
          if(joinOrApplyBtn) {
              e.preventDefault();
              const stageId = joinOrApplyBtn.dataset.stageId;
              const stage = window.CAFE_DB.stages.find(s=>s.id===stageId);
              if (!stage || !CURRENT_USER) { console.error("Stage or current user not found for action."); return; }
              const currentActiveRole = getCurrentActiveRole();
              if (stage.type === 'event') {
                let bucketKey;
                switch(currentActiveRole) {
                    case 'vendor':    bucketKey = 'vendors'; break;
                    case 'host':      bucketKey = 'hosts'; break;
                    case 'organizer': bucketKey = 'organizers'; break;
                    case 'recruiter': bucketKey = 'recruiters'; break; 
                    case 'candidate': case 'attendee': default: bucketKey = 'attendees'; break;
                }
                if (!stage.slots[bucketKey]) stage.slots[bucketKey] = [];
                if (!stage.slots[bucketKey].includes(CURRENT_USER.id)) {
                    stage.slots[bucketKey].push(CURRENT_USER.id);
                    if (detailOverlayEl.classList.contains('show') && detailOverlayEl.querySelector(`#detail-event-join-btn[data-stage-id="${stage.id}"]`)) {
                        const currentDetailContent = detailOverlayEl.querySelector('#detail-event-content');
                        if (currentDetailContent) { 
                            populateTemplate(detailOverlayEl, 'event', stage.id); 
                        }
                    } else { 
                        renderEvents(); 
                    }
                }
              } else if (stage.type === 'job') { 
                if (userHasRole('candidate')) { 
                    if (!stage.job_applications) stage.job_applications = [];
                    const alreadyApplied = stage.job_applications.some(app => app.candidate_id === CURRENT_USER.id);
                    if (!alreadyApplied) {
                        stage.job_applications.push({
                            job_id: stage.id, candidate_id: CURRENT_USER.id, status: "applied",
                            message: "I'm interested in this job!", created_at: new Date().toISOString()
                        });
                        renderJobApp(); alert('Application submitted!');
                    }
                } else { alert("Only users with the 'Candidate' role can apply for jobs."); }
              }
              return;
          }
    
          const heart = e.target.closest('.endorse-btn');
          if (heart){
             e.preventDefault(); 
             const targetId = heart.dataset.targetId; 
             const ctxId = heart.dataset.ctxId || targetId; 
             const existingEndorsementIndex = window.CAFE_DB.endorsements.findIndex(
                 endo => endo.targetId === targetId && endo.actorId === MOCK_LOGGED_IN_USER_ID && endo.type === '‚ô•' && endo.ctxId === ctxId
             );
             if (existingEndorsementIndex > -1) { 
                 window.CAFE_DB.endorsements.splice(existingEndorsementIndex, 1);
                 heart.classList.remove('active');
             } else { 
                 window.CAFE_DB.endorsements.push({ targetId: targetId, actorId: CURRENT_USER.id, type:'‚ô•', ctxId: ctxId });
                 heart.classList.add('active');
             }
             return;
          }
    
          if(e.target.closest('.mbti-btn')) {
                const btn = e.target.closest('.mbti-btn');
                const profileCard = btn.closest('[data-profile-id]');
                const detailPanel = btn.closest('#detail-overlay');
                let profileIdForMbti;

                if (profileCard) profileIdForMbti = profileCard.dataset.profileId;
                else if (detailPanel) {
                   const isProfileDetailTemplate = detailPanel.querySelector('#detail-profile-content-columns') !== null;
                   if (isProfileDetailTemplate) {
                       profileIdForMbti = MOCK_LOGGED_IN_USER_ID;
                   }
                }
                
                if (profileIdForMbti === MOCK_LOGGED_IN_USER_ID) {
                    e.stopPropagation(); 
                    const type = prompt('Enter your MBTI (e.g., ENFP):');
                    if(!type || type.trim() === "") return;
                    const drink = mbtiMap[type.trim().toUpperCase()] || 'House Blend';
                    const badge = btn.nextElementSibling;
                    if (badge && badge.classList.contains('mbti-badge')) {
                        badge.textContent = `${type.trim().toUpperCase()} ‚Üí ${drink}`;
                        badge.style.display='inline-block'; 
                        if (typeof feather !== 'undefined') feather.replace(); 
                    }
                }
                return;
            }
    
            const tagEl = e.target.closest('.clickable-filter-tag');
            if (tagEl && !tagEl.classList.contains('tag-interactive')) { 
                e.preventDefault(); e.stopPropagation(); 
                const tag = tagEl.dataset.filterTag;
                const currentActiveTab = document.querySelector('nav a.active')?.dataset.target;
                if (currentActiveTab === 'events') {
                    const quickEvents = document.querySelector('#events .quick-search');
                    if (quickEvents) { quickEvents.value = tag; quickEvents.dispatchEvent(new Event('input', { bubbles: true })); }
                } else if (currentActiveTab === 'items') {
                    const quickItems = document.querySelector('#items #items-search');
                     if (quickItems) { quickItems.value = tag; quickItems.dispatchEvent(new Event('input', { bubbles: true })); }
                } else if (currentActiveTab === 'jobs') {
                    const quickJobs = document.querySelector('#jobs #jobs-quick-search');
                    if (quickJobs) { quickJobs.value = tag; quickJobs.dispatchEvent(new Event('input', { bubbles: true })); }
                } else { 
                    showTab('events');
                    const quickEvents = document.querySelector('#events .quick-search');
                    if (quickEvents) { quickEvents.value = tag; quickEvents.dispatchEvent(new Event('input', { bubbles: true })); }
                }
                return;
            }
    
            const threadRow = e.target.closest('.thread-row');
            if(threadRow){
                openPingThread(threadRow.dataset.threadId, threadRow.dataset.threadId.startsWith('s_'));
                return;
            }
        });

        const originalRenderFunctions = [
            'renderEvents', 'renderJobApp', 'renderBrowseItems',
            'renderMyListingsOnly', 'renderCandidateDeck', 'renderProfileCard',
            'renderEventCard', 'renderJobCard', 'renderMarketItemCard', 'renderSocial',
            'populateTemplate' 
        ];

        originalRenderFunctions.forEach(fnName => {
            const originalFn = window[fnName];
            if (typeof originalFn === 'function') {
                window[fnName] = function(...args) {
                    const result = originalFn.apply(this, args);
                    requestAnimationFrame(() => {
                        let hydrationRoot = document.getElementById('main');
                        if (detailOverlayEl.classList.contains('show')) {
                            hydrationRoot = detailOverlayEl;
                        } else if (pingThreadModalEl.classList.contains('show')) {
                            hydrationRoot = pingThreadModalEl;
                        }
                        hydratePills(hydrationRoot);
                        hydratePills(document.getElementById('sidebar')); 
                    });
                    return result;
                };
            } else {
                console.warn(`Render function ${fnName} not found on window for pill hydration wrapping.`);
            }
        });

        initializeBotFuse(); 
        wireQuickSearch('events',
          ()=>window.CAFE_DB.stages.filter(s=>s.type==='event').map(ev=>({ raw:ev, text:`${ev.title} ${ev.description} ${(ev.tags||[]).join(' ')}` })),
          renderEvents);
        wireQuickSearch('items',
          ()=>window.CAFE_DB.items.map(i=>({ raw:i, text:`${i.title} ${i.description} ${(i.tags || []).join(' ')}` })),
          (hits) => { 
            const activeView = document.querySelector('#items .items-nav button.active')?.dataset.view;
            if (activeView === 'browse') renderBrowseItems(hits);
            else if (activeView === 'my') renderMyListingsOnly(hits); 
            else renderBrowseItems(hits);
          });
        wireQuickSearch('jobs', 
          ()=>window.CAFE_DB.stages.filter(s=>s.type==='job').map(j=>({ raw:j, text:`${j.title} ${j.description} ${(j.skills||[]).join(' ')}` })), 
          (jobHits) => {
            renderJobApp(jobHits);
            const jobSearchInput = document.getElementById('jobs-quick-search');
            const jobKeywords = simpleEmbed(jobSearchInput?.value || ''); 
            renderCandidateDeck(jobKeywords);
          });
        const itemsNavButtons = document.querySelectorAll('#items .items-nav button');
        itemsNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                itemsNavButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const view = button.dataset.view;
                document.getElementById('items-container').style.display = view === 'browse' ? 'flex' : 'none';
                document.getElementById('my-items-container').style.display = view === 'my' ? 'flex' : 'none';
                document.getElementById('items-search')?.dispatchEvent(new Event('input', { bubbles: true }));
            });
        });
        document.getElementById('items-category')?.addEventListener('change', () => document.getElementById('items-search')?.dispatchEvent(new Event('input', { bubbles: true })));
        document.getElementById('items-sort')?.addEventListener('change', () => document.getElementById('items-search')?.dispatchEvent(new Event('input', { bubbles: true })));
        const candidateDeckSearchBtn = document.getElementById('candidate-deck-search-btn');
        const candidateDeckSearchInput = document.getElementById('candidate-deck-search-input');
        if (candidateDeckSearchBtn && candidateDeckSearchInput) {
            candidateDeckSearchBtn.addEventListener('click', () => {
                const keywords = simpleEmbed(candidateDeckSearchInput.value);
                renderCandidateDeck(keywords);
            });
            candidateDeckSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') candidateDeckSearchBtn.click(); });
        }
        
        if(CAFE_DB.companies?.length){
           buildCompanySidebar();
           renderCompanyGrid();
        }

        const initialTab = 'social'; // Start on social tab to see Dr. Reed's card
        showTab(initialTab); 
        lastActiveTabId = initialTab; 
        lastScrollPosition = 0;


        if(resetButtonEl) resetButtonEl.addEventListener('click', resetDefaultView);
        updateUnreadPingBadge(); 
        const roleSwitcherEl = document.getElementById('role-switcher');
        if (roleSwitcherEl) {
            roleSwitcherEl.addEventListener('click', e => {
                const label = e.target.closest('label');
                if (!label) return;
                const checkbox = label.querySelector('input[type="checkbox"]');
                if (!checkbox && !(e.target.matches('span[data-role-span]'))) return;
                const roleToChange = checkbox ? checkbox.dataset.role : e.target.dataset.roleSpan;
                if (!roleToChange) return;
                const isCurrentlyChecked = CURRENT_USER.user_roles.includes(roleToChange);
                const isCurrentlyActive = CURRENT_USER.active_role === roleToChange;
                if (e.target.type === 'checkbox' && e.target.checked || (e.target.matches('span[data-role-span]') && !isCurrentlyChecked)) {
                    if (!CURRENT_USER.user_roles.includes(roleToChange)) CURRENT_USER.user_roles.push(roleToChange);
                    CURRENT_USER.active_role = roleToChange; 
                } else if (e.target.type === 'checkbox' && !e.target.checked) {
                    if (CURRENT_USER.user_roles.length === 1 && isCurrentlyChecked) {
                        alert("You need at least one role. Add another hat first.");
                        checkbox.checked = true; return;
                    }
                    CURRENT_USER.user_roles = CURRENT_USER.user_roles.filter(r => r !== roleToChange);
                    if (isCurrentlyActive) CURRENT_USER.active_role = CURRENT_USER.user_roles.length > 0 ? CURRENT_USER.user_roles[0] : null;
                } else if (e.target.matches('span[data-role-span]') && isCurrentlyChecked && !isCurrentlyActive) {
                     CURRENT_USER.active_role = roleToChange;
                }
                dispatchRoleChangeEvent(CURRENT_USER.active_role);
                renderSidebar();
                renderAllCurrentTab(); 
            });
        }
        document.querySelectorAll('input[name="multi"]').forEach(radio => {
            radio.addEventListener('change', e => {
                if (e.target.checked && CURRENT_USER) {
                    CURRENT_USER.allow_multi = e.target.value === 'all';
                    renderSidebar(); renderAllCurrentTab();     
                }
            });
        });
        document.addEventListener('keydown', e => {
            if (e.key.toLowerCase() === 'r' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName.toUpperCase()) && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                if (CURRENT_USER && CURRENT_USER.user_roles && CURRENT_USER.user_roles.length > 0) {
                    const currentIdx = CURRENT_USER.user_roles.indexOf(CURRENT_USER.active_role);
                    let nextIdx = (currentIdx + 1) % CURRENT_USER.user_roles.length;
                    if (currentIdx === -1 && CURRENT_USER.user_roles.length > 0) nextIdx = 0;
                    CURRENT_USER.active_role = CURRENT_USER.user_roles[nextIdx];
                    dispatchRoleChangeEvent(CURRENT_USER.active_role);
                    renderSidebar(); renderAllCurrentTab();
                }
            }
        });
        setInterval(() => { 
            updateUnreadPingBadge();
            if (pingThreadModalEl.classList.contains('show')) {
                const currentThreadId = sendPingFormEl.ping_thread_id_form_input.value;
                if (currentThreadId) {
                    const messagesInDbForThread = window.CAFE_DB.messages.filter(msg => msg.thread_id === currentThreadId);
                    const messagesInDomCount = pingMessagesContainerEl.querySelectorAll('.ping-message:not(.zero)').length;
                    if (messagesInDbForThread.length !== messagesInDomCount) {
                         const headerText = pingThreadHeaderEl.textContent;
                         const isEvent = currentThreadId.startsWith('s_'); 
                         renderMessagesInModal(currentThreadId, headerText, isEvent);
                    }
                }
            }
        }, 5000); 
        if (fabNewListingEl) {
            fabNewListingEl.onclick = () => {
                const newItemFormSummary = document.querySelector('#items #new-item-form-container summary');
                if (newItemFormSummary) {
                    const detailsEl = newItemFormSummary.closest('details');
                    if(detailsEl && !detailsEl.open) newItemFormSummary.click(); 
                    else if (detailsEl) detailsEl.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            };
            toggleFab();
        }

        if (detailOverlayEl) {
            detailOverlayEl.addEventListener('click', ev => {
                if (ev.target === detailOverlayEl) {
                    closeDetailPanelAndReturn();
                }
            });
        }

        document.addEventListener('keydown', ev => {
            if (ev.key === 'Escape') {
                if (detailOverlayEl.classList.contains('show')) {
                    closeDetailPanelAndReturn();
                } else if (pingThreadModalEl.classList.contains('show')) {
                    pingThreadModalEl.classList.remove('show');
                    pingThreadModalEl.style.display = 'none';
                }
            }
        });

        console.log("DOMContentLoaded: Initialization complete.");
    });

    document.getElementById("new-profile-candidate-form")?.addEventListener("submit", async e => {
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target));
        const pitchFileEl = document.getElementById('pitch-file-candidate'); const pitchBlob = pitchFileEl ? pitchFileEl.file : null;
        const newProfile = {
            id: "p_" + crypto.randomUUID().slice(0,6), kind: "candidate", user_roles: ["candidate"], active_role: "candidate", allow_multi: true,
            name: f.name, avatar: f.avatar || 'https://via.placeholder.com/80/ccc/000?text=??', title: f.title,
            highlights: f.highlights.split(",").map(s=>s.trim()).filter(Boolean), bio: f.bio, location: f.location, interests: []
        };
        if (pitchBlob) {
            const meta = await extractMetaFromFile(pitchBlob); Object.assign(newProfile, meta);
            window.CAFE_DB.uploads.push({ profileId: newProfile.id, type: 'candidate_pitch', blob: pitchBlob, filename: meta.title || (pitchBlob.name ? pitchBlob.name.replace(/\.\w+$/,'') : `candidate_pitch_${newProfile.id}.webm`) });
            if (meta.coverImage && !newProfile.avatar) newProfile.avatar = meta.coverImage;
        }
        window.CAFE_DB.profiles.push(newProfile); e.target.reset();
        if(pitchFileEl) pitchFileEl.file = null; const previewEl = document.getElementById('pitch-preview-candidate');
        if(previewEl) { previewEl.style.display='none'; previewEl.src='';}
        e.target.closest('details').open = false; renderCandidateDeck();
        window.dispatchEvent(new CustomEvent('dataChangedForQuickSearch', { detail: { scope: 'profiles' } })); // Assuming 'profiles' is a scope for candidates
        initializeBotFuse(); alert('New Candidate Profile Created!');
    });

    document.getElementById("new-event-form")?.addEventListener("submit", async e => {
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target));
        const pitchFileEl = document.getElementById('pitch-file-event'); const pitchBlob = pitchFileEl ? pitchFileEl.file : null;
        const newEvent = {
            id: "s_event_" + crypto.randomUUID().slice(0,6), type: "event", title: f.title, date: f.date, time: f.time,
            locationName: f.locationName, address: f.address, description: f.description, coverImage: f.coverImage, websiteUrl: f.websiteUrl,
            tags: f.tags.split(",").map(s=>s.trim()).filter(Boolean),
            slots: { vendors:[], candidates:[], hosts:[], organizers:[], attendees: [], recruiters: [] }
        };
        if (pitchBlob) {
            const meta = await extractMetaFromFile(pitchBlob); Object.assign(newEvent, meta);
            window.CAFE_DB.uploads.push({ eventId: newEvent.id, type: 'event_promo', blob: pitchBlob, filename: meta.title || (pitchBlob.name ? pitchBlob.name.replace(/\.\w+$/,'') : `event_promo_${newEvent.id}.webm`) });
        }
        window.CAFE_DB.stages.push(newEvent); e.target.reset();
        if(pitchFileEl) pitchFileEl.file = null; const previewEl = document.getElementById('pitch-preview-event');
        if(previewEl) { previewEl.style.display='none'; previewEl.src='';}
        e.target.closest('details').open = false; renderEvents();
        window.dispatchEvent(new CustomEvent('dataChangedForQuickSearch', { detail: { scope: 'events' } }));
        initializeBotFuse(); alert('New Event Created!');
    });

    document.getElementById("new-job-form")?.addEventListener("submit", async e => {
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target));
        const pitchFileEl = document.getElementById('pitch-file-job'); const pitchBlob = pitchFileEl ? pitchFileEl.file : null;
        if (CURRENT_USER && userHasRole('recruiter')) {
            const newJob = {
                id: "job_" + crypto.randomUUID().slice(0,6), type: "job", title: f.title, posted_by: CURRENT_USER.id,
                description: f.description, skills: f.skills.split(",").map(s=>s.trim()).filter(Boolean), status: f.status,
                created_at: new Date().toISOString(), job_applications: []
            };
            if (pitchBlob) {
                const meta = await extractMetaFromFile(pitchBlob); Object.assign(newJob, meta);
                window.CAFE_DB.uploads.push({ jobId: newJob.id, type: 'job_pitch', blob: pitchBlob, filename: meta.title || (pitchBlob.name ? pitchBlob.name.replace(/\.\w+$/,'') : `job_pitch_${newJob.id}.webm`) });
            }
            window.CAFE_DB.stages.push(newJob); e.target.reset();
            if(pitchFileEl) pitchFileEl.file = null; const previewEl = document.getElementById('pitch-preview-job');
            if(previewEl) { previewEl.style.display='none'; previewEl.src='';}
            e.target.closest('details').open = false; renderJobApp();
            window.dispatchEvent(new CustomEvent('dataChangedForQuickSearch', { detail: { scope: 'jobs' } }));
            initializeBotFuse(); alert('Nice! Your job is live ‚Äì candidates can now apply.');
        } else { alert("Error: You must have the 'Recruiter' role to post a job."); }
    });

    document.getElementById("new-item-form")?.addEventListener("submit", async e => {
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target));
        const pitchFileEl = document.getElementById('pitch-file-item'); const pitchBlob = pitchFileEl ? pitchFileEl.file : null;
        if (CURRENT_USER && userHasRole('vendor')) {
            const newItem = {
                id: "item_" + crypto.randomUUID().slice(0,6), vendor_id: CURRENT_USER.id, title: f.title,
                price: parseFloat(f.price), currency: f.currency, img_url: f.img_url, description: f.description,
                tags: f.tags.split(",").map(s=>s.trim()).filter(Boolean), venmo: f.venmo === 'on', paypal: f.paypal === 'on',
                external_url: f.external_url, created_at: new Date().toISOString(), stats: { views: 0, likes: 0, dms: 0 }
            };
            if (pitchBlob) {
                const meta = await extractMetaFromFile(pitchBlob); Object.assign(newItem, meta);
                if (meta.coverImage && !newItem.img_url) newItem.img_url = meta.coverImage;
                window.CAFE_DB.uploads.push({ itemId: newItem.id, type: 'item_video', blob: pitchBlob, filename: meta.title || (pitchBlob.name ? pitchBlob.name.replace(/\.\w+$/,'') : `item_video_${newItem.id}.webm`) });
            }
            window.CAFE_DB.items.push(newItem); e.target.reset();
            if(pitchFileEl) pitchFileEl.file = null; const previewEl = document.getElementById('pitch-preview-item');
            if(previewEl) { previewEl.style.display='none'; previewEl.src='';}
            e.target.closest('details').open = false;
            const activeItemsViewButton = document.querySelector('#items .items-nav button.active');
            if (activeItemsViewButton) activeItemsViewButton.click(); else renderBrowseItems(window.CAFE_DB.items);
            populateItemCategoryFilter();
            window.dispatchEvent(new CustomEvent('dataChangedForQuickSearch', { detail: { scope: 'items' } }));
            initializeBotFuse(); alert('Item listed successfully!');
        } else { alert("Error: You must have the 'Vendor' role to list items."); }
    });

    document.addEventListener('submit', e=>{
      if(e.target.matches('.mini-comment-form')){
         e.preventDefault();
         const ctxId = e.target.dataset.ctxId;
         const text  = e.target.comment.value.trim().slice(0,120);
         if (text && CURRENT_USER) {
             window.CAFE_DB.mentions.push({ ctxId, text, actorId: CURRENT_USER.id, timestamp: new Date().toISOString() });
             console.log("Mentions:", window.CAFE_DB.mentions);
             e.target.reset();
         }
      }
    });

    document.getElementById('bot-form').onsubmit = e=>{
      e.preventDefault();
      const logEl =document.getElementById('bot-log');
      const q = e.target.q.value.trim(); if(!q) return;
      logEl.innerHTML += `<div><b>you:</b> ${q}</div>`;
      logEl.innerHTML += `<div>ü§ñ: ${botAnswer(q)}</div>`; 
      e.target.q.value = ''; 
      logEl.scrollTop = logEl.scrollHeight;
      hydratePills(logEl); 
    };

    const mbtiMap={ INTJ:'Espresso', ENTJ:'Black Coffee', INTP:'Americano', ENTP:'Nitro Cold Brew', INFJ:'Mocha', ENFJ:'Caramel Macchiato', INFP:'Chai Latte', ENFP:'Vanilla Latte', ISTJ:'Drip Coffee', ESTJ:'Double Espresso', ISFJ:'Latte', ESFJ:'Cappuccino', ISTP:'Cold Brew', ESTP:'Espresso con Panna', ISFP:'Affogato', ESFP:'Frappuccino' };

    document.querySelectorAll('.record-btn-dynamic').forEach(recordButton => {
      let mediaStream, recorder, chunks = [];
      recordButton.onclick = async () => {
        const formType = recordButton.dataset.formType;
        const pitchPreviewEl = document.getElementById(`pitch-preview-${formType}`);
        const fileInputTarget = document.getElementById(`pitch-file-${formType}`);
        const currentRecordButton = recordButton;
        const activeRecorderKey = `recorder_${formType}`;
        if (currentRecordButton.dataset.recordingState === 'recording') {
            if (window[activeRecorderKey]) window[activeRecorderKey].stop();
            return;
        }
        const anyOtherRecording = Array.from(document.querySelectorAll('.record-btn-dynamic')).some(
            btn => btn !== currentRecordButton && btn.dataset.recordingState === 'recording'
        );
        if (anyOtherRecording) { alert("Another recording is in progress. Please stop it first."); return; }
        if (fileInputTarget && !fileInputTarget.dataset.listenerAttached) {
            fileInputTarget.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileInputTarget.file = file;
                     if (file.type.startsWith('video/')) {
                        pitchPreviewEl.src = URL.createObjectURL(file); pitchPreviewEl.style.display = 'block';
                        pitchPreviewEl.onloadedmetadata = () => URL.revokeObjectURL(pitchPreviewEl.src);
                    } else if (file.type.startsWith('image/')) {
                        pitchPreviewEl.src = URL.createObjectURL(file); pitchPreviewEl.poster = URL.createObjectURL(file);
                        pitchPreviewEl.style.display = 'block';
                    } else pitchPreviewEl.style.display = 'none';
                }
            };
             fileInputTarget.dataset.listenerAttached = 'true';
        }
        const labelSpan = currentRecordButton.closest('label').querySelector('span');
        if (labelSpan && !labelSpan.dataset.listenerAttachedToSpan) {
            labelSpan.style.cursor = 'pointer'; labelSpan.onclick = () => fileInputTarget.click();
            labelSpan.dataset.listenerAttachedToSpan = 'true';
        }
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            recorder = new MediaRecorder(mediaStream);
            window[activeRecorderKey] = recorder; chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' }); chunks = [];
                const url = URL.createObjectURL(blob);
                if (pitchPreviewEl) {
                    pitchPreviewEl.src = url; pitchPreviewEl.style.display = 'block';
                    pitchPreviewEl.onloadedmetadata = () => URL.revokeObjectURL(pitchPreviewEl.src);
                }
                if (fileInputTarget) fileInputTarget.file = blob;
                mediaStream.getTracks().forEach(t => t.stop());
                currentRecordButton.textContent = 'Record 30 s';
                currentRecordButton.dataset.recordingState = 'idle';
                delete window[activeRecorderKey];
            };
            recorder.start(); currentRecordButton.textContent = '‚èπ Stop'; currentRecordButton.dataset.recordingState = 'recording';
            setTimeout(() => { if (window[activeRecorderKey] && window[activeRecorderKey].state === 'recording') window[activeRecorderKey].stop(); }, 30000);
        } catch (err) {
            console.error("Error accessing media devices for form " + formType, err);
            alert("Could not access camera/microphone. Please check permissions.");
            currentRecordButton.textContent = 'Record 30 s'; currentRecordButton.dataset.recordingState = 'idle';
            if (window[activeRecorderKey]) delete window[activeRecorderKey];
        }
      };
    });
  </script>

<!-- NEW: Company Graph Extension Comment (from Ch 6.1) -->
<!--
================  üîó  COMPANY GRAPH EXTENSION  =================
(see docs/feature2_graph.md for prettier view)
1. Schema ‚Ä¶
2. JSON keys ‚Ä¶
3. Streamlit hooks ‚Ä¶
4. Cypher upsert ‚Ä¶
5. Open questions ‚Ä¶
-->

</body>
</html>