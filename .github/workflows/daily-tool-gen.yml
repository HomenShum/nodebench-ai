name: Daily MCP Tool Generation

on:
  schedule:
    # 3:00 AM UTC daily
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_signal:
        description: 'Manual signal override (skip Convex brief, use this text as the signal)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-tool:
    name: Analyze signals → generate MCP tool → PR
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install MCP dependencies
        working-directory: packages/mcp-local
        run: npm install --ignore-scripts

      - name: Fetch daily brief
        id: fetch_brief
        env:
          CONVEX_SITE_URL: ${{ secrets.CONVEX_SITE_URL }}
          MCP_SECRET: ${{ secrets.MCP_SECRET }}
          FORCE_SIGNAL: ${{ inputs.force_signal }}
        run: node scripts/tool-gen/fetch-brief.mjs

      - name: Analyze signals for tool gap
        id: analyze
        if: steps.fetch_brief.outputs.has_signals == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BRIEF_JSON: ${{ steps.fetch_brief.outputs.brief_path }}
        run: node scripts/tool-gen/analyze-gap.mjs

      - name: Generate tool code
        id: generate
        if: steps.analyze.outputs.should_generate == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GAP_SPEC: ${{ steps.analyze.outputs.gap_spec_path }}
        run: node scripts/tool-gen/generate-tool.mjs

      - name: Patch source files
        if: steps.generate.outputs.tool_generated == 'true'
        env:
          TOOL_MANIFEST: ${{ steps.generate.outputs.manifest_path }}
        run: node scripts/tool-gen/patch-files.mjs

      - name: TypeScript check
        id: typecheck
        if: steps.generate.outputs.tool_generated == 'true'
        working-directory: packages/mcp-local
        run: |
          npx tsc --noEmit 2>&1 | tee /tmp/tsc-output.txt
          exit ${PIPESTATUS[0]}

      - name: Run tests
        id: test
        if: steps.typecheck.outcome == 'success'
        working-directory: packages/mcp-local
        run: |
          npx vitest run src/__tests__/tools.test.ts 2>&1 | tee /tmp/vitest-output.txt
          exit ${PIPESTATUS[0]}

      - name: Create pull request
        if: steps.test.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOOL_NAME="${{ steps.generate.outputs.tool_name }}"
          TOOL_DOMAIN="${{ steps.generate.outputs.tool_domain }}"
          BRANCH="auto/tool-gen-$(date +%Y%m%d)-${TOOL_NAME}"
          DATE=$(date +%Y-%m-%d)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add packages/mcp-local/src/
          git commit -m "$(cat <<EOF
          feat(mcp): add ${TOOL_NAME} tool [auto-generated]

          Domain: ${TOOL_DOMAIN}
          Source: Daily brief signal analysis (${DATE})
          Generated-By: daily-tool-gen workflow
          EOF
          )"
          git push origin "$BRANCH"

          SUMMARY=$(cat /tmp/gap-analysis-summary.txt 2>/dev/null || echo "See workflow logs")

          gh pr create \
            --title "feat(mcp): add \`${TOOL_NAME}\` tool [auto-generated]" \
            --body "$(cat <<'PREOF'
          ## Auto-Generated MCP Tool

          **Tool:** \`${TOOL_NAME}\`
          **Domain:** \`${TOOL_DOMAIN}\`
          **Source:** Daily brief signal analysis

          ### Signal Analysis
          ${SUMMARY}

          ### Verification
          - [x] TypeScript compilation passes (`tsc --noEmit`)
          - [x] All vitest tests pass (tools.test.ts)
          - [ ] Human review required

          ### Test Plan
          - Review the generated tool schema and handler logic
          - Verify the tool follows existing patterns
          - Run `npx vitest run src/__tests__/tools.test.ts` locally
          - Test via stdio: `echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"${TOOL_NAME}","arguments":{}}}' | node dist/index.js`

          ---
          *Generated by [daily-tool-gen](.github/workflows/daily-tool-gen.yml) workflow*
          PREOF
          )"

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: tool-gen-failure-${{ github.run_id }}
          path: |
            /tmp/tsc-output.txt
            /tmp/vitest-output.txt
            /tmp/gap-analysis-summary.txt
            /tmp/generated-tool.ts
            /tmp/gap-spec.json
            /tmp/tool-manifest.json
          retention-days: 7
          if-no-files-found: ignore
